{% extends 'index.html' %}
{% block title %}Equipe{% endblock %}
{% block extra_css %}
    <style>
        .content-area { padding: 30px; }
        .page-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:30px; }
        .page-title { font-size: 1.8rem; font-weight: 600; color:#333; }
        .new-member-btn { background: linear-gradient(90deg, #333, #555); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:500; transition: all .2s ease; }
        .new-member-btn:hover { transform: translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,.3); }
        .kpi-section { display:flex; justify-content: space-between; gap:20px; margin-bottom:30px; }
        .kpi-card { padding:25px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); border:1px solid #f0f0f0; text-align:left; flex:1; color:#333; transition:all .3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow:0 8px 30px rgba(0,0,0,0.12); }
        .kpi-section .kpi-card:nth-child(1){ background: linear-gradient(135deg, #E8F5E8, #F1F8E9); }
        .kpi-section .kpi-card:nth-child(2){ background: linear-gradient(135deg, #E3F2FD, #E1F5FE); }
        .kpi-section .kpi-card:nth-child(3){ background: linear-gradient(135deg, #F3E5F5, #FCE4EC); }
        .kpi-section .kpi-card:nth-child(4){ background: linear-gradient(135deg, #FFF3E0, #FFF8E1); }
        .kpi-card h3 { color:#666; font-size:0.9rem; margin-bottom:15px; font-weight:500; text-transform: uppercase; letter-spacing:.5px; }
        .kpi-card .value { font-size:1.5rem; font-weight:700; color:#333; margin-bottom:15px; line-height:1.2; }
        .kpi-trend { font-size:0.8rem; font-weight:500; margin-top:5px; }
        .trend-up { color:#4CAF50; }
        .trend-up::before { content:"▲"; margin-right:3px; }
        .trend-down { color:#F44336; }
        .trend-down::before { content:"▼"; margin-right:3px; }
        .kpi-subtitle { font-size:0.7rem; color:#666; margin-top:3px; }

        .chart-card { background:#fff; padding:25px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); min-height: 420px; }
        .chart-header { margin-bottom: 12px; }
        .chart-header h3 { font-size:1.2rem; font-weight:600; color:#333; }
        /* dedicated comparatif card without fixed min-height */
        .comparatif-card { min-height: auto; }

        .table-section { background:#fff; padding:25px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-top:30px; }
        .table-controls { display:flex; justify-content: space-between; align-items:center; margin-bottom:20px; }
        .search-filters { display:flex; gap:15px; align-items:center; }
        .search-filters input, .search-filters select { padding: 8px 12px; border:1px solid #ddd; border-radius:5px; font-size:0.9rem; transition:all .2s ease; }
        .search-filters input:hover, .search-filters select:hover { border-color:#333; }
        .search-filters input:focus, .search-filters select:focus { border-color:#333; outline:none; box-shadow:0 0 0 3px rgba(0,0,0,.08); }
        .staff-table { width:100%; border-collapse: collapse; }
        .staff-table th, .staff-table td { padding:12px; text-align:left; border-bottom:1px solid #e0e0e0; vertical-align:middle; }
        .staff-table th { background:#f8f9fa; font-weight:500; color:#333; }
        .staff-table tbody tr { position:relative; transition: background-color .2s ease; cursor:pointer; }
        .staff-table tbody tr:hover { background:#f8f9fa; }
        .pagination { display:flex; justify-content:center; align-items:center; gap:5px; margin-top:20px; flex-wrap:wrap; }
        .pagination button { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:5px; cursor:pointer; font-size:.9rem; min-width:40px; height:40px; display:flex; align-items:center; justify-content:center; transition: all .3s ease; }
        .pagination button:hover:not(.disabled) { background: linear-gradient(90deg, #333, #555); color:#fff; transform: translateY(-2px); }
        .pagination button.active { background: linear-gradient(90deg, #333, #555); color:#fff; border-color:#333; }
        .pagination button.disabled { opacity:.5; cursor:not-allowed; background:#f5f5f5; color:#999; }
        .pagination .nav-btn { padding:8px 16px; min-width:auto; font-weight:500; }
        .pagination .ellipsis { background:none; border:none; cursor:default; padding:8px 4px; }
        .bar { height: 18px; border-radius: 4px; background: #e9ecef; position: relative; overflow: hidden; }
        .bar > span { position:absolute; top:0; left:0; height:100%; background:#8e7dff; }
        .mini { font-size: .85rem; color:#666; }
        .green { color:#2e7d32; }
        .red { color:#c62828; }
        .table-section-title { font-size: 1.2rem; font-weight:600; color:#333; }
        .export-btn { background:#e0e0e0; color:#333; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:500; }
        .export-btn:hover { background:#d5d5d5; }
        .search-filters select { padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:.9rem; }
        .clients-table tbody tr::after, .staff-table tbody tr::after { content:"⋮"; position:absolute; right:15px; top:50%; transform:translateY(-50%); font-size:18px; color:#333; opacity:0; transition:opacity .2s; }
        .staff-table tbody tr:hover::after { opacity:1; }
        /* Disable action dots and pointer for comparatif table */
        #comparatifContainer .staff-table tbody tr { cursor:default; }
        #comparatifContainer .staff-table tbody tr::after { content:none; }

        /* Full-page form styles and icons */
        .form-header { margin-bottom:30px; }
        .form-title { font-size:1.5rem; font-weight:600; color:#333; margin-bottom:5px; }
        .form-subtitle { color:#666; font-size:.9rem; margin-bottom:20px; }
        .required-asterisk { color:#c62828; }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; font-weight:500; margin-bottom:8px; color:#333; }
        .form-row-full { display:flex; margin-bottom:20px; }
        .form-row-full .form-group { flex:0 0 calc(50% - 10px); max-width:calc(50% - 10px); }
        .form-row-dual { display:flex; gap:20px; margin-bottom:20px; }
        .form-row-dual .form-group { flex:1; max-width:calc(50% - 10px); }
        .form-row-triple { display:flex; gap:20px; margin-bottom:20px; }
        .form-row-triple .form-group { flex:1; max-width:calc(33.333% - 14px); }
        .form-group input, .form-group select { width:100%; padding:12px 12px 12px 40px; border:1px solid #ddd; border-radius:5px; font-size:.95rem; background-position:10px center; background-repeat:no-repeat; background-size:20px; box-sizing:border-box; height:44px; transition:all .2s ease; }
        .form-group input:hover, .form-group select:hover { border-color:#333; }
        .form-group input:focus, .form-group select:focus { border-color:#333; outline:none; box-shadow:0 0 0 3px rgba(0,0,0,0.08); }
        #m_nom { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'); }
        /* no icon on phone field to match repertoire style */
        #m_adresse { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>'); }
        #m_ville { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15 11V5l-3-3-3 3v2H3v14h18V11h-6zm-8 8H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm6 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm6 12h-2v-2h2v2zm0-4h-2v-2h2v2z"/></svg>'); }
        #m_pays { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>'); }
        #m_role { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-7 9a7 7 0 0114 0H5z"/></svg>'); }
        #m_fonction { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14 6V4H6v2h8zm0 2H6v10h12V8h-4zm-2 7H8v-2h4v2z"/></svg>'); }
        #m_email { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 13L2 6.76V18a2 2 0 002 2h16a2 2 0 002-2V6.76L12 13zM22 6l-10 6L2 6V4l10 6 10-6v2z"/></svg>'); }
        #m_pwd { background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 17a2 2 0 100-4 2 2 0 000 4zm6-7h-1V7a5 5 0 10-10 0v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2zm-7-3a3 3 0 016 0v3H11V7z"/></svg>'); }
        .modal-icon .svg-icon { fill:#fff; }
        .svg-icon { width:18px; height:18px; }
        .form-actions { display:flex; gap:15px; justify-content:flex-end; margin-top:30px; }
        .btn-save { background:linear-gradient(90deg, #333, #555); color:#fff; border:none; padding:12px 24px; border-radius:5px; cursor:pointer; font-weight:500; transition: all .2s ease; }
        .btn-save:hover { transform: translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,.3); }
        .btn-cancel { background:#e0e0e0; color:#333; border:1px solid #ccc; padding:12px 24px; border-radius:5px; cursor:pointer; font-weight:500; }
        #m_date_entree { 
            background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 002 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>'); 
        }
        #m_date_sortie { 
            background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 002 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>'); 
        }

        /* Modal unified */
        .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1050; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-content { background:#fff; padding:40px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,.3); width:700px; max-width:95%; text-align:center; position:relative; }
        .modal-close { position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#666; }
        .modal-close:hover { color:#000; }
        .modal-icon { width:60px; height:60px; background:linear-gradient(90deg, #333, #555); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; color:#fff; }
        .modal-title { font-size:1.4rem; font-weight:600; color:#333; margin-bottom:10px; }
        .modal-text { color:#666; margin-bottom:20px; }
        .btn-action-rose { background:linear-gradient(90deg, #333, #555); color:#fff; border:none; padding:12px 24px; border-radius:5px; cursor:pointer; font-weight:500; transition: all .2s ease; display:flex; align-items:center; justify-content:center; gap:6px; }
        .btn-action-rose:hover { transform: translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,.3); }
        .modal-button { background:linear-gradient(90deg, #333, #555); color:#fff; border:none; padding:12px 24px; border-radius:5px; cursor:pointer; font-weight:500; display:flex; align-items:center; justify-content:center; gap:6px; transition: all .2s ease; }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .eye-icon {
            width: 24px;
            height: 24px;
            fill: #666;
        }

        .toggle-password:hover .eye-icon {
            fill: #333;
        }

        /* Focus accessible en noir au lieu du bleu par défaut */
        .toggle-password:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,0,0,0.2); border-radius: 6px; }
        .toggle-password:focus .eye-icon { fill: #333; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <style>
        /* intl-tel-input alignment to match inputs */
        .iti { width:100% !important; display:block; position:relative !important; }
        .iti__country-list { list-style:none !important; z-index:9999 !important; }
        .iti__flag-container { z-index:1; }
        .iti__input { width:100% !important; padding:12px !important; border:1px solid #ddd !important; border-radius:5px !important; font-size:.95rem !important; height:44px !important; box-sizing:border-box !important; }
        .iti__input:focus { border-color:#333 !important; outline:none !important; box-shadow:0 0 0 3px rgba(0,0,0,.08) !important; }
        .iti__flag { background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/img/flags.png") !important; }
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .iti__flag { background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/img/flags@2x.png") !important; }
        }
    </style>
{% endblock %}
{% block content %}
<div class="content-area">
    <div id="mainInterface">
        <div class="page-header">
            <h1 class="page-title">ÉQUIPE</h1>
            <button class="new-member-btn" onclick="showNewMemberForm()">Nouveau Membre +</button>
        </div>

    <!-- KPIs -->
    <div class="kpi-section" id="kpiSection">
        <div class="kpi-card">
            <h3>Chiffre d'Affaires</h3>
            <div class="value" id="kpiCA">0 FCFA</div>
        </div>
        <div class="kpi-card">
            <h3>Meilleur Agent</h3>
            <div class="value" id="kpiUsers">0</div>
        </div>
        <div class="kpi-card">
            <h3>Proformas</h3>
            <div class="value" id="kpiDevis">0</div>
        </div>
        <div class="kpi-card">
            <h3>Factures</h3>
            <div class="value" id="kpiFactures">0</div>
        </div>
    </div>

    <!-- Tableau comparatif (pleine largeur) -->
    <div class="chart-card comparatif-card">
        <div class="chart-header"><h3>Tableau comparatif par agent</h3></div>
        <div id="comparatifContainer">
            <table class="staff-table">
                <thead>
                    <tr>
                        <th style="width:24%">Superviseur</th>
                        <th style="width:22%">Revenu (30j)</th>
                        <th style="width:12%">Devis (30j)</th>
                        <th style="width:18%">ATP</th>
                        <th style="width:14%">Taux conv.</th>
                    </tr>
                </thead>
                <tbody id="comparatifBody">
                    <tr><td colspan="5" class="mini">Chargement...</td></tr>
                </tbody>
            </table>
            <div class="pagination" id="comparatifPagination"></div>
        </div>
    </div>

    <!-- Liste staff -->
    <div class="table-section">
        <div class="table-controls">
            <div class="table-section-title">Liste complète du staff</div>
            <div class="search-filters">
                <select id="filterVille"><option value="">Toutes les villes</option></select>
                <input type="text" id="searchStaff" placeholder="Rechercher...">
                <button class="export-btn" id="exportStaff">Exporter</button>
            </div>
        </div>
        <table class="staff-table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Téléphone</th>
                    <th>Adresse</th>
                    <th>Ville</th>
                    <th>Pays</th>
                    <th>Fonction</th>
                </tr>
            </thead>
            <tbody id="staffBody">
                <tr><td colspan="6" class="mini">Chargement...</td></tr>
            </tbody>
        </table>
        <div class="pagination" id="staffPagination"></div>
    </div>
    </div>

    <!-- Modal actions -->
    <div class="modal-backdrop" id="actionModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeActionModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h5 class="modal-title">Action Équipe</h5>
            <p id="actionQuestion" class="modal-text"></p>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="btn-action-rose" onclick="editMember()">Modifier</button>
                <button class="modal-button" onclick="deleteMember()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Modal de suppression (team) -->
    <div class="modal-backdrop" id="deleteModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDeleteModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
                </svg>
            </div>
            <h5 class="modal-title">Confirmer la suppression</h5>
            <p class="modal-text">Êtes-vous sûr de vouloir supprimer ce membre ? Cette action est irréversible.</p>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="btn-cancel" onclick="closeDeleteModal()">Annuler</button>
                <button class="modal-button" onclick="confirmMemberDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Formulaire membre - full page -->
    <div id="memberFormPage" style="display:none; padding:20px; background:#fff;">
        <div class="form-header">
            <h2 class="form-title">Équipe / Nouveau membre</h2>
            <p class="form-subtitle">Ajoutez un nouveau membre avec ses coordonnées complètes.</p>
        </div>
        <form id="memberForm">
            <input type="hidden" id="memberId">
            <div class="form-row-full">
                <div class="form-group">
                    <label>Nom complet <span class="required-asterisk">*</span></label>
                    <input type="text" id="m_nom" required placeholder="Nom du staff">
                </div>
            </div>
            <div class="form-row-triple">
                <div class="form-group">
                    <label>Téléphone <span class="required-asterisk">*</span></label>
                    <input type="tel" id="m_tel" required>
                </div>
                <div class="form-group">
                    <label>Fonction <span class="required-asterisk">*</span></label>
                    <input type="text" id="m_fonction" placeholder="Fonction dans l'équipe" required>
                </div>
                <div class="form-group">
                    <label>Rôle</label>
                    <select id="m_role">
                        <option value="">Sélectionner un rôle</option>
                        <option value="secretaire">Utilisateur</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>

            <div id="credentialsBlock" style="display:none;">
                <div class="form-row-dual" style="margin-top:10px;">
                    <div class="form-group">
                        <label>Email <span class="required-asterisk">*</span></label>
                        <input type="email" id="m_email" placeholder="Adresse email" required>
                    </div>
                    <div class="form-group">
                        <label>Mot de passe <span class="required-asterisk">*</span></label>
                        <div style="position:relative;">
                            <input type="password" id="m_pwd" placeholder="Mot de passe">
                            <button type="button" class="toggle-password" onclick="togglePassword()">
                                <svg class="svg-icon eye-icon" viewBox="0 0 24 24">
                                    <path class="eye-open" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                    <path class="eye-closed" style="display:none;" d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row-dual" style="margin-top:10px;">
                <div class="form-group">
                    <label>Date d'entrée <span class="required-asterisk">*</span></label>
                    <input type="date" 
                        id="m_date_entree" 
                        name="date_entree" 
                        style="background-position: 10px center;"
                        required>
                </div>
                <div class="form-group">
                    <label>Date de fin de contrat</label>
                    <input type="date" 
                        id="m_date_sortie" 
                        name="date_sortie" 
                        style="background-position: 10px center;">
                </div>
            </div>

            <div class="form-row-triple" style="margin-top:10px;">
                <div class="form-group">
                    <label>Adresse <span class="required-asterisk">*</span></label>
                    <input type="text" id="m_adresse" required placeholder="Adresse complète">
                </div>
                <div class="form-group">
                    <label>Ville <span class="required-asterisk">*</span></label>
                    <input type="text" id="m_ville" required placeholder="Ville de résidence">
                </div>
                <div class="form-group">
                    <label>Pays <span class="required-asterisk">*</span></label>
                    <input type="text" id="m_pays" placeholder="Pays de résidence" required>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="showStaffList()">Annuler</button>
                <button type="submit" class="btn-save">Enregistrer</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script>
let currentMemberId = null;
let staffCache = {};
let currentStaffPage = 1;
let itiStaffPhone = null;

document.addEventListener('DOMContentLoaded', () => {
    loadKpis();
    loadComparatif();
    loadStaff();
    
    // Modification de l'event listener pour le rôle
    document.getElementById('m_role').addEventListener('change', function() {
        const role = this.value;
        const credentialsBlock = document.getElementById('credentialsBlock');
        
        if (role === 'admin' || role === 'secretaire') {
            credentialsBlock.style.display = 'block';
            document.getElementById('m_email').setAttribute('required', 'required');
            document.getElementById('m_pwd').setAttribute('required', 'required');
        } else {
            credentialsBlock.style.display = 'none';
            document.getElementById('m_email').removeAttribute('required');
            document.getElementById('m_pwd').removeAttribute('required');
            // Vider les champs quand on désélectionne le rôle
            document.getElementById('m_email').value = '';
            document.getElementById('m_pwd').value = '';
        }
    });

    document.getElementById('memberForm').addEventListener('submit', saveMember);
    
    // Configuration du plugin téléphone
    itiStaffPhone = window.intlTelInput(document.getElementById('m_tel'), {
        initialCountry: "cm",
        separateDialCode: true,
        preferredCountries: ['cm','fr','us','ca','gb'],
        formatOnDisplay: true,
        autoPlaceholder: "aggressive",
        separateDialCode: true, // Doublement important pour la séparation
        nationalMode: false,
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });
});

function formatCurrency(v){ if(!v) return '0 FCFA'; return (parseInt(v).toLocaleString('fr-FR'))+' FCFA'; }

async function loadKpis(){
  try{
    const r = await fetch('/admin/api/team/kpis');
    const d = await r.json();
    if(!d.success) return;
    
    // Chiffre d'Affaires
    document.getElementById('kpiCA').textContent = formatCurrency(d.kpi_ca);
    
    // Meilleur Agent
    document.getElementById('kpiUsers').textContent = d.kpi_users_actifs;
    
    // Devis
    document.getElementById('kpiDevis').textContent = d.kpi_devis;
    
    // Factures
    document.getElementById('kpiFactures').textContent = d.kpi_factures;
  }catch(e){ console.error(e); }
}

async function loadComparatif(page=1){
  const body = document.getElementById('comparatifBody');
  body.innerHTML = '<tr><td colspan="5" class="mini">Chargement...</td></tr>';
  try{
    const r = await fetch(`/admin/api/team/comparatif?page=${page}&rows=5`);
    const d = await r.json();
    if(!d.success){ body.innerHTML = '<tr><td colspan="5" class="mini red">Erreur chargement</td></tr>'; return; }
    if(!d.items || d.items.length===0){ body.innerHTML = '<tr><td colspan="5" class="mini">Aucune donnée</td></tr>'; document.getElementById('comparatifPagination').innerHTML=''; return; }
    const maxRev = Math.max(...d.items.map(x=>x.revenu));
    body.innerHTML = d.items.map(it=>{
        const pct = maxRev>0 ? Math.round((it.revenu*100)/maxRev) : 0;
        const devisPctBase = Math.max(1, Math.max(...d.items.map(x=>x.nb_devis)));
        const atpPctBase = Math.max(1, Math.max(...d.items.map(x=>x.atp)));
        return `
        <tr>
            <td>${it.nom}</td>
            <td>
                <div class="bar" style="position:relative;">
                    <span style="width:${pct}%; background:#8e7dff"></span>
                    <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600;">
                        ${formatCurrency(it.revenu)}
                    </div>
                </div>
            </td>
            <td>
                <div class="bar" style="position:relative;">
                    <span style="width:${Math.min(100, it.nb_devis*100/devisPctBase)}%; background:#2ecc71"></span>
                    <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600;">
                        ${it.nb_devis}
                    </div>
                </div>
            </td>
            <td>
                <div class="bar" style="position:relative;">
                    <span style="width:${Math.min(100, (it.atp||0)*100/atpPctBase)}%; background:#3498db"></span>
                    <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600;">
                        ${formatCurrency(it.atp)}
                    </div>
                </div>
            </td>
            <td>
                <div class="bar" style="position:relative;">
                    <span style="width:${it.taux}%; background:#f1c40f"></span>
                    <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600;">
                        ${it.taux}%
                    </div>
                </div>
            </td>
        </tr>`;
    }).join('');
    const totalPages = Math.max(1, Math.ceil((d.total||0)/(d.rows_per_page||5)));
    document.getElementById('comparatifPagination').innerHTML = generateStaffPaginationHtml(d.page||1, totalPages).replaceAll('loadStaff','loadComparatif');
  }catch(e){ console.error(e); body.innerHTML = '<tr><td colspan="5" class="mini red">Erreur chargement</td></tr>'; }
}

async function loadStaff(page=1){
    currentStaffPage = page;
    const r = await fetch(`/admin/api/staff?page=${page}`);
    const d = await r.json();
    const body = document.getElementById('staffBody');
    const pag = document.getElementById('staffPagination');
    if(!d.success){ body.innerHTML = '<tr><td colspan="6" class="mini red">Erreur</td></tr>'; return; }
    if(!d.items || d.items.length===0){ body.innerHTML = '<tr><td colspan="6" class="mini">Aucun membre</td></tr>'; pag.innerHTML=''; return; }
    staffCache = {};
    body.innerHTML = d.items.map(it=>{ 
        staffCache[it.user_id]=it; 
        // Nouveau formatage : on enlève le + et on met un espace après l'indicatif
        const tel = it.telephone ? it.telephone.replace(/^\+(\d{3})(\d+)/, '$1 $2') : '-';
        return `
        <tr onclick="openActionModal(${it.user_id}, '${(it.nom||'').replace(/'/g, "\\'")}')">
            <td>${it.nom||'-'}</td>
            <td>${tel}</td>
            <td>${it.adresse||'-'}</td>
            <td>${it.ville||'-'}</td>
            <td>${it.pays||'-'}</td>
            <td>${it.fonction||'Non Renseigné'}</td>
        </tr>`;
    }).join('');
    const totalPages = Math.max(1, Math.ceil((d.total||0)/(d.rows_per_page||50)));
    pag.innerHTML = generateStaffPaginationHtml(d.page||1, totalPages);
}

function openActionModal(id, nom){
  currentMemberId=id;
  const safeName = nom || '';
  document.getElementById('actionQuestion').textContent = `Que souhaitez-vous faire avec "${safeName}" ?`;
  document.getElementById('actionModal').style.display='flex';
}
function closeActionModal(){ document.getElementById('actionModal').style.display='none'; }
function showNewMemberForm(){
    document.getElementById('mainInterface').style.display = 'none';
    document.getElementById('memberFormPage').style.display = 'block';
    
    // Réinitialiser le formulaire
    document.getElementById('memberForm').reset();
    document.getElementById('memberId').value = '';
    
    // Masquer le bloc credentials par défaut
    document.getElementById('credentialsBlock').style.display = 'none';
    document.getElementById('m_role').value = '';
    
    // Retirer required des champs d'authentification
    document.getElementById('m_email').removeAttribute('required');
    document.getElementById('m_pwd').removeAttribute('required');
    
    // Mise à jour des titres
    document.querySelector('.form-title').textContent = 'Équipe / Nouveau membre';
    document.querySelector('.form-subtitle').textContent = 'Ajoutez un nouveau membre avec ses coordonnées complètes.';
}
function showStaffList(){ document.getElementById('memberFormPage').style.display='none'; document.getElementById('mainInterface').style.display='block'; currentMemberId=null; document.getElementById('memberForm').reset(); }


function editMember(){
    closeActionModal(); 
    if(!currentMemberId) return;
    const it = staffCache[currentMemberId];
    if(!it) return;

    console.log("Debug - données reçues:", it); // Pour déboguer

    // Remplissage basique
    document.getElementById('memberId').value = currentMemberId;
    document.getElementById('m_nom').value = it.nom || '';
    document.getElementById('m_adresse').value = it.adresse || '';
    document.getElementById('m_ville').value = it.ville || '';
    document.getElementById('m_pays').value = it.pays || '';
    document.getElementById('m_fonction').value = it.fonction || '';
    document.getElementById('m_role').value = it.role || '';

    // Gestion du téléphone
    if(itiStaffPhone && it.telephone) {
        const tel = it.telephone.startsWith('+') ? it.telephone : `+${it.telephone}`;
        itiStaffPhone.setNumber(tel);
    }

  
    // Nouvelle gestion des dates
    if(it.date_entree) {
        console.log("Date entrée originale:", it.date_entree);
        // Si la date contient un timestamp, prenons juste la partie date
        const dateEntree = it.date_entree.includes('T') ? 
            it.date_entree.split('T')[0] : 
            it.date_entree.split(' ')[0];
        console.log("Date entrée formatée:", dateEntree);
        document.getElementById('m_date_entree').value = dateEntree;
    }
    
    if(it.date_sortie) {
        console.log("Date sortie originale:", it.date_sortie);
        const dateSortie = it.date_sortie.includes('T') ? 
            it.date_sortie.split('T')[0] : 
            it.date_sortie.split(' ')[0];
        console.log("Date sortie formatée:", dateSortie);
        document.getElementById('m_date_sortie').value = dateSortie;
    }

    // Gestion des credentials
    const hasRole = it.role === 'admin' || it.role === 'secretaire';
    document.getElementById('credentialsBlock').style.display = hasRole ? 'block' : 'none';
    document.getElementById('m_email').value = it.email || '';
    document.getElementById('m_pwd').value = '';

    // Mise à jour interface
    document.querySelector('.form-title').textContent = 'Équipe / Modifier membre';
    document.querySelector('.form-subtitle').textContent = 'Modifiez les informations du membre existant.';
    document.getElementById('mainInterface').style.display = 'none';
    document.getElementById('memberFormPage').style.display = 'block';
}

// --- SUPPRESSION: ouverture/fermeture + confirmation ---
function openDeleteModal(id){
    if(id) currentMemberId = id;
    const modal = document.getElementById('deleteModal');
    if(!modal) return;
    modal.style.display = 'flex';

    // Close on backdrop click
    modal.addEventListener('click', function onBackdrop(e){
        if(e.target === modal){ closeDeleteModal(); }
    }, { once: true });

    // Close on ESC
    document.addEventListener('keydown', function onEsc(evt){
        if(evt.key === 'Escape'){ closeDeleteModal(); }
    }, { once: true });
}

function closeDeleteModal(){
    const modal = document.getElementById('deleteModal');
    if(!modal) return;
    modal.style.display = 'none';
}

async function confirmMemberDelete(){
    if(!currentMemberId){ alert('Erreur: ID invalide'); return; }
    try{
        const r = await fetch(`/admin/api/staff/${currentMemberId}`, { method:'DELETE' });
        const d = await r.json();
        if(d.success){
            closeDeleteModal();
            // Rafraîchir la liste et le comparatif
            loadStaff(currentStaffPage);
            loadComparatif();
        } else {
            alert(d.message || 'Erreur lors de la suppression');
        }
    }catch(e){
        console.error(e);
        alert('Erreur réseau: ' + (e?.message||e));
    }
}

async function deleteMember(){
    if(!currentMemberId) return;
    closeActionModal();
    openDeleteModal(currentMemberId);
}

async function saveMember(e){ 
    e.preventDefault();
    const id = document.getElementById('memberId').value;
    
    // Liste des champs requis
    const required = [
        ['m_nom', 'Le nom est obligatoire'],
        ['m_tel', 'Le téléphone est obligatoire'],
        ['m_adresse', 'L\'adresse est obligatoire'],
        ['m_ville', 'La ville est obligatoire'],
        ['m_pays', 'Le pays est obligatoire'],
        ['m_fonction', 'La fonction est obligatoire'],
        ['m_date_entree', 'La date d\'entrée est obligatoire']
    ];

    const role = document.getElementById('m_role').value;
    
    // Validation email/pwd uniquement si rôle admin/secretaire
    if(role === 'admin' || role === 'secretaire') {
        required.push(['m_email', 'L\'email est obligatoire']);
        if(!id) {
            required.push(['m_pwd', 'Le mot de passe est obligatoire']);
        }
    }

    // Validation des champs requis
    for(const [fid, msg] of required) {
        const el = document.getElementById(fid);
        if(!(el.value||'').trim()) {
            alert(msg);
            el.focus();
            return;
        }
    }

    // Construction du payload
    const payload = {
        nom: document.getElementById('m_nom').value.trim(),
        telephone: itiStaffPhone.getNumber(),
        adresse: document.getElementById('m_adresse').value.trim(),
        ville: document.getElementById('m_ville').value.trim(),
        pays: document.getElementById('m_pays').value.trim(),
        fonction: document.getElementById('m_fonction').value.trim(),
        date_entree: document.getElementById('m_date_entree').value,
        date_sortie: document.getElementById('m_date_sortie').value || null,
        role: role || null,
        actif: true
    };

    if(role === 'admin' || role === 'secretaire') {
        payload.email = document.getElementById('m_email').value.trim();
        const pwd = document.getElementById('m_pwd').value;
        if(pwd) {
            payload.mot_de_passe = pwd;
        }
    }

    const method = id ? 'PUT' : 'POST';
    const url = id ? `/admin/api/staff/${id}` : '/admin/api/staff';
    
    try {
        const r = await fetch(url, {
            method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const d = await r.json();
        if(d.success) {
            showStaffList();
            loadStaff(currentStaffPage);
            loadComparatif();
        } else {
            alert(d.message || 'Erreur');
        }
    } catch(e) {
        console.error(e);
        alert('Erreur lors de la sauvegarde');
    }
}

function generateStaffPaginationHtml(currentPage, totalPages){
  let html='';
  if(currentPage>1){ html += `<button class="nav-btn" onclick="loadStaff(${currentPage-1})">Précédent</button>`; } else { html += `<button class="nav-btn disabled">Précédent</button>`; }
  let startPage = Math.max(1, currentPage-2);
  let endPage = Math.min(totalPages, currentPage+2);
  if(currentPage<=3){ endPage = Math.min(5,totalPages); }
  if(currentPage>=totalPages-2){ startPage = Math.max(1,totalPages-4); }
  if(startPage>1){ html += `<button onclick=\"loadStaff(1)\">1</button>`; if(startPage>2){ html += `<button class=\"ellipsis\">...</button>`; } }
  for(let i=startPage;i<=endPage;i++){ const active = i===currentPage? 'active':''; html += `<button class=\"${active}\" onclick=\"loadStaff(${i})\">${i}</button>`; }
  if(endPage<totalPages){ if(endPage<totalPages-1){ html += `<button class=\"ellipsis\">...</button>`; } html += `<button onclick=\"loadStaff(${totalPages})\">${totalPages}</button>`; }
  if(currentPage<totalPages){ html += `<button class=\"nav-btn\" onclick=\"loadStaff(${currentPage+1})">Suivant</button>`; } else { html += `<button class=\"nav-btn disabled">Suivant</button>`; }
  return html;
}

function togglePassword() {
    const pwd = document.getElementById('m_pwd');
    const eyeOpen = document.querySelector('.eye-open');
    const eyeClosed = document.querySelector('.eye-closed');
    
    if (pwd.type === 'password') {
        // Afficher le mot de passe => icône oeil OUVERT
        pwd.type = 'text';
        if (eyeOpen) eyeOpen.style.display = 'block';
        if (eyeClosed) eyeClosed.style.display = 'none';
    } else {
        // Cacher le mot de passe => icône oeil BARRÉ
        pwd.type = 'password';
        if (eyeOpen) eyeOpen.style.display = 'none';
        if (eyeClosed) eyeClosed.style.display = 'block';
    }
}

// Synchroniser l'état de l'icône au chargement (par défaut: champ masqué => oeil barré)
document.addEventListener('DOMContentLoaded', function(){
    const pwd = document.getElementById('m_pwd');
    const eyeOpen = document.querySelector('.eye-open');
    const eyeClosed = document.querySelector('.eye-closed');
    if (!pwd) return;
    const hidden = (pwd.type === 'password');
    if (hidden) {
        if (eyeOpen) eyeOpen.style.display = 'none';
        if (eyeClosed) eyeClosed.style.display = 'block';
    } else {
        if (eyeOpen) eyeOpen.style.display = 'block';
        if (eyeClosed) eyeClosed.style.display = 'none';
    }
});
</script>
{% endblock %}