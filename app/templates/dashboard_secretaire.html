
{% extends 'base.html' %} 
{% block title %}Dashboard{% endblock %} 

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
<style>
    .content-area {
        padding: 30px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #333;
    }

    .new-invoice-btn {
        background: linear-gradient(90deg, #d81b60, #ff8a80);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: transform 0.2s ease;
    }

    .new-invoice-btn:hover {
        transform: translateY(-2px);
    }

    .date-filter {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .date-filter label {
        font-weight: 500;
        color: #333;
    }

    .date-filter select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 0.9rem;
        width: 150px;
    }

    .date-filter select:focus {
        border: 2px solid #d81b60;
        outline: none;
    }

    .kpi-section {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .kpi-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        flex: 1;
        min-width: 200px;
        position: relative;
    }

    .kpi-card h3 {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
        font-weight: 500;
    }

    .kpi-card .value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #000;
        margin-bottom: 5px;
    }

    .kpi-trend {
        font-size: 0.8rem;
        font-weight: 500;
        margin-top: 5px;
    }

    .trend-up {
    color: #4CAF50;
    }

    .trend-up::before {
    content: "▲";
    margin-right: 3px;
    }

    .trend-down {
    color: #F44336;
    }

    .trend-down::before {
    content: "▼";
    margin-right: 3px;
    }

    /* CORRECTION : Graphique pleine largeur */
    .charts-section {
        margin-bottom: 30px;
    }

    .charts-row {
        display: block; /* Au lieu de flex */
        width: 100%;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-height: 400px;
        width: 100%; /* Pleine largeur */
        box-sizing: border-box;
    }

    /* Supprimer les règles qui limitent la largeur */
    .chart-card:first-child,
    .chart-card:last-child {
        flex: none;
        max-width: none;
        width: 100%;
    }

        .chart-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .chart-container {
            position: relative;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* ✅ AJOUT */
        }

    .no-data-message {
    text-align: center;
    color: #666;
    font-size: 1rem;
    font-weight: 500;
    }

    .table-section {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow-x: auto;
    }

    .table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
    }

    .required-asterisk {
    color: #d81b60;
    font-weight: normal;
    }

    .search-filters {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    }

    .search-filters select,
    .search-filters input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
    height: 38px;
    }

    .search-filters select:focus,
    .search-filters input:focus {
    border: 2px solid #d81b60;
    outline: none;
    }

    .export-btn {
    background: linear-gradient(135deg, #d81b60, #ff8a80);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    height: 38px;
    transition: background-color 0.2s ease;
    }

    .export-btn:hover {
    background: #f5c6cb;
    }

    .export-btn1 {
    color: #000;
    border: none;
    padding: 8px 8px;
    cursor: pointer;
    font-weight: 500;
    background: #ffffff;
    }

     .table-info {
     background: linear-gradient(135deg, #e8f5e9, #e3f2fd);
     padding: 15px 20px;
     border-radius: 8px;
     margin-bottom: 20px;
     font-size: 1rem;
     font-weight: 500;
     color: #333;
     border-left: 4px solid #d81b60;
     }

     .table-controls {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 20px;
     flex-wrap: wrap;
     gap: 15px;
     }

     .table-section-title {
     font-size: 1.2rem;
     font-weight: 600;
     color: #333;
     }

    .proforma-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
    }

    .proforma-table th,
    .proforma-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: middle;
    }



    .proforma-table th {
    background: #f8f9fa;
    font-weight: 500;
    color: #333;
    border-bottom: 2px solid #e0e0e0;
    }

    .proforma-table tbody tr {
    position: relative;
    transition: background-color 0.2s ease;
    cursor: pointer;
    }

    .proforma-table tbody tr:hover {
    background: #f8f9fa;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-block;
        min-width: 80px;
        text-align: center;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        margin: 0;
        line-height: 1.2;
    }

    .status-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .status-en_attente {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-en_cours {
        background: #cce5ff;
        color: #004085;
        border: 1px solid #74b9ff;
    }

    .status-partiel {
        background: #fdfdfe;
        color: #818182;
        border: 1px solid #c6c8ca;
    }

    .status-termine {
        background: #d4edda;
        color: #155724;
        border: 1px solid #00b894;
    }

    /* Styles pour les boutons de statut dans le modal (design gradient rose) */
    .status-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    .status-btn {
        background: linear-gradient(90deg, #d81b60, #ff8a80);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 120px;
        box-shadow: 0 2px 4px rgba(216, 27, 96, 0.2);
        position: relative;
        overflow: hidden;
    }

    .status-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(216, 27, 96, 0.3);
    }

    .status-btn:focus {
        outline: 2px solid rgba(216, 27, 96, 0.5);
        outline-offset: 2px;
    }

    .status-btn--active {
        background: linear-gradient(90deg, #b71c5c, #e91e63);
        box-shadow: 0 4px 8px rgba(216, 27, 96, 0.4);
    }

    .status-btn__icon {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-btn__icon .svg-icon {
        width: 18px;
        height: 18px;
        fill: currentColor;
    }

    .status-btn__label {
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* Styles pour le modal partiel - Suppression du double scrollbar */
    #partialDeliverySection {
        overflow: hidden;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }

    #partialDeliveryItems {
        flex: 1 1 auto;
        max-height: 60vh; /* Réduit pour éviter le double scroll */
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #d81b60 #f0f0f0;
        padding: 10px;
    }

    #partialDeliveryItems::-webkit-scrollbar {
        width: 8px;
    }

    #partialDeliveryItems::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 4px;
    }

    #partialDeliveryItems::-webkit-scrollbar-thumb {
        background: #d81b60;
        border-radius: 4px;
    }

    #partialDeliveryItems::-webkit-scrollbar-thumb:hover {
        background: #b71c5c;
    }

    /* ✅ Suppression complète des scrollbars internes */
    .partial-item,
    .partial-item *,
    .partial-item input,
    .partial-item textarea,
    .partial-item select {
        overflow: visible !important;
        max-height: none !important;
    }

    /* Styles pour les formulaires adaptatifs selon le type */
    .partial-form-service {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
    }

    .partial-form-articles {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        border: 2px solid #ffb74d;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
    }

    .partial-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .partial-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .partial-item input[type="checkbox"] {
        accent-color: #d81b60;
        transform: scale(1.2);
    }

    .partial-item .field-row {
        display: flex;
        gap: 15px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .partial-item .form-group {
        flex: 1;
        min-width: 150px;
    }

    .partial-item label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        display: block;
    }

    .partial-item input,
    .partial-item textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .partial-item input:focus,
    .partial-item textarea:focus {
        outline: none;
        border-color: #d81b60;
        box-shadow: 0 0 0 3px rgba(216, 27, 96, 0.1);
    }

    .partial-item .total-display {
        background: linear-gradient(135deg, #d81b60, #e91e63);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        margin-top: 15px;
    }

    /* Styles pour les formulaires adaptatifs */
    #serviceForm, #articleForm {
        transition: all 0.3s ease;
    }

    .partial-item {
        transition: background-color 0.2s ease;
    }

    .partial-item:hover {
        background-color: #f8f9fa;
    }

    .partial-item input[type="checkbox"] {
        accent-color: #d81b60;
    }







    /* INDICATEUR D'ACTION AU SURVOL (même style que clients.html) */
    .proforma-table tbody tr::after {
    content: "⋮";
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    color: #d81b60;
    opacity: 0;
    cursor: pointer;
    transition: opacity 0.2s ease;
    padding: 4px 8px;
    border-radius: 4px;
    }

    .proforma-table tbody tr:hover::after {
    opacity: 1;
    }

    .proforma-table tbody tr::after:hover {
    background: rgba(216, 27, 96, 0.1);
    }

    .svg-icon {
    width: 18px;
    height: 18px;
    fill: currentColor;
    }

    .slide-over {
    position: fixed;
    top: 0;
    right: 0;
    width: 500px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    padding: 20px;
    overflow-y: auto;
    z-index: 1000;
    }

    .slide-over.open {
    transform: translateX(0);
    }

    .slide-over-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    }

    .slide-over-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    }

    .slide-over-close:hover {
    color: #d81b60;
    }

    .form-group {
    margin-bottom: 15px;
    }

    .form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 5px;
    color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
    box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
    border-color: #d81b60;
    outline: none;
    box-shadow: none;
    }

    /* Champs avec icônes */
    #clientName {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
    background-position: 10px center;
    background-repeat: no-repeat;
    background-size: 18px;
    padding-left: 35px;
    }

    #address {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>');
    background-position: 10px center;
    background-repeat: no-repeat;
    background-size: 18px;
    padding-left: 35px;
    }

    #city {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15 11V5l-3-3-3 3v2H3v14h18V11h-6zm-8 8H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm6 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm6 12h-2v-2h2v2zm0-4h-2v-2h2v2z"/></svg>');
    background-position: 10px center;
    background-repeat: no-repeat;
    background-size: 18px;
    padding-left: 35px;
    }

    #client-country {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>');
    background-position: 10px center;
    background-repeat: no-repeat;
    background-size: 18px;
    padding-left: 35px;
    }

    #remise {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>');
    background-position: 10px center;
    background-repeat: no-repeat;
    background-size: 18px;
    padding-left: 35px;
    }

    /* Téléphone avec intl-tel-input */
/* Container principal */
.iti {
    width: 100%;
    position: relative !important;
    display: block !important;
}

/* Input téléphone - MASQUER le texte en arrière-plan */
.iti__input {
    width: 100% !important;
    padding: 8px 12px 8px 52px !important;
    border: 1px solid #ddd !important;
    border-radius: 5px !important;
    font-size: 0.9rem !important;
    background: white !important;
    position: relative !important;
    z-index: 1 !important;
    color: transparent !important;
}

.iti__input:focus {
    border-color: #d81b60 !important;
    outline: none !important;
}

/* Container du drapeau sélectionné */
.iti__selected-flag {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    height: 100% !important;
    padding: 0 8px 0 12px !important;
    background: #E6E6E6 !important; 
    border-right: 1px solid #ddd !important;
    border: 1px solid #ddd !important;
    display: flex !important;
    align-items: center !important;
    z-index: 2 !important;
    border-radius: 5px 0 0 5px !important;
    width: auto !important;
    min-width: 65px !important;
}

/* Drapeau avec fond blanc */
.iti__flag {
    background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/img/flags.png") !important;
    background-color: white !important;
    margin-right: 6px !important;
    width: 20px !important;
    height: 15px !important;
}

/* SUPPRESSION COMPLÈTE DE LA FLÈCHE */
.iti__arrow {
    display: none !important;
}

/* Masquer le code pays affiché */
.iti__selected-dial-code {
    display: inline !important;
    font-size: 0.85rem !important;
    color: #333 !important;
    font-weight: 500 !important;
    margin-left: 2px !important;
}

/* Liste des pays */
.iti__country-list {
    background: white !important;
    border: 1px solid #ddd !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    z-index: 1000 !important;
    position: absolute !important;
    max-height: 200px !important;
    overflow-y: auto !important;
}

/* Items de la liste */
.iti__country {
    padding: 8px 12px !important;
    background: white !important;
    border: none !important;
    display: block !important;
}

.iti__country:hover {
    background: #f5f5f5 !important;
}



    /* Styles pour la sélection automatique des livres */
    .auto-select-row {
        background: linear-gradient(90deg, rgba(216, 27, 96, 0.05), rgba(255, 138, 128, 0.05));
        border: 1px solid rgba(216, 27, 96, 0.2);
        border-radius: 6px;
        padding: 12px;
        margin-top: 10px;
    }

    .auto-select-row label {
        cursor: pointer;
        margin: 0;
        font-weight: 500;
        user-select: none;
        transition: color 0.2s ease;
    }

    .auto-select-row label:hover {
        color: #ff8a80;
    }

    .auto-select-all-books {
        cursor: pointer;
        accent-color: #d81b60;
    }

    .auto-select-all-books:checked + span {
        color: #d81b60;
        font-weight: 600;
    }

    .prestation-section {
    margin-bottom: 20px;
    border: 1px solid #eee;
    border-radius: 8px;
    position: relative;
    }

    .prestation-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid #eee;
    position: relative;
    }

    .delete-prestation {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    }

    .delete-prestation:hover {
    background: #ffebee;
    color: #c82333;
    }

    .delete-prestation svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
    }

    .prestation-type-select {
    flex: 1;
    margin-right: 40px;
    }

    .prestation-fields {
    padding: 15px;
    display: none;
    gap: 10px;
    flex-direction: column;
    }

    .prestation-fields.show {
    display: flex;
    }

    .field-row {
    display: flex;
    gap: 10px;
    align-items: center;
    }

    .field-row > * {
    flex: 1;
    }

    .add-new-article {
    color: #d81b60;
    text-decoration: none;
    font-size: 1rem;
    cursor: pointer;
    display: inline-block;
    margin-top: 15px;
    }

    .add-new-article:hover {
    color: #ff8a80;
    }

    .add-new-fee {
    color: #d81b60;
    text-decoration: none;
    font-size: 1rem;
    cursor: pointer;
    display: inline-block;
    margin-top: 15px;
    }

    .add-new-fee:hover {
    color: #ff8a80;
    }

    .save-btn {
    background: linear-gradient(90deg, #d81b60, #ff8a80);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    float: right;
    margin-top: 20px;
    }

    .save-btn:hover {
    transform: translateY(-2px);
    }

    .total-section {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
    }

    .total-section div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-weight: 500;
    }

    .supplementary-fee-section {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 5px;
    position: relative;
    display: flex;
    gap: 10px;
    align-items: center;
    }

    .delete-fee-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    }

    .delete-fee-btn:hover {
    background: #ffebee;
    color: #c82333;
    }

    .delete-fee-btn svg {
        width: 16px;
    height: 16px;
    fill: currentColor;
    }

    /* Modales uniformisées (même style que clients.html) */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
    }

    .modal-content {
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        width: 700px;
        max-width: 95%;
        text-align: center;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
    }

    .modal-close:hover {
        color: #d81b60;
    }

    .modal-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(90deg, #d81b60, #ff8a80);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 1.8rem;
    }

    .modal-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }

    .modal-text {
        color: #666;
        margin-bottom: 30px;
    }

    .modal-button {
        background: linear-gradient(90deg, #d81b60, #ff8a80);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-cancel {
        background: #e0e0e0;
        color: #333;
        border: 1px solid #ccc;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-cancel:hover {
    background: #d0d0d0;
    }

    .btn-action-rose {
        background: linear-gradient(90deg, #d81b60, #ff8a80);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: transform 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-action-rose:hover {
     transform: translateY(-2px);
    }

    /* Pagination (même style que clients.html) */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    #proformaDetailsContent {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 10px;
    }


    .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 5px;
        font-size: 0.9rem;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .pagination button:hover:not(.disabled) {
        background: linear-gradient(90deg, #d81b60, #ff8a80);
        color: white;
        transform: translateY(-2px);
    }

    .pagination button.active {
        background: linear-gradient(90deg, #d81b60, #ff8a80);
        color: white;
        border-color: #d81b60;
    }

    .pagination button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f5f5f5;
        color: #999;
    }

    .pagination .nav-btn {
    padding: 8px 16px;
    min-width: auto;
    font-weight: 500;
    }

    .pagination .ellipsis {
    background: none;
    border: none;
    cursor: default;
    padding: 8px 4px;
    }

    .pagination .ellipsis:hover {
    background: none;
    transform: none;
    }

    /* Client autocomplete styles */
    .client-autocomplete {
    position: relative;
    }

    .autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 5px 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    }

    .autocomplete-suggestion {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    }

    .autocomplete-suggestion:hover {
    background: #f8f9fa;
    }

    .autocomplete-suggestion:last-child {
    border-bottom: none;
    }



    /* Notification de client trouvé - COULEUR ROSE */
    .client-found-notification {
    background: linear-gradient(90deg, rgba(216, 27, 96, 0.1), rgba(255, 138, 128, 0.1));
    border: 1px solid #d81b60;
    color: #d81b60;
    padding: 10px;
    border-radius: 5px;
    margin-top: 5px;
    font-size: 0.9rem;
    }

    /* Notification de nouveau client - COULEUR ROSE */
    .new-client-notification {
    background: linear-gradient(90deg, rgba(216, 27, 96, 0.1), rgba(255, 138, 128, 0.1));
    border: 1px solid #d81b60;
    color: #d81b60;
    padding: 10px;
    border-radius: 5px;
    margin-top: 5px;
    font-size: 0.9rem;
    }

    /* Media Queries pour l'adaptation mobile */
    @media (max-width: 768px) {
    /* Layout général */
    .content-area {
    padding: 15px;
    }

    /* En-tête */
    .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
    }

    .page-title {
    font-size: 1.5rem;
    }

    .new-invoice-btn {
    width: 100%;
    text-align: center;
    padding: 15px 20px;
    font-size: 1rem;
    }

    /* Section KPI - Passage en colonne */
    .kpi-section {
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
    }

    .kpi-card {
    min-width: 100%;
    padding: 20px 15px;
    text-align: center;
    }

    .kpi-card .value {
    font-size: 1.4rem;
    }

    .kpi-card h3 {
    font-size: 0.85rem;
    margin-bottom: 8px;
    }

    .kpi-trend {
    font-size: 0.75rem;
    }

    /* Graphique */
    .chart-container {
    padding: 15px;
    min-height: 250px;
    margin-bottom: 20px;
    }

    .no-data-message {
    font-size: 0.9rem;
    }

    /* Filtres de date */
    .date-filter {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
    margin-bottom: 20px;
    }

    .date-filter select {
    width: 100%;
    padding: 10px 12px;
    }

    /* Section tableau */
    .table-section {
    padding: 15px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    }

    /* Contrôles du tableau */
    .table-controls {
    flex-direction: column;
    gap: 12px;
    margin-bottom: 15px;
    }

    .search-filters {
    width: 100%;
    flex-direction: column;
    gap: 10px;
    }

    .search-filters select,
    .search-filters input {
    width: 100%;
    padding: 10px 12px;
    font-size: 0.9rem;
    }

    .export-btn {
    width: 100%;
    text-align: center;
    padding: 12px 16px;
    font-size: 0.9rem;
    }

    /* Info tableau */
    .table-info {
    font-size: 0.85rem;
    margin-bottom: 15px;
    text-align: center;
    }

    /* Tableau des proformas - Scroll horizontal */
    .proforma-table {
    min-width: 700px; /* Force le scroll horizontal */
    font-size: 0.85rem;
    }

    .proforma-table th, 
    .proforma-table td {
    padding: 8px 6px;
    white-space: nowrap;
    }

    .proforma-table th {
    font-size: 0.8rem;
    font-weight: 600;
    }

    /* Badges de statut plus petits */
    .status-badge {
    min-width: 65px;
    font-size: 0.7rem;
    padding: 3px 6px;
    }

    /* Indicateur d'action mobile */
    .proforma-table tbody tr::after {
    font-size: 16px;
    right: 8px;
    }

    /* Pagination */
    .pagination {
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 15px;
    }

    .pagination button {
    padding: 6px 8px;
    min-width: 32px;
    height: 32px;
    font-size: 0.8rem;
    }

    .pagination .nav-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
    }

    /* Slide-over (formulaire) - Plein écran */
    .slide-over {
    width: 100%;
    padding: 15px;
    left: 0;
    transform: translateX(100%);
    }

    .slide-over.open {
    transform: translateX(0);
    }

    .slide-over-header {
    margin-bottom: 15px;
    }

    .slide-over-header h4 {
    font-size: 1.2rem;
    }

    /* Modales - Adaptation mobile */
    .modal-content {
    padding: 20px 15px;
    width: 95%;
    max-width: 95%;
    margin: 20px auto;
    }

    .modal-title {
    font-size: 1.2rem;
    }

    .modal-text {
    font-size: 0.9rem;
    }

    .modal-button, 
    .btn-cancel,
    .btn-action-rose {
    padding: 12px 16px;
    font-size: 0.9rem;
    min-width: 120px;
    }

    /* Formulaire dans slide-over */
    .form-group {
    margin-bottom: 12px;
    }

    .form-group label {
    font-size: 0.9rem;
    margin-bottom: 4px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
    padding: 10px 12px;
    font-size: 0.9rem;
    }

    /* Sections de prestation */
    .prestation-section {
    margin-bottom: 15px;
    }

    .prestation-header {
    padding: 12px;
    }

    .prestation-fields {
    padding: 12px;
    }

    .field-row {
    flex-direction: column;
    gap: 8px;
    }

    /* Frais supplémentaires */
    .supplementary-fee-section {
    padding: 8px;
    margin-bottom: 8px;
    }

    .fee-row {
    flex-direction: column !important;
    gap: 8px !important;
    }

    /* Section totaux */
    .total-section {
    margin-top: 15px;
    padding-top: 12px;
    }

    .total-section div {
    font-size: 0.9rem;
    margin-bottom: 8px;
    }

    /* Bouton de sauvegarde */
    .save-btn {
    width: 100%;
    margin-top: 15px;
    padding: 15px;
    font-size: 1rem;
    }
    }


    /* Petit spinner inline */
    .inline-spinner{
    display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;
    border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}


    /* Media queries pour très petits écrans */
    @media (max-width: 480px) {
    .content-area {
    padding: 10px;
    }

    .page-title {
    font-size: 1.3rem;
    text-align: center;
    }

    /* KPI encore plus compacts */
    .kpi-card {
    padding: 15px 10px;
    }

    .kpi-card .value {
    font-size: 1.2rem;
    }

    .kpi-card h3 {
    font-size: 0.8rem;
    }

    /* Graphique plus petit */
    .chart-container {
    min-height: 200px;
    padding: 10px;
    }

    /* Tableau très compact */
    .proforma-table {
    min-width: 600px;
    font-size: 0.8rem;
    }

    .proforma-table th, 
    .proforma-table td {
    padding: 6px 4px;
    }

    .status-badge {
    min-width: 55px;
    font-size: 0.65rem;
    padding: 2px 4px;
    }

    /* Pagination ultra-compacte */
    .pagination button {
    padding: 4px 6px;
    min-width: 28px;
    height: 28px;
    font-size: 0.75rem;
    }

    /* Modal très compacte */
    .modal-content {
    padding: 15px 10px;
    width: 98%;
    }

    .modal-title {
    font-size: 1.1rem;
    }

    .modal-button, 
    .btn-cancel,
    .btn-action-rose {
    padding: 10px 12px;
    font-size: 0.85rem;
    min-width: 100px;
    }

    /* Formulaire très compact */
    .form-group input,
    .form-group select,
    .form-group textarea {
    padding: 8px 10px;
    font-size: 0.85rem;
    }

    /* Media queries pour orientation paysage mobile */
    @media (max-width: 768px) and (orientation: landscape) {
    /* KPI en 2 colonnes en paysage */
    .kpi-section {
    flex-direction: row;
    flex-wrap: wrap;
    }

    .kpi-card {
    min-width: calc(50% - 6px);
    flex: 1;
    }

    /* Graphique moins haut en paysage */
    .chart-container {
    min-height: 180px;
    }

    /* Tableau avec plus d'espace en paysage */
    .proforma-table {
    min-width: 800px;
    }
    }

    /* Media queries pour tablettes */
    @media (min-width: 769px) and (max-width: 1024px) {
    .content-area {
    padding: 20px;
    }

    /* KPI en 2x2 sur tablette */
    .kpi-section {
    flex-wrap: wrap;
    }

    .kpi-card {
    min-width: calc(50% - 10px);
    flex: 1;
    }

    /* Tableau tablette */
    .proforma-table {
    font-size: 0.9rem;
    }

    .proforma-table th, 
    .proforma-table td {
    padding: 10px 8px;
    }

    /* Slide-over tablette */
    .slide-over {
    width: 60%;
    min-width: 400px;
    }
    }
</style>
{% endblock %} 

{% block content %}
<div class="content-area">
    <div class="page-header">
    <h1 class="page-title">FACTURATION</h1>
    <button class="new-invoice-btn" id="new-invoice-btn">
        Nouvelle Proforma +
    </button>
    </div>

    <div class="kpi-section">
        <div class="kpi-card">
            <h3>Chiffre d'affaires</h3>
            <div class="value">{{ kpi_ca }}</div>
            <div class="kpi-trend {% if kpi_ca_trend > 0 %}trend-up{% elif kpi_ca_trend < 0 %}trend-down{% endif %}">
            {% if kpi_ca_trend > 0 %}+{% elif kpi_ca_trend < 0 %}-{% endif %}{{ kpi_ca_trend|abs }}%
            </div>
        </div>
        <div class="kpi-card">
            <h3>Factures</h3>
            <div class="value">{{ kpi_factures }}</div>
            <div class="kpi-trend {% if kpi_factures_trend > 0 %}trend-up{% elif kpi_factures_trend < 0 %}trend-down{% endif %}">
                {% if kpi_factures_trend > 0 %}+{% elif kpi_factures_trend < 0 %}-{% endif %}{{ kpi_factures_trend|abs }}%
            </div>
        </div>
        <div class="kpi-card">
            <h3>Devis</h3>
            <div class="value">{{ kpi_devis }}</div>
            <div class="kpi-trend {% if kpi_devis_trend > 0 %}trend-up{% elif kpi_devis_trend < 0 %}trend-down{% endif %}">
            {% if kpi_devis_trend > 0 %}+{% elif kpi_devis_trend < 0 %}-{% endif %}{{ kpi_devis_trend|abs }}%
            </div>
        </div>
        <div class="kpi-card">
            <h3>À traiter</h3>
            <div class="value">{{ kpi_a_traiter }}</div>
            <div class="kpi-trend {% if kpi_a_traiter_trend > 0 %}trend-up{% elif kpi_a_traiter_trend < 0 %}trend-down{% endif %}">
            {% if kpi_a_traiter_trend > 0 %}+{% elif kpi_a_traiter_trend < 0 %}-{% endif %}{{ kpi_a_traiter_trend|abs }}%
            </div>
        </div>
    </div>

    <!-- Section Graphique CA/Factures -->
    <div class="charts-section">
        <div class="charts-row">
            <!-- Graphique CA et Factures -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Évolution Du Chiffre D'Affaires</h3>
                </div>
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="caFacturesChart" style="display: block;"></canvas>
                    <div id="caFacturesChartNoData" class="no-data-message" style="display: none;">
                        AUCUNE DONNÉE DISPONIBLE
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Tables de Proforma -->
    <div class="table-section">
        <!-- En-tête avec résumé -->
        <div class="table-info">
            <span id="proforma-count">{{ proformas_count }}</span> Proforma, pour un montant total de
            <span id="proforma-total-amount">{{ total_amount }}</span>
        </div>

        <div class="table-controls">
            <div class="table-section-title">Listes des Proformas</div>
            <div class="search-filters">
                <input type="text" placeholder="Rechercher..." id="searchProformasInput">
                <select id="status-filter">
                    <option value="">Tous les statuts</option>
                    <option value="en_attente">En attente</option>
                    <option value="en_cours">En cours</option>
                    <option value="partiel">Partielle</option>
                    <option value="termine">Terminé</option>
                </select>
                <button class="export-btn" id="export-btn">Exporter</button>
            </div>
        </div>

    <table class="proforma-table">
        <thead>
        <tr>
            <th>N°</th>
            <th>Date</th>
            <th>Client</th>
            <th>Total</th>
            <th>Versement</th>
            <th>Restant</th>
            <th>Statut</th>
            <th>Agent</th>
            <th style="display: none;">Actions</th>
        </tr>
        </thead>
        <tbody id="proforma-tbody">
            <!-- DEBUG: Nombre de proformas = {{ proformas|length }} -->
            {% if proformas|length == 0 %}
                <tr class="no-data-row" style="pointer-events: none; cursor: default;">
                    <td colspan="8" style="text-align:center; color:#d81b60;">AUCUNE PROFORMA TROUVÉE</td>
                </tr>
            {% else %}
                {% for proforma in proformas %}
                    <!-- ✅ DEBUG TEMPLATE -->
                    <!-- DEBUG: Proforma ID={{ proforma.proforma_id }}, Statut={{ proforma.etat }} -->
                    
                    {% if proforma.proforma_id %}
                        <tr data-proforma-id="{{ proforma.proforma_id }}" 
                            data-status="{{ proforma.etat or 'en_attente' }}" 
                            onclick="openProformaActionModal('{{ proforma.proforma_id }}', '{{ proforma.numero }}', '{{ proforma.etat or 'en_attente' }}')">
                            <td>{{ proforma.numero }}</td>
                            <td>{{ proforma.date_creation }}</td>
                            <td>{{ proforma.client_nom }}</td>
                            <td>{{ "{:,}".format(proforma.total_ttc|int).replace(',', ' ') }} FCFA</td>
                            <td>-</td>
                            <td>-</td>
                            <td>
                                <span class="status-badge status-{{ proforma.etat or 'en_attente' }}" 
                                    onclick="changeProformaStatus(event, '{{ proforma.proforma_id }}', '{{ proforma.etat or 'en_attente' }}')">
                                    {% if proforma.etat == 'en_attente' or not proforma.etat %}En attente
                                    {% elif proforma.etat == 'en_cours' %}En cours  
                                    {% elif proforma.etat == 'partiel' %}Partielle
                                    {% elif proforma.etat == 'termine' %}Terminé
                                    {% else %}{{ proforma.etat|title }}
                                    {% endif %}
                                </span>
                            </td>
                            <td>{{ proforma.created_by }}</td>
                        </tr>
                    {% else %}
                        <!-- ✅ CAS D'ERREUR VISIBLE -->
                        <tr style="background-color: #ffebee; pointer-events: none;">
                            <td colspan="8" style="text-align:center; color:#d32f2f;">
                                ❌ PROFORMA AVEC ID INVALIDE
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </tbody>
    </table>

    <div class="pagination" id="paginationContainer">
        <!-- Pagination générée dynamiquement -->
    </div>
<!-- Modal: Livraison partielle -->
<div class="modal-backdrop" id="partialModalBackdrop" style="display:none;">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="partialModalTitle">
    <button class="modal-close" id="partialModalClose" aria-label="Fermer">×</button>
    <div class="modal-icon">L</div>
    <h3 class="modal-title" id="partialModalTitle">Livraison partielle</h3>

    <section id="partialDeliverySection">
      <!-- En-tête avec informations de la proforma -->
      <div id="partialProformaInfo" class="partial-form-service" style="margin-bottom: 20px;">
        <h4 class="chart-header">Informations de la proforma</h4>
        <div id="partialProformaDetails"></div>
      </div>

      <!-- Contenu dynamique selon le type de prestation -->
      <div id="partialDeliveryItems"></div>

      <!-- Formulaire pour Services/Formations -->
      <div id="partialFinanceOnly" class="partial-form-service" style="display:none;">
        <h4 class="chart-header">Versement partiel</h4>
        <div class="field-row">
          <div class="form-group">
            <label>Versement (FCFA)</label>
            <input type="number" min="0" step="100" id="partialVersement" value="0" placeholder="Montant versé" />
          </div>
          <div class="form-group">
            <label>Restant (FCFA)</label>
            <input type="number" min="0" step="100" id="partialRestant" value="0" disabled />
          </div>
        </div>
        <div class="form-group">
          <label>Commentaire</label>
          <textarea id="partialComment" rows="3" placeholder="Commentaire sur le versement (optionnel)"></textarea>
        </div>
      </div>

      <!-- Formulaire pour Livres/Fournitures -->
      <div id="partialArticlesForm" class="partial-form-articles" style="display:none;">
        <h4 class="chart-header">Livraison partielle d'articles</h4>
        <div id="partialArticlesList"></div>
        
        <div class="field-row" style="margin-top: 20px;">
          <div class="form-group">
            <label>Versement optionnel (FCFA)</label>
            <input type="number" min="0" step="100" id="partialVersementArticles" value="0" placeholder="Montant perçu après livraison" />
          </div>
          <div class="form-group">
            <label>Restant (FCFA)</label>
            <input type="number" min="0" step="100" id="partialRestantArticles" value="0" disabled />
          </div>
        </div>
        <div class="form-group">
          <label>Commentaire</label>
          <textarea id="partialCommentArticles" rows="3" placeholder="Commentaire sur la livraison (optionnel)"></textarea>
        </div>
      </div>

      <!-- Pied d'actions -->
      <div style="display:flex; gap:12px; justify-content:center; margin-top:20px;">
        <button class="btn-cancel" id="partialCancelBtn">Annuler</button>
        <button class="btn-action-rose" id="partialSubmitBtn">
          Valider <span id="partialSubmitSpinner" class="inline-spinner" style="display:none;"></span>
        </button>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  const backdrop = document.getElementById('partialModalBackdrop');
  const btnClose = document.getElementById('partialModalClose');
  const btnCancel = document.getElementById('partialCancelBtn');
  const btnSubmit = document.getElementById('partialSubmitBtn');
  const spinner = document.getElementById('partialSubmitSpinner');
  const itemsWrap = document.getElementById('partialDeliveryItems');
  const financeOnly = document.getElementById('partialFinanceOnly');
  const versementInput = document.getElementById('partialVersement');
  const restantInput = document.getElementById('partialRestant');
  const commentInput = document.getElementById('partialComment');

  let currentProformaId = null;
  let proformaTotals = { total_ttc: 0, total_verse: 0, total_restant: 0 };
  let articlesState = []; // {article_id, designation, type_article, prix, quantite_totale, quantite_a_livrer}

  function openModal(){ backdrop.style.display = 'flex'; disableBodyScroll(); }
  function closeModal(){ backdrop.style.display = 'none'; enableBodyScroll(); resetState(); }
  function disableBodyScroll(){ document.body.style.overflow = 'hidden'; }
  function enableBodyScroll(){ document.body.style.overflow = ''; }
  function resetState(){ 
    itemsWrap.innerHTML = ''; 
    document.getElementById('partialFinanceOnly').style.display = 'none'; 
    document.getElementById('partialArticlesForm').style.display = 'none';
    document.getElementById('partialVersement').value = 0; 
    document.getElementById('partialRestant').value = 0; 
    document.getElementById('partialComment').value = '';
    document.getElementById('partialVersementArticles').value = 0;
    document.getElementById('partialRestantArticles').value = 0;
    document.getElementById('partialCommentArticles').value = '';
    articlesState = []; 
  }

  // Public API, can be called from elsewhere after confirmation flow
  window.openPartialModal = async function(proformaId){
    currentProformaId = proformaId;
    await loadProformaForPartial(proformaId);
    openModal();
  }

  btnClose && btnClose.addEventListener('click', closeModal);
  btnCancel && btnCancel.addEventListener('click', closeModal);

  async function loadProformaForPartial(id){
    itemsWrap.innerHTML = '<div class="no-data-message">Chargement…</div>';
    try{
      // Réutilise la route existante de détails complète
      const res = await fetch(`/api/proforma/${id}?include_articles=true&include_frais=true&include_client=true`, {credentials:'same-origin'});
      const data = await res.json();
      if(!data || !data.success){
        itemsWrap.innerHTML = '<div class="no-data-message">Impossible de charger la proforma.</div>';
        return;
      }
      const p = data.proforma || {};
      const items = (data.articles || []).map(a => ({
        article_id: a.article_id,
        designation: a.designation,
        type_article: (a.type_article||'').toLowerCase(),
        prix: Number(a.prix||0),
        quantite_totale: Number(a.quantite||0),
        quantite_a_livrer: 0
      }));
      
      // Calculer les totaux
      const totalArticles = items.reduce((sum, item) => sum + (item.prix * item.quantite_totale), 0);
      proformaTotals.total_ttc = totalArticles + Number(p.frais || 0) - Number(p.remise || 0);
      proformaTotals.total_verse = Number(p.montant_paye || 0);
      proformaTotals.total_restant = Math.max(0, proformaTotals.total_ttc - proformaTotals.total_verse);

      // Afficher les informations de la proforma
      displayProformaInfo(p, items);
      
      // Détection des types: si tous sont service/formation => mode finance only
      const hasOnlyServices = items.length>0 && items.every(it => it.type_article==='service' || it.type_article==='formation');
      articlesState = items;
      
      if(hasOnlyServices){
        // Mode Service/Formation uniquement
        itemsWrap.innerHTML = '';
        document.getElementById('partialFinanceOnly').style.display = 'block';
        document.getElementById('partialArticlesForm').style.display = 'none';
        updateFinanceOnly(0);
      }else{
        // Mode Livres/Fournitures avec option de versement
        document.getElementById('partialFinanceOnly').style.display = 'none';
        document.getElementById('partialArticlesForm').style.display = 'block';
        renderItems(items);
        updateArticlesForm(0);
        
        // Afficher la liste des articles dans le formulaire
        displayArticlesList(items);
      }
    }catch(e){
      console.error('loadProformaForPartial', e);
      itemsWrap.innerHTML = '<div class="no-data-message">Erreur de chargement.</div>';
    }
  }

  function displayProformaInfo(proforma, items) {
    const infoDiv = document.getElementById('partialProformaDetails');
    const totalArticles = items.reduce((sum, item) => sum + (item.prix * item.quantite_totale), 0);
    const totalTTC = totalArticles + Number(proforma.frais || 0) - Number(proforma.remise || 0);
    
    infoDiv.innerHTML = `
      <div class="field-row">
        <div class="form-group">
          <label>Client:</label>
          <div style="font-weight: 600; color: #495057;">${escapeHtml(proforma.client_nom || 'N/A')}</div>
        </div>
        <div class="form-group">
          <label>Date création:</label>
          <div style="font-weight: 600; color: #495057;">${proforma.date_creation || 'N/A'}</div>
        </div>
        <div class="form-group">
          <label>Total TTC:</label>
          <div style="font-weight: 600; color: #d81b60; font-size: 1.1em;">${new Intl.NumberFormat('fr-FR').format(totalTTC)} FCFA</div>
        </div>
      </div>
      <div class="field-row">
        <div class="form-group">
          <label>Déjà payé:</label>
          <div style="font-weight: 600; color: #28a745;">${new Intl.NumberFormat('fr-FR').format(proforma.montant_paye || 0)} FCFA</div>
        </div>
        <div class="form-group">
          <label>Restant:</label>
          <div style="font-weight: 600; color: #dc3545;">${new Intl.NumberFormat('fr-FR').format(proforma.montant_restant || totalTTC)} FCFA</div>
        </div>
        <div class="form-group">
          <label>Nombre d'articles:</label>
          <div style="font-weight: 600; color: #495057;">${items.length}</div>
        </div>
      </div>
    `;
  }

  function renderItems(items){
    if(!items || items.length===0){
      itemsWrap.innerHTML = '<div class="no-data-message">Aucun article.</div>';
      return;
    }
    itemsWrap.innerHTML = '';
    items.forEach((it, idx) => {
      const card = document.createElement('div');
      card.className = 'partial-item';
      card.dataset.articleId = it.article_id;
      card.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px; margin-bottom: 15px;">
          <input type="checkbox" class="pi-check" aria-label="Sélectionner" />
          <div style="flex:1;">
            <div style="font-weight:600; font-size: 1.1em; color: #495057;">${escapeHtml(it.designation||'')}</div>
            <div style="color:#666;font-size:.9rem; text-transform: capitalize;">Type: ${it.type_article||'-'}</div>
          </div>
        </div>
        <div class="field-row">
          <div class="form-group">
            <label>Prix unitaire (FCFA):</label>
            <input type="number" class="pi-pu" value="${it.prix}" min="0" disabled />
          </div>
          <div class="form-group">
            <label>Quantité totale:</label>
            <input type="number" class="pi-qt" value="${it.quantite_totale}" min="0" disabled />
          </div>
          <div class="form-group">
            <label>Quantité à livrer:</label>
            <input type="number" class="pi-ql" value="0" min="0" max="${it.quantite_totale}" />
          </div>
        </div>
        <div class="total-display">
          <span>Total pour cet article:</span>
          <strong class="pi-total">0 FCFA</strong>
        </div>`;
      itemsWrap.appendChild(card);
    });

    // Bind events
    itemsWrap.querySelectorAll('.partial-item').forEach((card, i)=>{
      const ql = card.querySelector('.pi-ql');
      const total = card.querySelector('.pi-total');
      const pu = Number(card.querySelector('.pi-pu').value||0);
      const max = Number(card.querySelector('.pi-qt').value||0);
      const check = card.querySelector('.pi-check');
      
      function recalc(){
        let v = Number(ql.value||0);
        if(v>max){ v=max; ql.value = String(max); }
        if(v<0){ v=0; ql.value = '0'; }
        total.textContent = new Intl.NumberFormat('fr-FR').format(pu * v) + ' FCFA';
        articlesState[i].quantite_a_livrer = check.checked ? v : 0;
        updateArticlesForm(computeItemsTotal());
      }
      
      check.addEventListener('change', ()=>{
        if(!check.checked){ 
          ql.value='0'; 
          ql.disabled = true;
        } else {
          ql.disabled = false;
        }
        recalc(); 
      });
      ql.addEventListener('input', recalc);
      
      // Désactiver initialement la quantité si pas coché
      ql.disabled = !check.checked;
    });
  }

  function updateArticlesForm(extraAmount) {
    const versementInput = document.getElementById('partialVersementArticles');
    const restantInput = document.getElementById('partialRestantArticles');
    const baseRestant = Math.max(0, proformaTotals.total_ttc - proformaTotals.total_verse);
    const versement = Number(versementInput.value || 0);
    const newRestant = Math.max(0, baseRestant - versement);
    restantInput.value = newRestant;
  }

  function displayArticlesList(items) {
    const articlesListDiv = document.getElementById('partialArticlesList');
    if (!items || items.length === 0) {
      articlesListDiv.innerHTML = '<div class="no-data-message">Aucun article disponible.</div>';
      return;
    }

    let html = '<div class="chart-header" style="margin-bottom: 15px;">Articles disponibles pour livraison</div>';
    
    items.forEach((item, index) => {
      html += `
        <div class="partial-item" style="margin-bottom: 10px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" class="article-check" data-index="${index}" />
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #495057;">${escapeHtml(item.designation)}</div>
              <div style="color: #666; font-size: 0.9rem; text-transform: capitalize;">Type: ${item.type_article}</div>
            </div>
          </div>
          <div class="field-row">
            <div class="form-group">
              <label>Prix unitaire:</label>
              <div style="font-weight: 600; color: #d81b60;">${new Intl.NumberFormat('fr-FR').format(item.prix)} FCFA</div>
            </div>
            <div class="form-group">
              <label>Quantité disponible:</label>
              <div style="font-weight: 600; color: #495057;">${item.quantite_totale}</div>
            </div>
            <div class="form-group">
              <label>Quantité à livrer:</label>
              <input type="number" class="article-quantity" data-index="${index}" min="0" max="${item.quantite_totale}" value="0" disabled />
            </div>
          </div>
        </div>
      `;
    });

    articlesListDiv.innerHTML = html;

    // Bind events pour les checkboxes et quantités
    articlesListDiv.querySelectorAll('.article-check').forEach((checkbox, index) => {
      const quantityInput = articlesListDiv.querySelector(`.article-quantity[data-index="${index}"]`);
      
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          quantityInput.disabled = false;
          quantityInput.value = 1; // Valeur par défaut
        } else {
          quantityInput.disabled = true;
          quantityInput.value = 0;
        }
        updateArticlesForm(0);
      });
    });

    articlesListDiv.querySelectorAll('.article-quantity').forEach((input, index) => {
      input.addEventListener('input', () => {
        const max = Number(input.max);
        let value = Number(input.value);
        if (value > max) input.value = max;
        if (value < 0) input.value = 0;
        updateArticlesForm(0);
      });
    });
  }

  function computeItemsTotal(){
    return articlesState.reduce((acc, it)=> acc + (Number(it.prix||0) * Number(it.quantite_a_livrer||0)), 0);
  }

  function updateFinanceOnly(extraAmount){
    const baseRestant = Math.max(0, proformaTotals.total_ttc - proformaTotals.total_verse);
    const versement = Number(versementInput.value||0);
    const newRestant = Math.max(0, baseRestant - versement);
    restantInput.value = newRestant;
    // When there are items, the extraAmount is the newly delivered amount; versement stays user-controlled (optional)
    // UI only here
  }

  // Événements pour le formulaire des services/formations
  versementInput && versementInput.addEventListener('input', ()=> updateFinanceOnly(0));

  // Événements pour le formulaire des articles
  const versementArticlesInput = document.getElementById('partialVersementArticles');
  versementArticlesInput && versementArticlesInput.addEventListener('input', ()=> updateArticlesForm(computeItemsTotal()));

  btnSubmit && btnSubmit.addEventListener('click', async function(){
    if(!currentProformaId) return;
    
    // Validation selon le mode
    const hasOnlyServices = articlesState.length>0 && articlesState.every(it => it.type_article==='service' || it.type_article==='formation');
    
    if(hasOnlyServices || articlesState.length===0){
      // Validation pour services/formations
      const versement = Number(document.getElementById('partialVersement').value||0);
      if(versement <= 0) {
        alert('Veuillez saisir un montant de versement valide.');
        return;
      }
    } else {
      // Validation pour articles
      const articlesSelectionnes = articlesState.filter(it => Number(it.quantite_a_livrer||0) > 0);
      if(articlesSelectionnes.length === 0) {
        alert('Veuillez sélectionner au moins un article à livrer.');
        return;
      }
    }
    
    spinner.style.display = 'inline-block';
    btnSubmit.disabled = true;
    
    try{
      const payload = buildPayload();
      const res = await fetch(`/api/proforma/${currentProformaId}/partial`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if(out && out.success){
        // Message de succès selon le mode
        const modeMessage = payload.mode === 'finance' ? 
          'Versement partiel enregistré avec succès !' : 
          'Livraison partielle enregistrée avec succès !';
        
        // Met à jour la ligne du tableau (Versement/Restant) si présent
        try{
          const row = document.querySelector(`tr[data-proforma-id="${currentProformaId}"]`);
          if(row){
            const verseCell = row.querySelector('td:nth-child(5)');
            const restCell  = row.querySelector('td:nth-child(6)');
            if(verseCell) verseCell.textContent = new Intl.NumberFormat('fr-FR').format(out.versement||0) + ' FCFA';
            if(restCell)  restCell.textContent  = new Intl.NumberFormat('fr-FR').format(out.restant||0) + ' FCFA';
          }
        }catch(err){ console.warn('Update table cells failed', err); }
        
        alert(modeMessage);
        closeModal();
        
        // Recharger la page pour mettre à jour les données
        setTimeout(() => window.location.reload(), 1000);
      }else{
        alert((out && out.message) || 'Échec de l\'enregistrement.');
      }
    }catch(e){
      console.error(e); 
      alert('Erreur réseau lors de l\'enregistrement.');
    }finally{
      spinner.style.display = 'none';
      btnSubmit.disabled = false;
    }
  });

  function buildPayload(){
    const hasOnlyServices = articlesState.length>0 && articlesState.every(it => it.type_article==='service' || it.type_article==='formation');
    
    if(hasOnlyServices || articlesState.length===0){
      // Mode Service/Formation
      const versement = Number(document.getElementById('partialVersement').value||0);
      const commentaire = document.getElementById('partialComment').value || '';
      return {
        mode: 'finance',
        versement,
        commentaire
      };
    } else {
      // Mode Livres/Fournitures
      const versement = Number(document.getElementById('partialVersementArticles').value||0);
      const commentaire = document.getElementById('partialCommentArticles').value || '';
      
      // Récupérer les quantités depuis le formulaire des articles
      const lignes = [];
      const articlesListDiv = document.getElementById('partialArticlesList');
      if (articlesListDiv) {
        articlesListDiv.querySelectorAll('.article-check:checked').forEach(checkbox => {
          const index = Number(checkbox.dataset.index);
          const quantityInput = articlesListDiv.querySelector(`.article-quantity[data-index="${index}"]`);
          const quantite = Number(quantityInput.value || 0);
          
          if (quantite > 0 && articlesState[index]) {
            lignes.push({
              article_id: articlesState[index].article_id,
              quantite: quantite,
              prix_unitaire: Number(articlesState[index].prix || 0)
            });
          }
        });
      }
      
      return { mode: 'items', versement, commentaire, lignes };
    }
  }

  // Small helper
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"]/g, c => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;"
    }[c]));
  }
})();
</script>

<script>
  // Hook après confirmation de passage en "Partiel"
  window.__afterStatusChangedToPartiel = function(proformaId){
    if(typeof window.openPartialModal === 'function'){
      window.openPartialModal(proformaId);
    }
  };
</script>
</div>

<!-- Slide-over pour formulaire proforma -->
<div class="slide-over" id="slide-over">
  <div class="slide-over-header">
    <h4 id="slide-over-title">Nouvelle Proforma</h4>
    <button type="button" class="slide-over-close" id="slide-over-close">×</button>
  </div>
  <div class="slide-over-body">
    <form id="proforma-form">
      <div class="form-group">
        <label for="proforma-date">Date <span class="required-asterisk">*</span></label>
        <input type="date" id="proforma-date" class="form-control" value="{{ current_date }}" required />
      </div>
      
     <div class="form-group client-autocomplete">
        <label for="phone">Téléphone <span class="required-asterisk">*</span></label>
        <input type="tel" id="phone" class="form-control" required />
        <div id="client-suggestions" class="autocomplete-suggestions"></div>
     </div>

      
      <div class="form-group">
        <label for="clientName">Nom <span class="required-asterisk">*</span></label>
        <input type="text" id="clientName" name="clientName" placeholder="Nom du client" required />
      </div>
      
      <div class="form-group">
        <label for="address">Adresse <span class="required-asterisk">*</span></label>
        <input type="text" id="address" name="address" placeholder="Entrez l'adresse du client" required />
      </div>
      
      <div class="form-group">
        <label for="city">Ville <span class="required-asterisk">*</span></label>
        <input type="text" id="city" name="city" placeholder="Entrez la ville" required />
      </div>
      
      <div class="form-group">
        <label for="client-country">Pays <span class="required-asterisk">*</span></label>
        <input type="text" id="client-country" class="form-control" placeholder="Pays du client" required value="Cameroun" />
      </div>
      
      <div class="form-group">
        <label for="remise">Remise (%)</label>
        <input type="number" id="remise" class="form-control" placeholder="Pourcentage de remise" min="0" max="100" value="0" />
      </div>

      <div class="form-group">
        <label>Prestations <span class="required-asterisk">*</span></label>
        <div id="articles-container">
          <!-- Les lignes de prestation seront ajoutées dynamiquement -->
        </div>
        <a href="#" class="add-new-article" id="add-article-btn">+ Ajouter une prestation</a>
      </div>

      <div class="form-group">
        <label>Frais supplémentaires</label>
        <div id="supplementary-fees-container">
          <!-- Les lignes de frais supplémentaires seront ajoutées dynamiquement -->
        </div>
        <a href="#" class="add-new-fee" id="add-fee-btn">+ Ajouter un frais</a>
      </div>

      <div class="total-section">
        <div><span>Sous-total:</span><span id="sub-total">0 FCFA</span></div>
        <div><span>Remise:</span><span id="discount-display">0 FCFA</span></div>
        <div><span>Frais supplémentaires:</span><span id="supplementary-fees-display">0 FCFA</span></div>
        <div><span>TVA (19,25%):</span><span id="tva-amount">0 FCFA</span></div>
        <hr />
        <div><span>Total TTC:</span><span id="total-ttc">0 FCFA</span></div>
        <div><span>Montant en lettres:</span><span id="amount-in-words">Zéro franc CFA</span></div>
      </div>

     <button type="button" class="save-btn" onclick="handleProformaSubmit(event)">Enregistrer Proforma</button>
    </form>
  </div>
</div>


<!-- Modal de confirmation proforma -->
<div class="modal-backdrop" id="proformaSuccessModal" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeProformaSuccessModal()">×</button>
        <div class="modal-icon">
            <svg class="svg-icon" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
        </div>
        <h5 class="modal-title">Proforma enregistrée avec succès</h5>
        <p class="modal-text">Les informations ont bien été enregistrées et sont prêtes pour le traitement.</p>
        <button class="modal-button" onclick="closeProformaSuccessModal()">Retour à la liste des proformas</button>
    </div>
</div>

<!-- Modal de confirmation pour modification proforma -->
<div class="modal-backdrop" id="proformaModificationModal" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeProformaModificationModal()">×</button>
        <div class="modal-icon">
            <svg class="svg-icon" viewBox="0 0 24 24">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
        </div>
        <h5 class="modal-title">Proforma modifiée avec succès</h5>
        <p class="modal-text">Les informations de la proforma ont été mises à jour avec succès.</p>
        <button class="modal-button" onclick="closeProformaModificationModal()">Retour à la liste des proformas</button>
    </div>
</div>

<!-- Modal Détails Proforma -->
<div class="modal-backdrop" id="detailsModal" style="display: none;">
  <div class="modal-content" style="width: 800px; max-width: 95%;">
    <button class="modal-close" onclick="closeDetailsModal()">×</button>
    <div class="modal-text">
      <div id="proformaDetailsContent">
        <!-- Contenu généré dynamiquement -->
      </div>
    </div>
    <div id="action-buttons" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
      <button class="btn-cancel" onclick="closeDetailsModal()">Fermer</button>
    </div>
  </div>
</div>


<!-- Modal nouveau client détecté -->
<div class="modal-backdrop" id="newClientModal" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeNewClientModal()">×</button>
        <div class="modal-icon">
            <svg class="svg-icon" viewBox="0 0 24 24">
                <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </svg>
        </div>
        <h5 class="modal-title">Nouveau client détecté</h5>
        <p id="newClientMessage" class="modal-text">Un nouveau client va être créé automatiquement.</p>
        <div style="display:flex; gap:15px; justify-content:center;">
            <button class="btn-cancel" onclick="closeNewClientModal()">Annuler</button>
            <button class="modal-button" onclick="confirmNewClient()">Continuer</button>
        </div>
    </div>
</div>

<!-- Modal d'actions proforma -->
<div class="modal-backdrop" id="proformaActionModal" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeProformaActionModal()">×</button>
        <div class="modal-icon">
            <svg class="svg-icon" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
        </div>
        <h5 class="modal-title">Actions proforma</h5>
        <p id="proformaActionModalTitle" class="modal-text"></p>
        <div id="action-buttons" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
        
        <button class="btn-action-rose" onclick="showDetailsFromActionModal()" id="btn-details-action-modal">
            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </svg>
            Détails
        </button>


            <button class="btn-action-rose" onclick="downloadProformaFromModal()">
                <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Télécharger
            </button>

            <button class="btn-action-rose" onclick="editProformaFromModal()">
                <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                Modifier
            </button>
            <button class="modal-button" onclick="deleteProformaFromModal()">
                <svg style="width: 16px; height: 16px; fill: white;" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                Supprimer
            </button>
        </div>
    </div>
</div>

<!-- Modal Télécharger Document -->
<div class="modal-backdrop" id="downloadModal" style="display: none;">
  <div class="modal-content">
        <button class="modal-close" onclick="closeDownloadModal()">×</button>
        <div class="modal-icon">
            <svg class="svg-icon" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
        </div>
        <h5 class="modal-title">Télécharger Document</h5>
        <p class="modal-text" id="download-intro">
            Quel type de document souhaitez-vous télécharger ?
        </p>
        <div id="download-options">
            <!-- Options générées dynamiquement selon le statut -->
        </div>
    </div>
</div>

<!-- Modal Modifier Statut avec livraison partielle AMÉLIORÉ -->
<div class="modal-backdrop" id="statusModal" style="display: none;">
    <div class="modal-content" style="width: 800px; max-width: 95%;">
        <button class="modal-close" onclick="closeStatusModal()">×</button>
        <div class="modal-icon">
        <svg class="svg-icon" viewBox="0 0 24 24">
            <path d="M12 8v5l4.28 2.54 1-1.64-3.72-2.23V8z"/>
        </svg>
        </div>
        <h5 class="modal-title" id="statusModalTitle">Modifier le statut</h5>
        <div class="modal-text">
            <div class="form-group" id="status-actions-wrapper">
                <!-- Rangée de boutons d'action -->
                <div class="status-actions" id="status-actions" role="group" aria-label="Choisir un statut">
                    <button type="button" class="status-btn" data-status="en_attente" title="Passer à En attente">
                    <span class="status-btn__icon">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M6 2h12v2H6V2zm10 4H8v9l4 2 4-2V6z"/></svg>
                    </span><span class="status-btn__label">En attente</span>
                    </button>
                    <button type="button" class="status-btn" data-status="en_cours" title="Passer à En cours">
                    <span class="status-btn__icon">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm4 0h14v-2H7v2z"/></svg>
                    </span><span class="status-btn__label">En cours</span>
                    </button>
                    <button type="button" class="status-btn" data-status="partiel" title="Passer à Partiel">
                    <span class="status-btn__icon">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M3 5h18v4H3V5zm0 10h10v4H3v-4z"/></svg>
                    </span><span class="status-btn__label">Partiel</span>
                    </button>
                    <button type="button" class="status-btn" data-status="termine" title="Passer à Terminé">
                    <span class="status-btn__icon">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20 8l-1.4-1.4z"/></svg>
                    </span><span class="status-btn__label">Terminé</span>
                    </button>
                </div>
            </div>
            
            <!-- SECTION LIVRAISON PARTIELLE AMÉLIORÉE -->
            <div id="partialDeliverySection" style="display: none; margin-top: 20px;">
                <h6 style="color: #d81b60; margin-bottom: 15px;">Gestion de la livraison partielle</h6>
            
                <!-- Formulaire adaptatif selon le type de prestation -->
                <div id="partialDeliveryForm">
                    <!-- Pour Service/Formation : Formulaire simple -->
                    <div id="serviceForm" style="display: none;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><strong>Total proforma:</strong></span>
                                <span id="total-proforma-service">0 FCFA</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><strong>Versements déjà reçus:</strong></span>
                                <span id="versements-cumules">0 FCFA</span>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="nouveau-versement">Nouveau versement:</label>
                                <input type="number" id="nouveau-versement" class="form-control" value="0" min="0" placeholder="Montant reçu" />
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; color: #d81b60;">
                                <span>Reste à payer:</span>
                                <span id="reste-service">0 FCFA</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pour Livres/Fournitures : Formulaire avec articles -->
                    <div id="articleForm" style="display: none;">
                        <h6 style="color: #666; margin-bottom: 10px;">Sélection des articles à livrer</h6>
                        
                        <!-- Liste des articles avec sélection -->
                        <div id="partialDeliveryItems" style="max-height: 250px; border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-bottom: 15px; background: white;">
                            <!-- Articles générés dynamiquement -->
                        </div>

                        <!-- Résumé financier -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><strong>Total proforma:</strong></span>
                                <span id="total-proforma-article">0 FCFA</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><strong>Montant sélectionné:</strong></span>
                                <span id="montant-selectionne-display">0 FCFA</span>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="montant-recu">Montant reçu (optionnel):</label>
                                <input type="number" id="montant-recu" class="form-control" value="0" min="0" placeholder="Montant perçu après livraison" />
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; color: #d81b60;">
                                <span>Reste à payer:</span>
                                <span id="reste-a-payer">0 FCFA</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="delivery-comment">Commentaire sur la livraison:</label>
                    <textarea id="delivery-comment" class="form-control" rows="3" placeholder="Précisions sur la livraison partielle..."></textarea>
                </div>
            </div>
        </div>
        <div id="partial-footer" style="display:none; gap:15px; justify-content:center; margin-top:20px;">
            <button class="btn-cancel" onclick="closeStatusModal()">Annuler</button>
            <button class="modal-button" id="partialValidateBtn">Valider la livraison partielle</button>
        </div>

        <!-- Modal de confirmation du changement de statut -->
        <div class="modal-backdrop" id="statusConfirmModal" style="display:none;">
            <div class="modal-content" style="max-width:520px;">
                <button class="modal-close" onclick="closeStatusConfirmModal()">×</button>
                <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 8v5l4.28 2.54 1-1.64-3.72-2.23V8z"/></svg>
                </div>
                <h5 class="modal-title">Confirmer le changement</h5>
                <p class="modal-text" id="statusConfirmText">Confirmer le passage au nouveau statut ?</p>
                <div style="display:flex;gap:15px;justify-content:center;">
                <button class="btn-cancel" onclick="closeStatusConfirmModal()">Annuler</button>
                <button class="modal-button" id="statusConfirmBtn" onclick="confirmStatusChange()">Confirmer</button>
             </div>
        </div>
</div>
    </div>
</div>



<!-- Modal Supprimer -->
<div class="modal-backdrop" id="deleteModal" style="display: none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeDeleteModal()">×</button>
        <div class="modal-icon">
            <svg class="svg-icon" viewBox="0 0 24 24">
                <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
            </svg>
        </div>
        <h5 class="modal-title">Supprimer la proforma</h5>
        <p class="modal-text">Êtes-vous sûr de vouloir supprimer cette proforma ? Cette action est irréversible.</p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn-cancel" onclick="closeDeleteModal()">Annuler</button>
            <button class="modal-button" onclick="confirmDeleteProforma()">Supprimer</button>
        </div>
    </div>
</div>

<!-- Modal Confirmation Success -->
<div class="modal-backdrop" id="successModal" style="display: none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeSuccessModal()">×</button>
        <div class="modal-icon">
            <svg class="svg-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
        </div>
        <h5 class="modal-title" id="successTitle">Action réussie</h5>
        <p class="modal-text" id="successMessage">L'action s'est déroulée avec succès.</p>
        <button class="modal-button" onclick="closeSuccessModal()">OK</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/decimal.js@10.3.1/decimal.min.js"></script>
<script>
    // Variables globales
    let iti = null;
    let isEditMode = false;
    let currentProformaId = null;
    let currentPage = 1;
    let totalPages = 1;
    let pendingProformaData = null; // Variable globale pour stocker les données en attente
    let caFacturesChart = null;

    // Fonctions globales pour les modales d'actions proforma
    let currentModalProformaId = null;
    let currentModalProformaStatus = null;

    // Variables globales pour gestion partielle
    let currentProformaData = null;
    let selectedArticles = [];


    // Variables pour les données du backend avec valeurs par défaut
    const availableYears = {{ available_years|default([])|tojson }};
    const selectedYear = {{ selected_year|default(2025)|tojson }};
    const chartLabels = {{ chart_labels|default([])|tojson }};
    const chartValues = {{ chart_values|default([])|tojson }};
    const hasChartData = {{ has_chart_data|default(false)|tojson }};
    const classesLivres = {{ classes_livres|default([])|tojson }};
    const formations = {{ formations|default([])|tojson }};
    const villesFournitures = {{ villes_fournitures|default([])|tojson }};
    const naturesDisponibles = {{ natures_disponibles|default([])|tojson }};


    // ===== INITIALISATION GLOBALE UNIFIÉE =====
    document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 DOM Content Loaded - Starting unified initialization...");
        
        try {
            // 1. Initialiser le graphique CA/Factures
            initCAFacturesChart();
            
            // 2. Initialiser les composants de l'application
            initializePhoneInput();
            initializeEventListeners();
            initializePagination();
            
            // 3. Lier les événements de changement de statut
            bindStatusChangeEvents();
            
            // 4. Mise à jour des tendances KPI
            updateKPITrends();
            
            // 5. Vérifier les statuts au chargement (optionnel)
            verifyStatusesOnPageLoad();
            
            // 6. Appliquer les filtres initiaux (masquer les commandes terminées)
            handleFilters();
            
            // 7. Forcer le rechargement des proformas si le tableau est vide
            setTimeout(() => {
                const tbody = document.getElementById('proforma-tbody');
                if (tbody && tbody.children.length === 0) {
                    console.log("🔄 Tableau vide détecté, rechargement des proformas...");
                    if (typeof loadProformas === 'function') {
                        loadProformas();
                    } else if (typeof filterProformas === 'function') {
                        filterProformas();
                    } else {
                        console.log("🔄 Rechargement de la page...");
                        window.location.reload();
                    }
                }
            }, 1000);
            
            // 7. Gestion du formulaire proforma
            const proformaForm = document.getElementById("proforma-form");
            if (proformaForm) {
                console.log("✅ Form found, binding submit event...");
                proformaForm.addEventListener("submit", handleProformaSubmit);
            } else {
                console.log("ℹ️ Proforma form not found (normal if not on form page)");
            }
            
            // 8. Délégation d'événements globaux
            setupEventDelegation();
            
            // 9. Vérifier les paramètres d'URL pour afficher le message de succès
            if (typeof window.checkStatusUpdateSuccess === 'function') {
              window.checkStatusUpdateSuccess();
            }
            
            console.log("✅ Unified initialization completed successfully");
            
        } catch (error) {
            console.error("❌ CRITICAL ERROR during initialization:", error);
        }
    });


    // ===== DÉLÉGATION D'ÉVÉNEMENTS GLOBAUX =====
    function setupEventDelegation() {
        document.addEventListener('click', function(e) {
            console.log("✅ Event delegation active:", e.target.id || e.target.className);

    // Fonction pour vérifier et afficher le message de succès de mise à jour de statut
    function checkStatusUpdateSuccess() {
        const urlParams = new URLSearchParams(window.location.search);
        const statusUpdated = urlParams.get('status_updated');
        const success = urlParams.get('success');
        
        if (success === 'true' && statusUpdated) {
            // Afficher le message de succès
            showSuccessMessage(`Statut mis à jour vers "${getStatusText(statusUpdated)}"`);
            
            // Nettoyer l'URL en supprimant les paramètres
            const cleanUrl = new URL(window.location);
            cleanUrl.searchParams.delete('status_updated');
            cleanUrl.searchParams.delete('success');
            window.history.replaceState({}, document.title, cleanUrl.pathname + cleanUrl.search);
        }
    }

            // Nouvelle Proforma
            if (e.target && e.target.id === 'new-invoice-btn') {
                e.preventDefault();
                openNewProformaForm();
                return;
            }

            // Export
            if (e.target && e.target.id === 'export-btn') {
                e.preventDefault();
                exportProformas();
                return;
            }



            // Ligne proforma clickée (éviter double événement avec badge)
            const row = e.target.closest('tr[data-proforma-id]');
            if (row && !e.target.closest('.status-badge')) { 
                e.preventDefault();
                const proformaId = row.dataset.proformaId;
                const status = row.dataset.status;
                const numero = row.cells[0].textContent.trim();
                
                console.log("🎯 Row clicked - ID:", proformaId, "Status:", status, "Numero:", numero);
                
                if (proformaId && proformaId !== 'undefined' && proformaId !== 'null' && proformaId.trim() !== '') {
                    openProformaActionModal(proformaId, numero, status);
                } else {
                    console.error("❌ Invalid proforma ID in row:", proformaId);
                    alert("Erreur: ID proforma invalide");
                }
                return;
            }
            
            // Fermer Slide-over
            if (e.target && e.target.id === 'slide-over-close') {
                e.preventDefault();
                closeSlideOver();
                return;
            }
        });
    }

    // Initialiser le champ téléphone
    function initializePhoneInput() {
        const phoneInput = document.getElementById("phone");
        if (phoneInput) {
            iti = window.intlTelInput(phoneInput, {
                initialCountry: "cm",
                separateDialCode: true,
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                formatOnDisplay: true,
                nationalMode: false,
                autoHideDialCode: false,
                autoPlaceholder: "polite",
            });
            console.log("✅ Phone input initialized");
        }
    } 

    // ===== GRAPHIQUE CA/FACTURES =====
    function initCAFacturesChart() {
        console.log("📊 Initializing CA/Factures chart...");

        fetch('/api/dashboard/ca-factures-evolution')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("📊 CA/Factures data received:", data);
                if (data.success && data.has_data && data.labels && data.labels.length > 0) {
                    createCAFacturesChart(data);
                } else {
                    console.log("⚠️ No chart data available");
                    showCAFacturesNoData();
                }
            })
            .catch(error => {
                console.error('❌ Error loading CA/Factures data:', error);
                showCAFacturesNoData();
            });
    }

    function createCAFacturesChart(data) {
        console.log("🔍 Creating CA/Factures chart with data:", data);
        
        const canvas = document.getElementById('caFacturesChart');
        const noDataDiv = document.getElementById('caFacturesChartNoData');
        
        if (!canvas) {
            console.error("❌ Canvas 'caFacturesChart' not found!");
            return;
        }
        
        // MODIFICATION: Toujours afficher le graphique même si has_data est false
        if (noDataDiv) noDataDiv.style.display = 'none';
        canvas.style.display = 'block';
        
        const ctx = canvas.getContext('2d');
        
        if (caFacturesChart) {
            caFacturesChart.destroy();
            caFacturesChart = null;
        }
        
        const maxFactures = Math.max(...data.nb_factures.filter(val => val !== 0), 1);
        const maxCA = Math.max(...data.ca_montants.filter(val => val !== 0), 1000);
        
        // Création du sous-titre
        const firstMonth = data.labels[0];
        const lastMonth = data.labels[data.labels.length - 1];
        const subtitleText = `12 mois (${firstMonth} - ${lastMonth})`;

        caFacturesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Nombre de factures',
                        data: data.nb_factures,
                        backgroundColor: 'rgba(216, 27, 96, 0.7)',
                        borderColor: '#d81b60',
                        borderWidth: 2,
                        yAxisID: 'y-factures',
                        type: 'bar'
                    },
                    {
                        label: 'Chiffre d\'affaires (FCFA)',
                        data: data.ca_montants,
                        backgroundColor: 'rgba(255, 138, 128, 0.2)',
                        borderColor: '#ff8a80',
                        borderWidth: 3,
                        yAxisID: 'y-ca',
                        type: 'line',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 15,
                            padding: 20,
                            font: { size: 12, weight: '500' }
                        }
                    },
                    title: {
                        display: true,
                        text: subtitleText,
                        font: { size: 14, weight: 'normal' },
                        color: '#666',
                        padding: { bottom: 20 }
                    }
                },
                scales: {
                    'y-factures': {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Nombre de factures',
                            font: { size: 12, weight: '500' },
                            color: '#666'
                        },
                        min: 0,
                        max: Math.max(5, Math.ceil(maxFactures * 1.3)),
                        ticks: {
                            stepSize: Math.max(1, Math.ceil(maxFactures / 5)),
                            font: { size: 10 },
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    'y-ca': {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Chiffre d\'affaires (FCFA)',
                            font: { size: 12, weight: '500' },
                            color: '#666'
                        },
                        min: 0,
                        max: Math.max(1000, Math.ceil(maxCA * 1.3)),
                        ticks: {
                            font: { size: 10 },
                            color: '#666',
                            callback: function(value) {
                                return value.toLocaleString('fr-FR');
                            }
                        },
                        grid: { 
                            drawOnChartArea: false,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 10 },
                            color: '#666',
                            autoSkip: false
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });
        
        console.log("✅ CA/Factures chart created successfully");
    }

    function showCAFacturesNoData() {
        const canvas = document.getElementById('caFacturesChart');
        const noDataDiv = document.getElementById('caFacturesChartNoData');

        if (canvas) canvas.style.display = 'none';
        if (noDataDiv) {
            noDataDiv.style.display = 'flex';
            noDataDiv.innerHTML = 'AUCUNE DONNÉE DISPONIBLE';
            noDataDiv.style.alignItems = 'center';
            noDataDiv.style.justifyContent = 'center';
            noDataDiv.style.height = '300px';
            noDataDiv.style.fontSize = '16px';
            noDataDiv.style.color = '#666';
            noDataDiv.style.fontWeight = '500';
        }
        console.log("📊 No data message displayed");
    }   

    function showDetailsFromActionModal() {
        if (currentProformaId) {
            showProformaDetails(currentProformaId);
        } else {
            alert("ID proforma non défini.");
        }
    }
    window.showDetailsFromActionModal = showDetailsFromActionModal;

    // Appels d'initialisation
    initCAFacturesChart(); //

    function showDetailsFromActionModal() {
        if (currentProformaId) {
            showProformaDetails(currentProformaId);
        } else {
            alert("ID proforma non défini.");
        }
    }
    window.showDetailsFromActionModal = showDetailsFromActionModal;

    function bindActionButtons() {
        const addArticleBtn = document.getElementById("add-article-btn");
        const addFeeBtn = document.getElementById("add-fee-btn");
        
        if (addArticleBtn) {
            addArticleBtn.replaceWith(addArticleBtn.cloneNode(true));
            const freshArticleBtn = document.getElementById("add-article-btn");
            if (freshArticleBtn) {
                freshArticleBtn.onclick = function(e) {
                    e.preventDefault();
                    addPrestationRow();
                };
            }
        }
        
        if (addFeeBtn) {
            addFeeBtn.replaceWith(addFeeBtn.cloneNode(true));
            const freshFeeBtn = document.getElementById("add-fee-btn");
            if (freshFeeBtn) {
                freshFeeBtn.onclick = function(e) {
                    e.preventDefault();
                    addSupplementaryFeeRow();
                };
            }
        }
    }

    function showProformaDetails(proformaId) {
        // Ferme le modal "Actions proforma"
        document.getElementById("proformaActionModal").style.display = "none";
        
        fetch(`/api/proforma/${proformaId}/details`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Adapter les données pour la fonction displayProformaDetails
                    const proforma = {
                        client_nom: data.proforma.client.nom,
                        client_telephone: data.proforma.client.telephone,
                        client_adresse: data.proforma.client.adresse,
                        total_ttc: data.proforma.total_ttc,
                        sous_total: data.proforma.sous_total,
                        remise: data.proforma.remise_montant || 0,
                        frais: data.proforma.frais_total || 0,
                        etat: data.proforma.etat || 'en_attente'
                    };
                    
                    const articles = data.proforma.articles || [];
                    
                    displayProformaDetails(proforma, articles);
                    document.getElementById('detailsModal').style.display = 'flex';
                } else {
                    alert('Erreur lors du chargement des détails: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des détails: Erreur lors de la récupération des détails');
            });
    }

    function closeDetailsModal() {
        const modal = document.getElementById("detailsModal");
        if (modal) {
            modal.style.display = "none";
        }
    }

    // Fonction pour formater les montants en devise
    function formatCurrency(amount) {
        if (!amount || amount === 0) return '0 FCFA';
        return `${parseInt(amount).toLocaleString('fr-FR')} FCFA`;
    }

    // Fonction d'affichage des détails adaptée aux types (manuels, fourniture, service, formation)
    function displayProformaDetails(proforma, articles) {
        const content = document.getElementById('proformaDetailsContent');
        
        // Déterminer le type de prestation
        const hasFormation = articles.some(article => 
            article.type_article && article.type_article.toLowerCase().includes('formation')
        );
        const hasService = articles.some(article => 
            article.type_article && (
                article.type_article.toLowerCase().includes('service') ||
                article.type_article.toLowerCase().includes('mission')
            )
        );
        const hasManuel = articles.some(article => 
            article.type_article && article.type_article.toLowerCase().includes('manuel')
        );
        const hasFourniture = articles.some(article => 
            article.type_article && article.type_article.toLowerCase().includes('fourniture')
        );
        const hasMixed = hasFormation && hasService;
        
        let html = `
            <div style="text-align: left;">
                <h6>Informations Client</h6>
                <p><strong>Nom:</strong> ${proforma.client_nom}</p>
                <p><strong>Téléphone:</strong> ${proforma.client_telephone || 'Non renseigné'}</p>
                <p><strong>Adresse:</strong> ${proforma.client_adresse || 'Non renseigné'}</p>
                
                <h6 style="margin-top: 20px;">Prestation</h6>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 8px; border: 1px solid #ddd;">Type</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Désignation</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">${hasMixed ? 'Quantité/Durée' : (hasFormation ? 'Nombre d\'heures' : (hasService ? 'Nombre de jours' : 'Quantité'))}</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">${hasMixed ? 'Prix unitaire' : (hasFormation ? 'Prix par heure' : (hasService ? 'Prix par jour' : 'Prix'))}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        articles.forEach(article => {
            // Déterminer le type de cet article spécifique
            const isFormation = article.type_article && article.type_article.toLowerCase().includes('formation');
            const isService = article.type_article && (
                article.type_article.toLowerCase().includes('service') ||
                article.type_article.toLowerCase().includes('mission')
            );
            
            // Pour les commandes partielles, afficher les quantités livrées
            const isPartial = proforma.etat === 'partiel';
            const quantiteToShow = isPartial && article.quantite_livree > 0 ? article.quantite_livree : article.quantite;
            const statutLivraison = article.statut_livraison || 'non_livré';
            
            // Ajouter une indication dans la colonne quantité si c'est un mélange
            let quantiteDisplay = quantiteToShow;
            if (hasMixed) {
                if (isFormation) {
                    quantiteDisplay = `${quantiteToShow} h`;
                } else if (isService) {
                    quantiteDisplay = `${quantiteToShow} j`;
                } else {
                    quantiteDisplay = `${quantiteToShow} u`;
                }
            }
            
            // Ajouter une indication de statut de livraison pour les commandes partielles
            let statusIndicator = '';
            if (isPartial) {
                if (statutLivraison === 'livré') {
                    statusIndicator = ' <span style="color: #28a745; font-weight: bold;">✓ Livré</span>';
                } else if (statutLivraison === 'partiel') {
                    statusIndicator = ' <span style="color: #ffc107; font-weight: bold;">⚠ Partiel</span>';
                } else {
                    statusIndicator = ' <span style="color: #dc3545; font-weight: bold;">✗ Non livré</span>';
                }
            }
            
            html += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${article.type_article || 'N/A'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${article.designation}${statusIndicator}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${quantiteDisplay}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${formatCurrency(article.prix)}</td>
                </tr>
            `;
        });
    
        // Vérifier si on a des articles ou si c'est une ancienne proforma
        if (articles.length === 0) {
            // Affichage minimaliste pour les anciennes proformas sans articles
            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #d81b60;">
                    <h6 style="margin: 0 0 10px 0; color: #d81b60;">Ancienne Commande</h6>
                    <p style="margin: 0; color: #666; font-size: 14px;">
                        Cette commande provient de l'ancien système et ne contient pas de détails d'articles.
                        <br>Le montant total est de <strong>${formatCurrency(proforma.total_ttc || proforma.sous_total || 0)}</strong>.
                    </p>
                </div>
            `;
        } else {
            // Calculer les totaux - pour les commandes partielles, utiliser les quantités livrées
            const isPartial = proforma.etat === 'partiel';
            const sousTotal = articles.reduce((sum, article) => {
                const quantiteToUse = isPartial && article.quantite_livree > 0 ? article.quantite_livree : article.quantite;
                return sum + (article.prix * quantiteToUse);
            }, 0);
            const remise = proforma.remise || 0;
            const frais = proforma.frais || 0;
            const totalTTC = sousTotal + frais - remise;
            
            html += `
                    </tbody>
                </table>
                
                <h6 style="margin-top: 20px;">Résumé Financier</h6>
                <div style="margin-top: 10px; text-align: left;">
                    ${isPartial ? '<p style="color: #ffc107; font-weight: bold; margin-bottom: 10px;">⚠ Commande partielle - Montants basés sur les articles livrés</p>' : ''}
                    <p><strong>Sous-total:</strong> ${formatCurrency(sousTotal)}</p>
                    <p><strong>Remise:</strong> ${formatCurrency(remise)}</p>
                    <p><strong>Frais supplémentaires:</strong> ${formatCurrency(frais)}</p>
                    <p style="font-size: 1.1rem; font-weight: bold; margin-top: 10px;">
                        <strong>Total TTC:</strong> ${formatCurrency(totalTTC)}
                    </p>
                </div>
            `;
        }
        
        // Ajouter le résumé financier pour les anciennes proformas aussi
        if (articles.length === 0) {
            const totalTTC = proforma.total_ttc || proforma.sous_total || 0;
            html += `
                <h6 style="margin-top: 20px;">Résumé Financier</h6>
                <div style="margin-top: 10px; text-align: left;">
                    <p style="font-size: 1.1rem; font-weight: bold;">
                        <strong>Total TTC:</strong> ${formatCurrency(totalTTC)}
                    </p>
                </div>
            `;
        }
        
        html += `
            </div>
        `;
        
        content.innerHTML = html;
    }

    window.showProformaDetails = showProformaDetails;
    window.closeDetailsModal = closeDetailsModal;

    function initializeEventListeners() {
        console.log("🔧 Initializing event listeners...");
        
        // Fermer slide-over
        const slideOverClose = document.getElementById("slide-over-close");
        if (slideOverClose) {
            slideOverClose.addEventListener("click", function(e) {
                e.preventDefault();
                closeSlideOver();
            });
        }
        
        // Filtres avec KPI dynamiques
        const statusFilter = document.getElementById("status-filter");
        if (statusFilter) {
            statusFilter.addEventListener("change", handleFilters);
        }
        
        // Recherche textuelle
        const searchInput = document.getElementById("searchProformasInput");
        if (searchInput) {
            searchInput.addEventListener("input", handleFilters);
        }
        
        // Auto-complétion client
        const phoneInput = document.getElementById("phone");
        if (phoneInput) {
            phoneInput.addEventListener("blur", checkExistingClient);
            phoneInput.addEventListener("input", debounceCheckClient);
        }
        
        // Remise - calcul automatique
        const remiseInput = document.getElementById("remise");
        if (remiseInput) {
            remiseInput.addEventListener("input", function() {
                validateRemise(this);
                updateCalculations();
            });
        }
        
        console.log("✅ Event listeners initialized");
    }


    // Fonction pour changer le statut d'une proforma avec validation et persistance
    function changeProformaStatus(event, proformaId, currentStatus) {
        event.stopPropagation();
        
        console.log("🔄 Changing status for proforma:", proformaId, "from:", currentStatus);
        
        // Validation stricte de l'ID proforma
        if (!proformaId || proformaId === 'undefined' || proformaId === 'null' || proformaId.toString().trim() === '') {
            console.error("❌ ID proforma invalide:", proformaId);
            alert("Erreur: ID proforma invalide");
            return;
        }
        
        // Validation du statut actuel
        const validStatuses = ['en_attente', 'en_cours', 'partiel', 'termine'];
        if (!validStatuses.includes(currentStatus)) {
            console.error("❌ Statut actuel invalide:", currentStatus);
            currentStatus = 'en_attente'; // Fallback
        }
        
        // Stocker les données globalement pour utilisation dans le modal
        currentProformaId = proformaId.toString();
        currentProformaStatus = currentStatus;
        
        // FERMER LE MODAL D'ACTION AVANT D'OUVRIR LE MODAL DE STATUT
        const actionModal = document.getElementById('proformaActionModal');
        if (actionModal && actionModal.style.display === 'flex') {
            actionModal.style.display = 'none';
            console.log("✅ Modal d'action fermé avant ouverture du modal de statut");
        }
        
        console.log("🔄 Opening status action modal with ID:", currentProformaId, "Current status:", currentProformaStatus);
        
        // Ouvrir le modal d'action de statut avec les mêmes dimensions que le modal d'action
        showStatusActionModal(proformaId, currentStatus);
    }

function showStatusActionModal(proformaId, currentStatus){
  console.log("🎯 Opening status action modal for:", proformaId, "current status:", currentStatus);
  
  // Créer ou récupérer le modal d'action de statut
  let statusActionModal = document.getElementById('statusActionModal');
  
  // Si le modal n'existe pas, le créer
  if (!statusActionModal) {
    statusActionModal = document.createElement('div');
    statusActionModal.id = 'statusActionModal';
    statusActionModal.className = 'modal-backdrop';
    statusActionModal.style.display = 'none';
    document.body.appendChild(statusActionModal);
  }
  
  // Contenu du modal avec les mêmes dimensions que le modal d'action
  statusActionModal.innerHTML = `
    <div class="modal-content">
      <button class="modal-close" onclick="closeStatusActionModal()">×</button>
      <div class="modal-icon">
        <svg class="svg-icon" viewBox="0 0 24 24">
          <path d="M12 8v5l4.28 2.54 1-1.64-3.72-2.23V8z"/>
        </svg>
      </div>
      <h5 class="modal-title">Changer le statut de "${getStatusText(currentStatus)}" vers :</h5>
      <div class="modal-text">
        <div id="status-action-buttons" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
          <button class="btn-action-rose" onclick="selectStatus('en_attente')" data-status="en_attente">
            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
              <path d="M6 2h12v2H6V2zm10 4H8v9l4 2 4-2V6z"/>
            </svg>
            En attente
          </button>
          <button class="btn-action-rose" onclick="selectStatus('en_cours')" data-status="en_cours">
            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
              <path d="M3 13h2v-2H3v2zm4 0h14v-2H7v2z"/>
            </svg>
            En cours
          </button>
          <button class="btn-action-rose" onclick="selectStatus('partiel')" data-status="partiel">
            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
              <path d="M3 5h18v4H3V5zm0 10h10v4H3v-4z"/>
            </svg>
            Partiel
          </button>
          <button class="btn-action-rose" onclick="selectStatus('termine')" data-status="termine">
            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
              <path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20 8l-1.4-1.4z"/>
            </svg>
            Terminé
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Désactiver le bouton du statut actuel
  setTimeout(() => {
    const buttons = statusActionModal.querySelectorAll('.btn-action-rose');
    buttons.forEach(button => {
      const buttonStatus = button.getAttribute('data-status');
      if (buttonStatus === currentStatus) {
        button.disabled = true;
        button.style.opacity = '0.5';
        button.style.cursor = 'not-allowed';
      }
    });
  }, 100);
  
  // Afficher le modal
  statusActionModal.style.display = 'flex';
  currentProformaId = proformaId;
  currentProformaStatus = currentStatus;
}

function closeStatusActionModal() {
  const modal = document.getElementById('statusActionModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

async function selectStatus(newStatus) {
  console.log("🎯 Status selected:", newStatus, "for proforma:", currentProformaId);
  
  // Si c'est le statut partiel, utiliser la logique existante
  if (newStatus === 'partiel') {
    console.log("📦 Opening partial delivery modal for proforma:", currentProformaId);
    closeStatusActionModal();
    openPartialDeliveryModal(currentProformaId);
    return;
  }
  
  // Pour les autres statuts (En attente, En cours, Terminé) : mise à jour directe
  console.log("🚀 Mise à jour directe du statut:", newStatus);
  
  try {
    // Appel direct à l'API pour mettre à jour le statut
    const success = await updateProformaStatusWithAPI(currentProformaId, newStatus, '');
    
    if (success) {
      // Fermer le modal immédiatement
      closeStatusActionModal();
      
      // Recharger la page avec paramètre de succès
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('status_updated', newStatus);
      newUrl.searchParams.set('success', 'true');
      window.location.href = newUrl.toString();
      
    } else {
      // En cas d'erreur, afficher l'erreur
      alert('Erreur lors de la mise à jour du statut');
    }
    
  } catch (error) {
    console.error('❌ Error updating status:', error);
    alert('Erreur lors de la mise à jour du statut');
  }
}


    // Mise à jour avec appel API
    function updateProformaStatusWithAPI(proformaId, newStatus, commentaire = '') {
        console.log(`🚀 Updating status API: ${proformaId} -> ${newStatus}`);
        
        // CORRECTION: Retourner la promesse pour permettre le chaînage
        return fetch(`/api/proforma/${proformaId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                statut: newStatus,
                commentaire: commentaire 
            })
        })
        .then(response => {
            console.log(`📡 API Response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`📡 API Response data:`, data);
            
            if (data.success) {
                console.log(`✅ Status successfully persisted in database: ${proformaId} -> ${newStatus}`);
                
                // Afficher message de succès
                showSuccessMessage(`Statut mis à jour vers "${getStatusText(newStatus)}"`);
                
                return true; // CORRECTION: Retourner true pour indiquer le succès
            } else {
                console.error('❌ API returned error:', data.message);
                alert('Erreur lors de la mise à jour du statut: ' + data.message);
                return false;
            }
        })
        .catch(error => {
            console.error('❌ Network error:', error);
            alert('Erreur réseau lors de la mise à jour du statut');
            return false;
        });
    }

    function updateProformaStatusVisual(proformaId, newStatus) {
        console.log(`🔍 updateProformaStatusVisual appelée pour ID=${proformaId}, statut=${newStatus}`);
        
        // Validation des paramètres d'entrée
        if (!proformaId || !newStatus) {
            console.error(`❌ Paramètres manquants: ID=${proformaId}, statut=${newStatus}`);
            return false;
        }
        
        // Conversion de l'ID en string pour éviter les problèmes de typage
        const proformaIdStr = proformaId.toString();
        
        // Validation du statut
        const validStatuses = ['en_attente', 'en_cours', 'partiel', 'termine'];
        if (!validStatuses.includes(newStatus)) {
            console.error(`❌ Statut invalide: ${newStatus}`);
            return false;
        }
        
        // Recherche multiple de la ligne dans le tableau pour plus de robustesse
        let row = document.querySelector(`tr[data-proforma-id="${proformaIdStr}"]`);
        
        // Si pas trouvé, essayer sans guillemets ou avec conversion numérique
        if (!row) {
            row = document.querySelector(`tr[data-proforma-id='${proformaIdStr}']`);
        }
        if (!row) {
            // Chercher dans toutes les lignes manuellement
            const allRows = document.querySelectorAll('tr[data-proforma-id]');
            row = Array.from(allRows).find(r => 
                r.dataset.proformaId == proformaIdStr || 
                r.getAttribute('data-proforma-id') == proformaIdStr
            );
        }
        
        if (!row) {
            console.error(`❌ Ligne non trouvée pour proforma ID: ${proformaIdStr}`);
            const allRows = document.querySelectorAll('tr[data-proforma-id]');
            console.log(`🔍 Lignes disponibles:`, Array.from(allRows).map(r => ({
                id: r.dataset.proformaId,
                attr: r.getAttribute('data-proforma-id')
            })));
            return false;
        }

        // Mise à jour des attributs de la ligne
        row.setAttribute("data-status", newStatus);
        row.dataset.status = newStatus;
        
        // Mise à jour de l'onclick de la ligne
        const numeroProforma = row.cells[0] ? row.cells[0].textContent.trim() : `PRO${proformaIdStr.padStart(5, '0')}`;
        row.setAttribute("onclick", `openProformaActionModal('${proformaIdStr}', '${numeroProforma}', '${newStatus}')`);

        // Mise à jour du badge de statut dans le tableau
        const statusBadge = row.querySelector('.status-badge');
        if (statusBadge) {
            // Mettre à jour les classes CSS
            statusBadge.className = `status-badge status-${newStatus}`;
            
            // Mettre à jour le texte
            const statusTexts = {
                'en_attente': 'En attente',
                'en_cours': 'En cours',
                'partiel': 'Partielle',
                'termine': 'Terminé'
            };
            statusBadge.textContent = statusTexts[newStatus] || newStatus;
            
            // Mettre à jour l'attribut onclick
            statusBadge.setAttribute('onclick', `changeProformaStatus(event, '${proformaIdStr}', '${newStatus}')`);
            
            // Animation de mise à jour du badge
            statusBadge.style.transform = 'scale(1.1)';
            statusBadge.style.transition = 'transform 0.2s ease';
            setTimeout(() => {
                statusBadge.style.transform = 'scale(1)';
            }, 200);
        }

        // Mise à jour des boutons de statut dans la ligne (si ils existent)
        const statusActions = row.querySelector('.status-actions');
        if (statusActions) {
            // Mettre à jour tous les boutons pour refléter le nouveau statut
            const buttons = statusActions.querySelectorAll('.status-btn');
            buttons.forEach(button => {
                const buttonStatus = button.getAttribute('data-status');
                
                // Mettre à jour l'onclick de chaque bouton
                button.setAttribute("onclick", `changeProformaStatus(event, '${proformaIdStr}', '${newStatus}')`);
                
                // Mettre à jour l'état actif/désactivé
                if (buttonStatus === newStatus) {
                    button.classList.add('status-btn--active');
                    button.disabled = true;
                } else {
                    button.classList.remove('status-btn--active');
                    button.disabled = false;
                }
            });
        }

        // Animation visuelle pour confirmer le changement
        if (statusActions) {
            statusActions.style.transform = 'scale(1.05)';
            statusActions.style.transition = 'transform 0.2s ease';
            statusActions.style.boxShadow = '0 0 10px rgba(216, 27, 96, 0.3)';
            
            setTimeout(() => {
                statusActions.style.transform = 'scale(1)';
                statusActions.style.boxShadow = '';
            }, 300);
        }

        console.log(`✅ Proforma ${proformaIdStr} mise à jour visuellement: -> ${newStatus}`);
        return true;
    }

    // Conversion statut -> texte
    function getStatusText(status) {
        const statusTexts = {
            'en_attente': 'En attente',
            'en_cours': 'En cours',
            'partiel': 'Partielle',
            'termine': 'Terminé'
        };
        return statusTexts[status] || status;
    }

    function showSuccessMessage(message) {
        // Supprimer les anciens toasts pour éviter l'accumulation
        document.querySelectorAll('.status-success-toast').forEach(oldToast => {
            if (oldToast.parentNode) {
                oldToast.remove();
            }
        });

        // Créer un nouveau toast de succès avec le dégradé rose de l'application
        const toast = document.createElement('div');
        toast.className = 'status-success-toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(216, 27, 96, 0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            max-width: 350px;
        `;
        
        // Icône de succès avec le style de l'application
        const icon = document.createElement('span');
        icon.innerHTML = '✓';
        icon.style.cssText = `
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        `;
        
        const textNode = document.createTextNode(message);
        
        toast.appendChild(icon);
        toast.appendChild(textNode);
        document.body.appendChild(toast);
        
        // Animation d'entrée
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        // Animation de sortie et suppression après 4 secondes
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 4000);
        
        console.log(`✅ Message de succès affiché: ${message}`);
    }


    // Fonction pour mettre à jour le statut visuellement et en base
    function updateProformaStatus(proformaId, newStatus) {
        // Mise à jour visuelle immédiate
        const row = document.querySelector(`tr[data-proforma-id="${proformaId}"]`);
        if (row) {
            const statusBadge = row.querySelector('.status-badge');
            
            // Mettre à jour les classes CSS
            statusBadge.className = `status-badge status-${newStatus}`;
            
            // Mettre à jour le texte
            const statusTexts = {
                'en_attente': 'En attente',
                'en_cours': 'En cours',
                'partiel': 'Partielle',
                'termine': 'Terminé'
            };
            statusBadge.textContent = statusTexts[newStatus];
            
            // Mettre à jour l'attribut onclick
            statusBadge.setAttribute('onclick', `changeProformaStatus(event, '${proformaId}', '${newStatus}')`);
            
            // Mettre à jour data-status pour les filtres
            row.setAttribute('data-status', newStatus);
        }
        
        // Appel API pour sauvegarder en base (simulé pour l'instant)
        console.log(`✅ Statut mis à jour: Proforma ${proformaId} -> ${newStatus}`);
        
        // TODO: Appel API réel
        // fetch(`/api/proforma/${proformaId}/status`, {
        //     method: 'PUT',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({ statut: newStatus })
        // });
    }


    function saveStatusChange() {
        const modal = document.getElementById("statusModal");
        const newStatusEl = document.getElementById("new-status-select");
        const commentaireEl = document.getElementById("delivery-comment");

        // Validation des éléments requis
        if (!newStatusEl || !newStatusEl.value) {
            alert("Veuillez sélectionner un nouveau statut");
            return;
        }
        
        const newStatus = newStatusEl.value;
        const commentaire = commentaireEl ? commentaireEl.value.trim() : '';
        
        // Validation stricte de l'ID proforma
        if (!currentProformaId || currentProformaId === 'undefined' || currentProformaId === 'null' || currentProformaId.toString().trim() === '') {
            alert("Erreur: ID proforma manquant ou invalide");
            console.error("❌ currentProformaId is invalid:", currentProformaId);
            return;
        }
        
        // Validation du nouveau statut  
        const validStatuses = ['en_attente', 'en_cours', 'partiel', 'termine'];
        if (!validStatuses.includes(newStatus)) {
            alert("Erreur: Statut sélectionné invalide");
            console.error("❌ Invalid new status:", newStatus);
            return;
        }
        
        console.log(`🔄 DÉBUT SAVESTATUSCHANGE: ${currentProformaId} -> ${newStatus}`);
        
        // Désactiver le bouton de sauvegarde pendant le traitement
        const saveButton = modal.querySelector('.modal-button');
        const originalButtonText = saveButton ? saveButton.textContent : '';
        if (saveButton) {
            saveButton.disabled = true;
            saveButton.textContent = 'Mise à jour...';
        }
        
        // Appel API avec gestion d'erreur renforcée
        fetch(`/api/proforma/${currentProformaId}/status`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 
                statut: newStatus,
                commentaire: commentaire 
            })
        })
        .then(response => {
            console.log(`📡 API Response status: ${response.status}, ok: ${response.ok}`);
            
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Proforma non trouvée');
                } else if (response.status === 400) {
                    throw new Error('Données invalides');
                } else if (response.status === 500) {
                    throw new Error('Erreur serveur');
                } else {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
            }
            return response.json();
        })
        .then(data => {
            console.log(`📡 API Response data:`, data);
            
            if (data.success) {
                console.log(`✅ Status successfully persisted: ${currentProformaId} -> ${newStatus}`);
                
                // Fermer le modal immédiatement
                closeStatusModal();
                
                // Mise à jour visuelle immédiate
                const updateSuccess = updateProformaStatusVisual(currentProformaId, newStatus);
                console.log(`🔍 Visual update success: ${updateSuccess}`);
                
                // Message de succès avec délai plus long pour voir le changement
                showSuccessMessage(`Statut mis à jour vers "${getStatusText(newStatus)}"`);
                
                // Vérification de persistance après 1 seconde au lieu de refresh immédiat
                setTimeout(async () => {
                    try {
                        const checkResponse = await fetch(`/api/proforma/${currentProformaId}/status-check`);
                        const checkData = await checkResponse.json();
                        
                        console.log(`🔍 Vérification post-update:`, checkData);
                        
                        if (checkData.success && checkData.etat === newStatus) {
                            console.log(`✅ Persistance confirmée: ${newStatus}`);
                            // Tout est OK, pas besoin de recharger
                        } else {
                            console.log(`⚠️ Incohérence détectée, rechargement nécessaire`);
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    } catch (verifyError) {
                        console.error(`❌ Erreur vérification:`, verifyError);
                        // En cas d'erreur de vérification, recharger par sécurité
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                }, 1000);
                
            } else {
                console.error('❌ API returned error:', data.message);
                alert('Erreur lors de la mise à jour du statut: ' + (data.message || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('❌ Network/API error in saveStatusChange:', error);
            alert('Erreur lors de la mise à jour: ' + error.message);
        })
        .finally(() => {
            // Réactiver le bouton de sauvegarde
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.textContent = originalButtonText || 'Enregistrer';
            }
        });
    }


    // Fonction de vérification des statuts au chargement de la page
    function verifyStatusesOnPageLoad() {
        console.log("🔍 Vérification des statuts au chargement de la page");
        
        const rows = document.querySelectorAll('tr[data-proforma-id]');
        console.log(`📊 ${rows.length} proformas trouvées dans le tableau`);
        
        rows.forEach(async (row, index) => {
            const proformaId = row.dataset.proformaId;
            const visualStatus = row.dataset.status;
            
            if (proformaId && proformaId !== 'undefined' && proformaId !== 'null') {
                try {
                    // Vérifier le statut réel en base avec un délai pour éviter la surcharge
                    setTimeout(async () => {
                        const response = await fetch(`/api/proforma/${proformaId}/status-check`);
                        const data = await response.json();
                        
                        if (data.success) {
                            const realStatus = data.etat;
                            
                            console.log(`🔍 Proforma ${proformaId}: Visual=${visualStatus}, Real=${realStatus}`);
                            
                            // Si incohérence détectée, corriger visuellement
                            if (visualStatus !== realStatus) {
                                console.log(`⚠️ Incohérence détectée pour proforma ${proformaId}, correction...`);
                                updateProformaStatusVisual(proformaId, realStatus);
                            }
                        }
                    }, index * 100); // Délai progressif pour éviter de surcharger le serveur
                    
                } catch (error) {
                    console.error(`❌ Erreur vérification proforma ${proformaId}:`, error);
                }
            }
        });
    }



function bindStatusChangeEvents() {
        console.log("🔗 Binding status change events...");
        
        const saveStatusBtn = document.getElementById('save-status-btn');
        if (saveStatusBtn) {
            saveStatusBtn.removeEventListener('click', window.saveStatusChange);
            saveStatusBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("🔄 Save status button clicked via event listener");
                window.saveStatusChange();
            });
            console.log("✅ Save status button event bound");
        }
    }

    // Ajouter cette fonction à l'initialisation
    function initializeApp() {
        console.log("🔧 Initializing complete app...");
        
        try {
            initializePhoneInput();
            initializeChart();
            initializeEventListeners();
            initializePagination();
            updateKPITrends();
            bindStatusChangeEvents(); // AJOUTER CETTE LIGNE
            
            console.log("✅ App initialization completed successfully");
        } catch (error) {
            console.error("❌ CRITICAL ERROR during initialization:", error);
        }
    }



    // Fonction pour télécharger les documents selon le statut
    window.downloadProformaFromModal = function() {
        console.log("📥 === DÉBUT DOWNLOADOPROFORMAFROMMODAL ===");
        
        // ✅ RÉCUPÉRATION SÉCURISÉE DE L'ID
        let proformaId = null;
        
        // Essayer plusieurs sources pour l'ID
        if (currentModalProformaId && currentModalProformaId !== 'null' && currentModalProformaId !== 'undefined') {
            proformaId = currentModalProformaId;
            console.log("✅ ID trouvé via currentModalProformaId:", proformaId);
        } else if (currentProformaId && currentProformaId !== 'null' && currentProformaId !== 'undefined') {
            proformaId = currentProformaId;
            console.log("✅ ID trouvé via currentProformaId:", proformaId);
        } else {
            console.error("❌ ERREUR CRITIQUE: Aucun ID proforma valide trouvé");
            console.log("   currentModalProformaId =", currentModalProformaId);
            console.log("   currentProformaId =", currentProformaId);
            alert("Erreur: Aucune proforma sélectionnée");
            return;
        }
        
        console.log("📥 ID final utilisé:", proformaId);
        
        // ✅ RÉCUPÉRATION DU STATUT DEPUIS L'INTERFACE
        const row = document.querySelector(`tr[data-proforma-id="${proformaId}"]`);
        let currentStatus = 'en_attente'; // Valeur par défaut
        
        console.log("🔍 DEBUG: Recherche de la ligne pour ID:", proformaId);
        console.log("🔍 DEBUG: Ligne trouvée:", !!row);
        
        if (row) {
            const dataStatus = row.getAttribute('data-status') || row.dataset.status;
            console.log("🔍 DEBUG: Statut depuis data-status:", dataStatus);
            
            if (dataStatus && dataStatus !== 'undefined' && dataStatus !== 'null') {
                currentStatus = dataStatus;
                console.log("✅ DEBUG: Statut pris depuis data-status:", currentStatus);
            } else {
                // Fallback: depuis le badge
                const statusBadge = row.querySelector('.status-badge');
                console.log("🔍 DEBUG: Badge trouvé:", !!statusBadge);
                
                if (statusBadge) {
                    const badgeClasses = statusBadge.className;
                    console.log("🔍 DEBUG: Classes du badge:", badgeClasses);
                    
                    const statusClasses = badgeClasses.split(' ').filter(cls => cls.startsWith('status-'));
                    console.log("🔍 DEBUG: Classes de statut trouvées:", statusClasses);
                    
                    if (statusClasses.length > 0) {
                        const badgeStatus = statusClasses[0].replace('status-', '');
                        console.log("🔍 DEBUG: Statut extrait du badge:", badgeStatus);
                        
                        const validStatuses = ['en_attente', 'en_cours', 'partiel', 'termine'];
                        if (validStatuses.includes(badgeStatus)) {
                            currentStatus = badgeStatus;
                            console.log("✅ DEBUG: Statut pris depuis badge:", currentStatus);
                        }
                    }
                }
            }
        } else {
            console.error("❌ LIGNE NON TROUVÉE pour ID:", proformaId);
            // Debug: lister toutes les lignes disponibles
            const allRows = document.querySelectorAll('tr[data-proforma-id]');
            console.log("🔍 DEBUG: Toutes les lignes disponibles:", 
                Array.from(allRows).map(r => ({
                    id: r.getAttribute('data-proforma-id'),
                    status: r.getAttribute('data-status')
                })));
        }
        
        console.log("🔍 DEBUG: Statut final déterminé:", currentStatus);
        
        // ✅ FERMER LE MODAL D'ACTION
        closeProformaActionModal();
        
        // ✅ DÉFINIR LES OPTIONS SELON LE STATUT
        const modal = document.getElementById("downloadModal");
        const optionsContainer = document.getElementById("download-options");
        const titleEl = modal.querySelector(".modal-title");
        const downloadIntro = document.getElementById("download-intro");
        
        if (!modal || !optionsContainer) {
            alert("Erreur : Interface de téléchargement non trouvée");
            return;
        }
        
        // Mise à jour du titre selon le statut
        if (titleEl) {
            if (currentStatus === 'termine') {
                titleEl.textContent = "Commande Terminée";
            } else {
                titleEl.textContent = "Documents disponibles";
            }
        }
        
        if (downloadIntro) {
            if (currentStatus === 'termine') {
                downloadIntro.style.display = "none";
            } else {
                downloadIntro.style.display = "block";
            }
        }
        
        // ✅ GÉNÉRATION DES BOUTONS SELON LE STATUT
        let html = '';
        const buttonStyle = "display: flex; align-items: center; justify-content: center; gap: 6px; min-width: 150px; padding: 12px 20px; margin: 8px;";
        
        html += '<div style="display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">';
        
        console.log("📄 Génération des boutons pour le statut:", currentStatus);
        
        switch(currentStatus) {
            case 'en_attente':
                console.log("📄 Génération bouton PROFORMA uniquement");
                html += `
                    <button class="btn-action-rose" onclick="downloadDocument('proforma')" style="${buttonStyle}">
                        <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Proforma
                    </button>
                `;
                break;
                
            case 'en_cours':
                console.log("📄 Génération des 3 boutons: PROFORMA + FACTURE + BON");
                html += `
                    <button class="btn-action-rose" onclick="downloadDocument('proforma')" style="${buttonStyle}">
                        <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Proforma
                    </button>
                    <button class="btn-action-rose" onclick="downloadDocument('facture')" style="${buttonStyle}">
                        <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M19,9H20A1,1 0 0,1 21,10V18A3,3 0 0,1 18,21H6A3,3 0 0,1 3,18V6A3,3 0 0,1 6,3H16A1,1 0 0,1 17,4V8H19M19,11V17H5V7H15V10A1,1 0 0,0 16,11H19Z"/>
                        </svg>
                        Facture
                    </button>
                    <button class="btn-action-rose" onclick="downloadDocument('bon')" style="${buttonStyle}">
                        <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M19,9H20A1,1 0 0,1 21,10V18A3,3 0 0,1 18,21H6A3,3 0 0,1 3,18V6A3,3 0 0,1 6,3H16A1,1 0 0,1 17,4V8H19M19,11V17H5V7H15V10A1,1 0 0,0 16,11H19M9,8V10H13V8H9M9,12V14H15V12H9Z"/>
                        </svg>
                        Bon de Livraison
                    </button>
                `;
                break;
                
            case 'partiel':
                console.log("📄 Génération boutons FACTURE + BON partiels");
                html += `
                    <button class="btn-action-rose" onclick="downloadDocument('facture')" style="${buttonStyle}">
                        <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M19,9H20A1,1 0 0,1 21,10V18A3,3 0 0,1 18,21H6A3,3 0 0,1 3,18V6A3,3 0 0,1 6,3H16A1,1 0 0,1 17,4V8H19M19,11V17H5V7H15V10A1,1 0 0,0 16,11H19Z"/>
                        </svg>
                        Facture Partielle
                    </button>
                    <button class="btn-action-rose" onclick="downloadDocument('bon')" style="${buttonStyle}">
                        <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M19,9H20A1,1 0 0,1 21,10V18A3,3 0 0,1 18,21H6A3,3 0 0,1 3,18V6A3,3 0 0,1 6,3H16A1,1 0 0,1 17,4V8H19M9,8V10H13V8H9M9,12V14H15V12H9Z"/>
                        </svg>
                        Bon de Livraison
                    </button>
                `;
                break;
                
            case 'termine':
                console.log("📄 Génération message TERMINÉ");
                html += `
                    <div style="
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 10px 20px 30px 20px;
                        color: #999999;
                        font-size: 20px;
                        font-weight: 500;
                        text-align: center;
                    ">
                        Aucun document disponible pour ce statut
                    </div>
                `;
                break;
                
            default:
                console.warn("⚠️ Statut inconnu, fallback vers PROFORMA:", currentStatus);
                html += `
                    <button class="btn-action-rose" onclick="downloadDocument('proforma')" style="${buttonStyle}">
                        <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Proforma
                    </button>
                `;
        }
        
        html += '</div>';
        
        // Injection du HTML et affichage du modal
        optionsContainer.innerHTML = html;
        modal.style.display = "flex";
        
        console.log(`✅ Download modal opened for status "${currentStatus}" with appropriate buttons`);
    };

    // Exposer les fonctions globalement
    window.changeProformaStatus = changeProformaStatus;
    window.updateProformaStatus = updateProformaStatus;

    function showDownloadOptionsModal(proformaId, options, title = "Télécharger Document", showDetails = true) {
        const modal = document.getElementById("downloadModal");
        const optionsContainer = document.getElementById("download-options");
        const introText = document.getElementById("download-intro");
        const titleEl = modal.querySelector(".modal-title");
        
        // Mettre à jour le titre du modal
        if (titleEl) {
            titleEl.textContent = title;
        }
        
        let html = '';
        
        // Conteneur unique pour TOUS les boutons sur la même ligne
        html += '<div style="display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: wrap;">';
        
        // Ajouter d'abord le bouton Détails
        if (showDetails && options.length > 0) {
            html += `
                <button class="btn-action-rose" onclick="showProformaDetails('${proformaId}')" 
                        style="display: flex; align-items: center; justify-content: center; gap: 6px; min-width: 150px; padding: 12px 20px;">
                    <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Détails
                </button>
            `;
        }
        
        // Puis ajouter les boutons de documents
        options.forEach(option => {
            // Définir les icônes selon le type de document
            let iconSvg = '';
            switch(option.type) {
                case 'proforma':
                    iconSvg = '<svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>';
                    break;
                case 'facture':
                    iconSvg = '<svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19,9H20A1,1 0 0,1 21,10V18A3,3 0 0,1 18,21H6A3,3 0 0,1 3,18V6A3,3 0 0,1 6,3H16A1,1 0 0,1 17,4V8H19M19,11V17H5V7H15V10A1,1 0 0,0 16,11H19Z"/></svg>';
                    break;
                case 'bon':
                    iconSvg = '<svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19,9H20A1,1 0 0,1 21,10V18A3,3 0 0,1 18,21H6A3,3 0 0,1 3,18V6A3,3 0 0,1 6,3H16A1,1 0 0,1 17,4V8H19M19,11V17H5V7H15V10A1,1 0 0,0 16,11H19M9,8V10H13V8H9M9,12V14H15V12H9Z"/></svg>';
                    break;
                default:
                    iconSvg = '<svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>';
            }
            
            html += `
                <button class="btn-action-rose" onclick="downloadDocument('${option.type}')" 
                        style="display: flex; align-items: center; justify-content: center; gap: 6px; min-width: 150px; padding: 12px 20px;">
                    ${iconSvg}
                    ${option.label}
                </button>
            `;
        });
        
        // Fermer le conteneur unique
        html += '</div>';
        
        if (optionsContainer) {
            optionsContainer.innerHTML = html;
        }
        
        currentProformaId = proformaId;
        
        if (modal) {
            modal.style.display = "flex";
            console.log(`✅ Download modal opened with ${options.length + (showDetails ? 1 : 0)} buttons on same line`);
        }
    }
    // 4. ✅ AMÉLIORER downloadDocument AVEC PLUS DE DEBUG
window.downloadDocument = function(type) {
    console.log("📥 === DÉBUT DOWNLOADOCUMENT ===");
    console.log("📥 Type demandé:", type);
    console.log("📥 Variables globales:");
    console.log("   currentProformaId =", currentProformaId);
    console.log("   currentModalProformaId =", currentModalProformaId);
    
    // Validation de l'ID proforma avec sources multiples
    const proformaId = currentProformaId || currentModalProformaId;
    if (!proformaId || proformaId === 'undefined' || proformaId === 'null') {
        console.error("❌ ERREUR: Aucun ID proforma valide trouvé");
        alert("Erreur: ID proforma manquant ou invalide");
        return;
    }
    
    console.log("✅ ID proforma utilisé:", proformaId);
    
    // Validation du type de document
    const validTypes = ['proforma', 'facture', 'bon'];
    if (!validTypes.includes(type)) {
        alert(`Type de document invalide: ${type}`);
        return;
    }
    
    // Récupération du statut actuel depuis l'interface
    const row = document.querySelector(`tr[data-proforma-id="${proformaId}"]`);
    const currentStatus = row ? row.getAttribute('data-status') : 'en_attente';
    
    console.log("📥 Statut récupéré:", currentStatus);
    
    // Définition des documents autorisés selon le statut
    const allowed = getAllowedDocumentsByStatus(currentStatus);
    
    // Vérification des autorisations avec messages spécifiques
    if (!allowed.includes(type)) {
        const statusMessages = {
            'en_attente': 'Seule la proforma est disponible pour ce statut',
            'en_cours': 'Tous les documents sont disponibles',
            'partiel': 'Proforma, facture partielle et bon de livraison sont disponibles',
            'termine': 'Aucun document n\'est disponible - commande terminée'
        };
        alert(`Document "${type}" non autorisé pour le statut "${currentStatus}". ${statusMessages[currentStatus]}`);
        return;
    }
    
    // Construction de l'URL de téléchargement
    const downloadUrl = `/api/proforma/${proformaId}/download/${type}`;
    console.log("📥 Download URL:", downloadUrl);
    
    try {
        // Ouverture du document dans un nouvel onglet
        const downloadWindow = window.open(downloadUrl, '_blank');
        
        // Vérification si le popup a été bloqué
        if (!downloadWindow || downloadWindow.closed || typeof downloadWindow.closed === 'undefined') {
            console.log("Popup bloquée, tentative de téléchargement direct");
            
            // Méthode alternative avec création d'un lien temporaire
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${type.toUpperCase()}_${proformaId}.pdf`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            
            // Nettoyage du lien temporaire
            setTimeout(() => {
                if (link.parentNode) {
                    document.body.removeChild(link);
                }
            }, 100);
        }
        
        // Fermeture du modal après un délai
        setTimeout(() => {
            closeDownloadModal();
        }, 1000);
        
    } catch (error) {
        console.error("Erreur lors du téléchargement:", error);
        alert("Erreur lors du téléchargement du document. Veuillez réessayer.");
    }
};

function getAllowedDocumentsByStatus(status) {
    const allowedDocuments = {
        'en_attente': ['proforma'],
        'en_cours': ['proforma', 'facture', 'bon'], 
        'partiel': ['proforma', 'facture', 'bon'],  
        'termine': []
    };
    return allowedDocuments[status] || ['proforma'];
}

    function initializePagination() {
        generatePagination(currentPage, totalPages);
    }

    function generatePagination(page, total) {
        const container = document.getElementById('paginationContainer');
        if (!container) return;
        
        let html = '';

        if (page > 1) {
            html += `<button class="nav-btn" onclick="goToPage(${page - 1})">Précédent</button>`;
        } else {
            html += `<button class="nav-btn disabled">Précédent</button>`;
        }

        let startPage = Math.max(1, page - 2);
        let endPage = Math.min(total, page + 2);

        if (page <= 3) {
            endPage = Math.min(5, total);
        }
        if (page >= total - 2) {
            startPage = Math.max(1, total - 4);
        }

        if (startPage > 1) {
            html += `<button onclick="goToPage(1)">1</button>`;
            if (startPage > 2) {
                html += `<button class="ellipsis">...</button>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === page ? 'active' : '';
            html += `<button class="${activeClass}" onclick="goToPage(${i})">${i}</button>`;
        }

        if (endPage < total) {
            if (endPage < total - 1) {
                html += `<button class="ellipsis">...</button>`;
            }
            html += `<button onclick="goToPage(${total})">${total}</button>`;
        }

        if (page < total) {
            html += `<button class="nav-btn" onclick="goToPage(${page + 1})">Suivant</button>`;
        } else {
            html += `<button class="nav-btn disabled">Suivant</button>`;
        }

        container.innerHTML = html;
    }

    function updateKPITrends() {
        const trendElements = document.querySelectorAll('.kpi-trend');
        trendElements.forEach(el => {
            if (el.classList.contains('trend-up')) {
                el.style.color = '#4CAF50';
            } else if (el.classList.contains('trend-down')) {
                el.style.color = '#F44336';
            }
        });
    }

    // FONCTION PRINCIPALE - OUVRIR NOUVEAU PROFORMA
    function openNewProformaForm() {
        console.log("🔥 OPENING NEW PROFORMA FORM...");
        
        try {
            // Reset des variables globales
            isEditMode = false;
            currentProformaId = null;
            
            const slideOver = document.getElementById("slide-over");
            const slideOverTitle = document.getElementById("slide-over-title");
            const proformaForm = document.getElementById("proforma-form");
            const proformaDate = document.getElementById("proforma-date");
            const articlesContainer = document.getElementById("articles-container");
            const feesContainer = document.getElementById("supplementary-fees-container");
            
            if (!slideOver) {
                console.error("❌ CRITICAL: Slide over element not found!");
                alert("Erreur: Interface non trouvée. Rechargez la page.");
                return;
            }
            
            console.log("✅ All DOM elements found");
            
            // Reset titre
            if (slideOverTitle) {
                slideOverTitle.textContent = "Nouvelle Proforma";
            }
            
            // Reset form
            if (proformaForm) {
                proformaForm.reset();
            }
            
            // Set date
            if (proformaDate) {
                const today = new Date();
                const dateString = today.getFullYear() + '-' + 
                                 String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                 String(today.getDate()).padStart(2, '0');
                proformaDate.value = dateString;
            }
            
            // Clear containers
            if (articlesContainer) articlesContainer.innerHTML = "";
            if (feesContainer) feesContainer.innerHTML = "";
            
            // Reset téléphone
            if (iti) {
                iti.setCountry('cm');
                const phoneInput = document.getElementById('phone');
                if (phoneInput) {
                    phoneInput.value = '';
                    iti.setNumber('');
                }
            }
            
            // Clear notifications
            clearClientNotifications();
            
            // Clear suggestions
            const suggestions = document.getElementById('client-suggestions');
            if (suggestions) {
                suggestions.style.display = 'none';
                suggestions.innerHTML = '';
            }
            
            // Reset champs client
            const clientFields = ['clientName', 'address', 'city', 'client-country', 'remise'];
            clientFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (fieldId === 'client-country') {
                        field.value = 'Cameroun';
                    } else if (fieldId === 'remise') {
                        field.value = '0';
                    } else {
                        field.value = '';
                    }
                }
            });
            
            // Add default rows
            console.log("🔧 Adding default rows...");
            addPrestationRow();
            addSupplementaryFeeRow();
            
            // Update calculations
            updateCalculations();
            
            // FORCER L'OUVERTURE - MULTIPLE METHODS
            console.log("🔥 FORCING SLIDE-OVER OPEN...");
            slideOver.classList.remove("open");
            
            setTimeout(() => {
                slideOver.classList.add("open");
                slideOver.style.transform = "translateX(0)";
                slideOver.style.display = "block";
                console.log("✅ SLIDE-OVER FORCEFULLY OPENED");
                
                // Verification
                setTimeout(() => {
                    if (!slideOver.classList.contains("open")) {
                        console.error("❌ SLIDE-OVER STILL NOT OPEN - FORCING AGAIN");
                        slideOver.classList.add("open");
                        slideOver.style.transform = "translateX(0) !important";
                    }
                }, 200);
            }, 50);
            
            console.log("✅ openNewProformaForm completed successfully");
            
        } catch (error) {
            console.error("❌ CRITICAL ERROR in openNewProformaForm:", error);
            alert("Erreur critique. Rechargez la page et réessayez.");
        }
    }

    function closeSlideOver() {
        console.log("🔄 Closing slide-over");
        const slideOver = document.getElementById("slide-over");
        if (slideOver) {
            slideOver.classList.remove("open");
            slideOver.style.transform = "translateX(100%)";
        }
        
        // ✅ RESET COMPLET
        resetEditMode();
        clearClientNotifications();
    }

    // Fonction pour vérifier si client existe
    function checkClientExists(phoneNumber) {
        return fetch('/api/check-client', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phoneNumber })
        }).then(response => response.json());
    }

    // Fonction principale de création proforma
    function createProforma(formData) {
        // 1. D'abord vérifier si le client existe
        const clientPhone = formData.client.telephone;
        
        checkClientExists(clientPhone)
            .then(clientCheck => {
                if (clientCheck.exists) {
                    // Client existe, procéder directement à la création
                    submitProforma(formData);
                } else if (clientCheck.new_client) {
                    // Nouveau client détecté, afficher modal
                    pendingProformaData = formData;
                    document.getElementById('newClientMessage').textContent = 
                        `Le numéro ${clientPhone} ne correspond à aucun client existant. Un nouveau client sera créé.`;
                    document.getElementById('newClientModal').style.display = 'flex';
                } else {
                    alert('Erreur lors de la vérification du client');
                }
            })
            .catch(error => {
                console.error('Erreur vérification client:', error);
                alert('Erreur lors de la vérification du client');
            });
    }
    
    // Fonction pour soumettre la proforma
    function submitProforma(formData) {
        fetch('/api/proforma', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher modal de succès
                document.getElementById('proformaSuccessModal').style.display = 'flex';
                
                // Optionnel : rafraîchir la liste des proformas
                // refreshProformasList();
            } else {
                alert(data.message || 'Erreur lors de la création de la proforma');
            }
        })
        .catch(error => {
            console.error('Erreur création proforma:', error);
            alert('Erreur lors de la création de la proforma');
        });
    }

    // Fonction confirmNewClient corrigée
    window.confirmNewClient = function() {
        console.log("✅ Confirmation nouveau client");
        closeNewClientModal();
        
        if (pendingProformaData) {
            console.log("📤 Envoi proforma avec nouveau client");
            submitProformaDirectly(pendingProformaData);
            pendingProformaData = null;
        } else {
            console.error("❌ Aucune donnée proforma en attente");
            alert("Erreur: Aucune donnée de proforma en attente");
        }
    };

    // Fonction closeNewClientModal corrigée
    window.closeNewClientModal = function() {
        console.log("🔄 Fermeture modal nouveau client");
        const modal = document.getElementById('newClientModal');
        if (modal) {
            modal.style.display = 'none';
        }
        pendingProformaData = null; // Reset des données
    };


    // ✅ NOUVEAU : Modal pour nouveau client créé (APRÈS enregistrement)
    function showNewClientCreatedModal(clientName) {
        const modal = document.getElementById('newClientModal');
        const titleEl = modal.querySelector('.modal-title');
        const messageEl = document.getElementById('newClientMessage');
        
        if (titleEl) {
            titleEl.textContent = 'Nouveau client créé';
        }
        
        if (messageEl) {
            messageEl.textContent = `Le client "${clientName}" a été créé automatiquement et la proforma a été enregistrée avec succès !`;
        }
        
        // ✅ CHANGER LES BOUTONS : Pas besoin d'annuler
        const buttonsContainer = modal.querySelector('[style*="display:flex"]');
        if (buttonsContainer) {
            buttonsContainer.innerHTML = `
                <button class="modal-button" onclick="closeNewClientCreatedModal()">
                    Parfait ! Continuer
                </button>
            `;
        }
        
        if (modal) {
            modal.style.display = 'flex';
            console.log('✅ Modal nouveau client créé affiché pour:', clientName);
        }
    }

    // ✅ NOUVEAU : Modal succès proforma simple
    function showProformaSuccessModal() {
        const modal = document.getElementById('proformaSuccessModal');
        
        if (modal) {
            modal.style.display = 'flex';
            console.log('✅ Modal succès proforma affiché');
        }
    }

    // ✅ NOUVEAU : Fermer modal nouveau client créé
    function closeNewClientCreatedModal() {
        const modal = document.getElementById('newClientModal');
        if (modal) {
            modal.style.display = 'none';
        }
        
        // ✅ RECHARGER APRÈS FERMETURE
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }

    // ✅ Fermer modal succès proforma (création)
    function closeProformaSuccessModal() {
        const modal = document.getElementById('proformaSuccessModal');
        if (modal) {
            modal.style.display = 'none';
        }
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }

    // ✅ Fermer modal succès proforma (modification)
    function closeProformaModificationModal() {
        const modal = document.getElementById('proformaModificationModal');
        if (modal) {
            modal.style.display = 'none';
        }
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }

    // ✅ EXPOSER LES FONCTIONS GLOBALEMENT
    window.closeProformaSuccessModal = closeProformaSuccessModal;
    window.closeProformaModificationModal = closeProformaModificationModal;

        function clearClientNotifications() {
            const notifications = document.querySelectorAll('.client-found-notification, .new-client-notification');
            notifications.forEach(notif => {
                try {
                    notif.remove();
                } catch (e) {
                    console.log("Note: Notification already removed");
                }
            });
        }

    // Variables globales pour filtres
    let currentFilters = {
        status: '',
        year: new Date().getFullYear(),
        period: 'semaine'
    };

    function handleFilters() {
        const statusFilter = document.getElementById("status-filter");
        const searchInput = document.getElementById("searchProformasInput");
        const selectedStatus = statusFilter ? statusFilter.value : '';
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        console.log("Filtre appliqué:", selectedStatus, "Recherche:", searchTerm);
        
        // Récupérer toutes les lignes du tableau
        const rows = document.querySelectorAll('#proforma-tbody tr[data-proforma-id]');
        let visibleCount = 0;
        let totalAmount = 0;
        
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            
            // Vérifier le statut
            const statusMatch = selectedStatus === '' || rowStatus === selectedStatus;
            
            // Vérifier la recherche textuelle
            let searchMatch = true;
            if (searchTerm) {
                const rowText = row.textContent.toLowerCase();
                searchMatch = rowText.includes(searchTerm);
            }
            
            if (statusMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
                
                // Calculer le montant total des lignes visibles
                const amountCell = row.cells[3]; // Colonne "Total"
                if (amountCell) {
                    const amountText = amountCell.textContent.replace(/[^\d]/g, '');
                    const amount = parseInt(amountText) || 0;
                    totalAmount += amount;
                }
            } else {
                row.style.display = 'none';
            }
        });
        
        // Mettre à jour les compteurs
        const countElement = document.getElementById('proforma-count');
        const totalAmountElement = document.getElementById('proforma-total-amount');
        
        if (countElement) {
            countElement.textContent = `${visibleCount}`;
        }
        
        if (totalAmountElement) {
            totalAmountElement.textContent = formatCurrency(totalAmount);
        }
        
        // Mettre à jour la pagination si nécessaire
        updatePaginationForFilter(visibleCount);
    }

function updatePaginationForFilter(visibleCount) {
    const itemsPerPage = 10; // Ajustez selon vos besoins
    const newTotalPages = Math.ceil(visibleCount / itemsPerPage);
    
    if (newTotalPages !== totalPages) {
        totalPages = newTotalPages;
        currentPage = 1;
        generatePagination(currentPage, totalPages);
    }
}

// Assigner la fonction à window pour l'accessibilité globale
window.handleFilters = handleFilters;

    // ✅ NOUVELLE FONCTION : Mise à jour des compteurs filtrés
    function updateFilteredCounts(proformas) {
        const countEl = document.getElementById('proforma-count');
        const totalAmountEl = document.getElementById('proforma-total-amount');
        
        if (countEl && totalAmountEl) {
            const totalAmount = proformas.reduce((sum, p) => sum + (p.total_ttc || 0), 0);
            
            countEl.textContent = `${proformas.length} proforma(s)`;
            totalAmountEl.textContent = formatCurrency(totalAmount);
            
            // ✅ AFFICHER INFO FILTRE ACTIF
            let filterInfo = '';
            if (currentFilters.status) {
                filterInfo += ` (statut: ${getStatusText(currentFilters.status)})`;
            }
            if (currentFilters.year !== new Date().getFullYear()) {
                filterInfo += ` (année: ${currentFilters.year})`;
            }
            
            if (filterInfo) {
                countEl.textContent += filterInfo;
            }
        }
    }

    function updateKPIForYear(year) {
        console.log("📊 Updating KPI for year:", year);
        
        fetch(`/api/kpi-by-year/${year}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateKPIDisplay(data.kpi);
                }
            })
            .catch(error => {
                console.error('❌ Erreur KPI:', error);
            });
    }

    function updateKPIDisplay(kpi) {
        const kpiElements = {
            'kpi_ca': kpi.chiffre_affaires,
            'kpi_factures': kpi.factures,
            'kpi_devis': kpi.devis,
            'kpi_a_traiter': kpi.a_traiter
        };
        
        document.querySelectorAll('.kpi-card .value').forEach((el, index) => {
            const keys = Object.keys(kpiElements);
            if (keys[index]) {
                const value = kpiElements[keys[index]];
                if (index === 0 || index === 2) {
                    el.textContent = formatCurrency(value);
                } else {
                    el.textContent = value.toString();
                }
            }
        });
        
        console.log("✅ KPI updated for selected year");
    }

    function updateChartForYear(year) {
        if (!year) return;
        
        fetch(`/api/chart-data/${year}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateChart(data.labels, data.values, data.has_data);
                }
            })
            .catch(error => console.error('Erreur chart:', error));
    }

    function updateChartForPeriod(period) {
        const year = document.getElementById("year-filter").value;
        fetch(`/api/chart-data/${year}?period=${period}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateChart(data.labels, data.values, data.has_data);
                }
            })
            .catch(error => console.error('Erreur chart period:', error));
    }

    function updateChart(labels, values, hasData) {
        const chartContainer = document.querySelector('.chart-container');
        const canvas = document.getElementById('caChart');
        
        if (!hasData || values.length === 0) {
            chartContainer.innerHTML = '<div class="no-data-message">AUCUNE DONNÉE DISPONIBLE POUR LE MOMENT</div>';
            return;
        }
        
        if (!canvas) {
            chartContainer.innerHTML = '<canvas id="caChart"></canvas>';
        }
        
        const ctx = document.getElementById('caChart').getContext('2d');
        
        if (window.myChart) {
            window.myChart.destroy();
        }
        
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Chiffre d\'affaires (FCFA)',
                    data: values,
                    borderColor: '#d81b60',
                    backgroundColor: 'rgba(216, 27, 96, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function addPrestationRow(data = {}) {
        console.log("📝 Adding prestation row with data:", data);
        
        const container = document.getElementById("articles-container");
        if (!container) {
            console.error("❌ Articles container not found");
            return;
        }
        
        const section = document.createElement("div");
        section.classList.add("prestation-section");
        
        const articleType = data.type || "";
        
        section.innerHTML = `
            <div class="prestation-header">
                <select class="form-control prestation-type-select" required>
                    <option value="">Sélectionnez un type</option>
                    <option value="Livre" ${articleType === "livre" ? "selected" : ""}>Livre</option>
                    <option value="Fourniture" ${articleType === "fourniture" ? "selected" : ""}>Fourniture</option>
                    <option value="Service" ${articleType === "service" ? "selected" : ""}>Service</option>
                    <option value="Formation" ${articleType === "formation" ? "selected" : ""}>Formation</option>
                </select>
                <button type="button" class="delete-prestation" style="display: none;">
                    <svg viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
            </div>
            
            <div class="prestation-fields livre-fields ${articleType === "livre" ? "show" : ""}">
                <div class="field-row">
                    <select class="form-control livre-nature">
                        <option value="">Sélectionnez une nature</option>
                        ${naturesDisponibles.map(nature => `<option value="${nature}" ${data.nature === nature ? "selected" : ""}>${nature}</option>`).join('')}
                    </select>
                    <select class="form-control livre-classe">
                        <option value="">Sélectionnez d'abord une nature</option>
                        ${data.classe ? `<option value="${data.classe}" selected>${data.classe}</option>` : ''}
                    </select>
                </div>
                <div class="field-row">
                    <select class="form-control livre-designation">
                        <option value="">Sélectionnez d'abord nature et classe</option>
                        ${data.designation ? `<option value="${data.article_id || ''}" selected>${data.designation}</option>` : ''}
                    </select>
                    <input type="number" class="form-control livre-prix" placeholder="Prix" readonly value="${data.prix || ''}">
                    <input type="number" class="form-control livre-quantity" placeholder="Quantité" min="1" value="${data.quantite || 1}">
                </div>
                <!-- Nouvelle ligne pour la sélection automatique -->
                <div class="field-row auto-select-row" style="display: none; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #d81b60;">
                        <input type="checkbox" class="auto-select-all-books" style="transform: scale(1.2);">
                        <span>Ajouter automatiquement tous les livres de cette classe</span>
                    </label>
                </div>
            </div>
            
            <div class="prestation-fields fourniture-fields ${articleType === "fourniture" ? "show" : ""}">
                <div class="field-row">
                    <select class="form-control fourniture-ville-select">
                        <option value="">Ville de référence</option>
                        ${villesFournitures.map(ville => `<option value="${ville}" ${data.ville_reference === ville ? "selected" : ""}>${ville}</option>`).join('')}
                    </select>
                    <select class="form-control fourniture-designation">
                        <option value="">Sélectionnez d'abord une ville</option>
                        ${data.designation ? `<option value="${data.article_id || ''}" selected>${data.designation}</option>` : ''}
                    </select>
                </div>
                <div class="field-row">
                    <input type="number" class="form-control fourniture-prix" placeholder="Prix" readonly value="${data.prix || ''}">
                    <input type="number" class="form-control fourniture-quantity" placeholder="Quantité" min="1" value="${data.quantite || 1}">
                </div>
            </div>
            
            <div class="prestation-fields service-fields ${articleType === "service" ? "show" : ""}">
                <div class="field-row">
                    <select class="form-control service-nature-select">
                        <option value="">Sélectionnez une nature</option>
                        <option value="Mission d'Études" ${data.nature === "Mission d'Études" ? "selected" : ""}>Mission d'Études</option>
                        <option value="Mission d'Analyses" ${data.nature === "Mission d'Analyses" ? "selected" : ""}>Mission d'Analyses</option>
                        <option value="Mission de Conseils" ${data.nature === "Mission de Conseils" ? "selected" : ""}>Mission de Conseils</option>
                        <option value="Autres" ${data.nature === "Autres" ? "selected" : ""}>Autres</option>
                    </select>
                    <input type="text" class="form-control service-precisez" placeholder="Précisez la mission" style="display:${data.nature === 'Autres' ? 'block' : 'none'};" value="${data.nature === 'Autres' ? data.designation || '' : ''}">
                </div>
                <div class="field-row">
                    <input type="number" class="form-control service-jours" placeholder="Nombre de jours" min="1" value="${data.jours || 1}">
                    <input type="number" class="form-control service-prix" placeholder="Prix par jour" min="0" value="${data.prix || ''}">
                </div>
            </div>
            
            <div class="prestation-fields formation-fields ${articleType === "formation" ? "show" : ""}">
                <div class="field-row">
                    <select class="form-control formation-designation-select" required>
                        <option value="">Sélectionnez une formation</option>
                        ${formations.map(formation => `<option value="${formation.formation_id}" data-designation="${formation.designation}">${formation.designation}</option>`).join('')}
                    </select>
                </div>
                <div class="field-row">
                    <input type="number" class="form-control formation-heures" placeholder="Nombre d'heures" min="1" value="${data.heures || 1}" required>
                    <input type="number"
       class="form-control formation-prix"
       placeholder="Prix par heure"
       min="0"
       step="1"
       inputmode="numeric"
       pattern="\d*"
       value="${data.prix || ''}"
       required
       style="width:100%;">
                </div>
            </div>
    `;
    
    container.appendChild(section);
    attachPrestationEventListeners(section);
    
    // ✅ CORRECTION CRITIQUE: Si c'est une formation en édition avec un prix, le remplir
    if (articleType === "formation" && data.prix && data.prix > 0) {
        setTimeout(() => {
            const prixInput = section.querySelector(".formation-prix");
            if (prixInput) {
                prixInput.value = data.prix;
                console.log("✅ Prix formation rempli:", data.prix);
            }
        }, 100);
    }
    
    updateDeleteButtonsVisibility();
    console.log("✅ Prestation row added successfully with type:", articleType);
}

    // ÉTAPE 1: Event listeners pour prestations avec logique selon nature
    function attachPrestationEventListeners(section) {
        const typeSelect = section.querySelector(".prestation-type-select");
        
        // ✅ FONCTION HELPER DÉFINIE LOCALEMENT pour vérifier les éléments DOM
        function ensureLivreElementsExist(section) {
            const requiredElements = [
                '.livre-nature',
                '.livre-classe', 
                '.livre-designation',
                '.livre-prix',
                '.livre-quantity'
            ];
            
            for (const selector of requiredElements) {
                const element = section.querySelector(selector);
                if (!element) {
                    console.error(`❌ Élément manquant: ${selector}`);
                    return false;
                }
            }
            return true;
        }
        
        // Vérification de sécurité pour les éléments livre
        if (typeSelect && typeSelect.value === "Livre") {
            if (!ensureLivreElementsExist(section)) {
                console.error("❌ Éléments livre manquants, reconstruction de la section");
                return;
            }
        }
        
        const fields = {
            livre: section.querySelector(".livre-fields"),
            fourniture: section.querySelector(".fourniture-fields"),
            service: section.querySelector(".service-fields"),
            formation: section.querySelector(".formation-fields")
        };

        // Gestion changement de type
        typeSelect.addEventListener("change", function() {
            console.log("Type changed to:", this.value);
            
            Object.values(fields).forEach(field => {
                if (field) field.classList.remove('show');
            });
            
            const selectedType = this.value.toLowerCase();
            if (fields[selectedType]) {
                fields[selectedType].classList.add('show');
                console.log(`Showing ${selectedType} fields`);
            }
            updateCalculations();
        });

        // ÉTAPE 1: Logique LIVRE avec API
        const livreNatureSelect = section.querySelector(".livre-nature");
        const livreClasseSelect = section.querySelector(".livre-classe");
        const livreDesignationSelect = section.querySelector(".livre-designation");
        const livrePrixInput = section.querySelector(".livre-prix");
        
        if (livreNatureSelect && livreClasseSelect && livreDesignationSelect) {
            // ÉTAPE 1.1: Charger les classes selon la nature
            livreNatureSelect.addEventListener("change", function() {
                const nature = this.value;
                console.log("📚 Nature selected:", nature);
                
                livreClasseSelect.innerHTML = '<option value="">Chargement des classes...</option>';
                livreDesignationSelect.innerHTML = '<option value="">Sélectionnez d\'abord une classe</option>';
                if (livrePrixInput) livrePrixInput.value = '';
                
                if (!nature) {
                    livreClasseSelect.innerHTML = '<option value="">Sélectionnez d\'abord une nature</option>';
                    return;
                }
                
                fetch(`/api/classes-by-nature?nature=${encodeURIComponent(nature)}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("📚 Classes data received:", data);
                        
                        if (data.success && data.classes.length > 0) {
                            livreClasseSelect.innerHTML = '<option value="">Sélectionnez une classe</option>';
                            data.classes.forEach(classe => {
                                livreClasseSelect.innerHTML += `<option value="${classe}">${classe}</option>`;
                            });
                            console.log(`📚 ${data.classes.length} classes loaded`);
                        } else {
                            livreClasseSelect.innerHTML = '<option value="">Aucune classe trouvée pour cette nature</option>';
                            console.log("📚 No classes found for nature:", nature);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error loading classes:', error);
                        livreClasseSelect.innerHTML = '<option value="">Erreur de chargement des classes</option>';
                    });
            });
            
            // ÉTAPE 1.2: Charger les livres selon nature + classe avec option de sélection automatique
            livreClasseSelect.addEventListener("change", function() {
                const nature = livreNatureSelect.value;
                const classe = this.value;
                console.log("📚 Classe selected:", classe, "for nature:", nature);
                
                livreDesignationSelect.innerHTML = '<option value="">Chargement des livres...</option>';
                if (livrePrixInput) livrePrixInput.value = '';
                
                // Masquer la case à cocher de sélection automatique
                const autoSelectRow = section.querySelector(".auto-select-row");
                if (autoSelectRow) {
                    autoSelectRow.style.display = "none";
                    const checkbox = autoSelectRow.querySelector(".auto-select-all-books");
                    if (checkbox) checkbox.checked = false;
                }
                
                if (!nature || !classe) {
                    livreDesignationSelect.innerHTML = '<option value="">Sélectionnez nature et classe</option>';
                    return;
                }
                
                const url = `/api/livres-by-nature-classe?nature=${encodeURIComponent(nature)}&classe=${encodeURIComponent(classe)}`;
                console.log("📚 Fetching livres from:", url);
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log("📚 Livres data received:", data);
                        
                        if (data.success && data.livres && data.livres.length > 0) {
                            // Stocker les livres disponibles pour cette section
                            section.availableLivres = data.livres;
                            
                            livreDesignationSelect.innerHTML = '<option value="">Sélectionnez un livre</option>';
                            data.livres.forEach(livre => {
                                livreDesignationSelect.innerHTML += `<option value="${livre.article_id}" data-prix="${livre.prix}" data-designation="${livre.designation}">${livre.designation}</option>`;
                            });
                            
                            // Afficher la case à cocher pour sélection automatique si plusieurs livres disponibles
                            if (data.livres.length > 1 && autoSelectRow) {
                                autoSelectRow.style.display = "block";
                                const label = autoSelectRow.querySelector("span");
                                if (label) {
                                    label.textContent = `Ajouter automatiquement tous les livres de la classe ${classe} (${data.livres.length} livres)`;
                                }
                            }
                            
                            console.log(`📚 ${data.livres.length} livres loaded successfully`);
                        } else {
                            livreDesignationSelect.innerHTML = '<option value="">Aucun livre trouvé pour cette combinaison</option>';
                            console.log("📚 No livres found for:", nature, "+", classe);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error loading livres:', error);
                        livreDesignationSelect.innerHTML = '<option value="">Erreur de chargement des livres</option>';
                    });
            });
            
            // ÉTAPE 1.3: Mettre à jour le prix quand on sélectionne un livre
            livreDesignationSelect.addEventListener("change", function() {
                const selectedOption = this.selectedOptions[0];
                console.log("📚 Livre selected:", selectedOption);
                
                if (selectedOption && selectedOption.dataset.prix && livrePrixInput) {
                    const prix = selectedOption.dataset.prix;
                    livrePrixInput.value = prix;
                    console.log("📚 Prix set to:", prix);
                    updateCalculations();
                } else {
                    if (livrePrixInput) livrePrixInput.value = '';
                    console.log("📚 Prix cleared");
                }
            });

            // ÉTAPE 1.4: Gestion de la sélection automatique de tous les livres d'une classe
            const autoSelectCheckbox = section.querySelector(".auto-select-all-books");
            if (autoSelectCheckbox) {
                autoSelectCheckbox.addEventListener("change", function() {
                    if (this.checked && section.availableLivres && section.availableLivres.length > 1) {
                        console.log("📚 Auto-sélection activée pour", section.availableLivres.length, "livres");
                        
                        // Récupérer les valeurs de nature et classe de la section actuelle
                        const natureSelect = section.querySelector(".livre-nature");
                        const classeSelect = section.querySelector(".livre-classe");
                        
                        if (!natureSelect || !classeSelect || !natureSelect.value || !classeSelect.value) {
                            console.error("❌ Nature ou classe manquante");
                            this.checked = false;
                            return;
                        }
                        
                        const nature = natureSelect.value;
                        const classe = classeSelect.value;
                        
                        console.log("📚 Création automatique pour nature:", nature, "classe:", classe);
                        
                        // Remplir la section actuelle avec le premier livre
                        const designationSelect = section.querySelector(".livre-designation");
                        const prixInput = section.querySelector(".livre-prix");
                        const quantiteInput = section.querySelector(".livre-quantity");
                        
                        if (designationSelect && prixInput && section.availableLivres.length > 0) {
                            const premierLivre = section.availableLivres[0];
                            
                            // Sélectionner le premier livre dans la section actuelle
                            designationSelect.value = premierLivre.article_id;
                            prixInput.value = premierLivre.prix;
                            if (quantiteInput && !quantiteInput.value) {
                                quantiteInput.value = 1;
                            }
                            
                            console.log("📚 Premier livre assigné:", premierLivre.designation);
                        }
                        
                        // Créer de nouvelles sections pour les autres livres
                        for (let i = 1; i < section.availableLivres.length; i++) {
                            const livre = section.availableLivres[i];
                            
                            console.log("📚 Création nouvelle section pour:", livre.designation);
                            
                            // Données pour la nouvelle prestation
                            const newSectionData = {
                                type: "livre",
                                nature: nature,
                                classe: classe,
                                designation: livre.designation,
                                prix: livre.prix,
                                quantite: 1,
                                article_id: livre.article_id
                            };
                            
                            // Ajouter une nouvelle prestation
                            setTimeout(() => {
                                addPrestationRow(newSectionData);
                            }, i * 100); // Petit délai pour éviter les conflits
                        }
                        
                        // Masquer la case à cocher après utilisation
                        const autoSelectRow = section.querySelector(".auto-select-row");
                        if (autoSelectRow) {
                            autoSelectRow.style.display = "none";
                        }
                        
                        // Mettre à jour les calculs après un court délai
                        setTimeout(() => {
                            updateCalculations();
                            updateDeleteButtonsVisibility();
                        }, (section.availableLivres.length * 100) + 200);
                        
                        console.log(`✅ ${section.availableLivres.length} livres programmés pour ajout automatique`);
                    }
                });
            }
        }

        // ÉTAPE 1: Logique FOURNITURE (déjà OK)
        const villeSelect = section.querySelector(".fourniture-ville-select");
        const fournitureDesignationSelect = section.querySelector(".fourniture-designation");
        if (villeSelect && fournitureDesignationSelect) {
            villeSelect.addEventListener("change", function() {
                const ville = this.value;
                fournitureDesignationSelect.innerHTML = '<option value="">Chargement...</option>';
                
                if (ville) {
                    fetch(`/api/fournitures-by-ville/${encodeURIComponent(ville)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                fournitureDesignationSelect.innerHTML = '<option value="">Sélectionnez une fourniture</option>';
                                data.fournitures.forEach(fourniture => {
                                    fournitureDesignationSelect.innerHTML += `<option value="${fourniture.article_id}" data-prix="${fourniture.prix}">${fourniture.designation}</option>`;
                                });
                            }
                        })
                        .catch(error => {
                            fournitureDesignationSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                        });
                } else {
                    fournitureDesignationSelect.innerHTML = '<option value="">Sélectionnez d\'abord une ville</option>';
                }
            });
            
            fournitureDesignationSelect.addEventListener("change", function() {
                const option = this.selectedOptions[0];
                if (option && option.dataset.prix) {
                    const prixInput = section.querySelector(".fourniture-prix");
                    if (prixInput) {
                        prixInput.value = option.dataset.prix;
                        updateCalculations();
                    }
                }
            });
        }

        // ÉTAPE 1: Logique SERVICE (déjà OK)
        const serviceNatureSelect = section.querySelector(".service-nature-select");
        const servicePrecisez = section.querySelector(".service-precisez");
        if (serviceNatureSelect && servicePrecisez) {
            serviceNatureSelect.addEventListener("change", function() {
                servicePrecisez.style.display = this.value === "Autres" ? "block" : "none";
            });
        }

        // LOGIQUE FORMATION - Prix dynamique
        const formationDesignationSelect = section.querySelector(".formation-designation-select");
        const formationPrixInput = section.querySelector(".formation-prix");
        const formationHeuresInput = section.querySelector(".formation-heures");

        if (formationDesignationSelect && formationPrixInput) {
            console.log("Setting up formation listeners");
            
            // Event listener pour le changement de formation
            formationDesignationSelect.addEventListener("change", function() {
                const selectedOption = this.selectedOptions[0];
                
                if (selectedOption && selectedOption.value && selectedOption.value !== "") {
                    console.log("🎓 Formation sélectionnée:", selectedOption.textContent);
                    
                    if (formationPrixInput) {
                        // ✅ TOUJOURS laisser vide pour saisie manuelle (comme les services)
                        formationPrixInput.value = '';
                        formationPrixInput.placeholder = 'Prix par heure (obligatoire)';
                        formationPrixInput.required = true;
                        
                        // Focus automatique sur le champ prix
                        setTimeout(() => {
                            formationPrixInput.focus();
                        }, 100);
                    }
                    
                    updateCalculations();
                }
            });

            // Event listeners pour validation
            if (formationHeuresInput) {
                formationHeuresInput.addEventListener("input", updateCalculations);
            }
            if (formationPrixInput) {
                // Forcer un entier: pas de virgule, pas de décimales
                formationPrixInput.setAttribute("inputmode", "numeric");
                formationPrixInput.setAttribute("pattern", "\\d*");
                formationPrixInput.setAttribute("step", "1");

                formationPrixInput.addEventListener("input", function () {
                    // Garder uniquement les chiffres (supprime , . espaces)
                    const cleaned = this.value.replace(/[^\d]/g, "");
                    if (this.value !== cleaned) this.value = cleaned;
                    updateCalculations();
                });

                formationPrixInput.addEventListener("blur", function() {
                    const prix = parseInt(this.value, 10);

                    // Supprimer tout ancien message s'il existait
                    const oldErr = section.querySelector('.formation-prix-error');
                    if (oldErr) oldErr.remove();

                    if (!prix || prix <= 0) {
                        this.setAttribute('aria-invalid', 'true');
                    } else {
                        this.removeAttribute('aria-invalid');
                        // Normaliser l'affichage en entier
                        this.value = String(prix);
                    }
                });
            }
        }

        
        // Gestion quantités/heures/jours
        section.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener("input", updateCalculations);
        });

        // Bouton supprimer
        const deleteBtn = section.querySelector(".delete-prestation");
        if (deleteBtn) {
            deleteBtn.addEventListener("click", function() {
                section.remove();
                updateCalculations();
                updateDeleteButtonsVisibility();
            });
        }
    }

    function addSupplementaryFeeRow(data = {}) {
        console.log("💰 Adding supplementary fee row with data:", data);
        
        const container = document.getElementById("supplementary-fees-container");
        if (!container) {
            console.error("❌ Supplementary fees container not found");
            return;
        }
        
        const section = document.createElement("div");
        section.classList.add("supplementary-fee-section");
        
        // ✅ GÉRER LES DIFFÉRENTS FORMATS DE DONNÉES
        const feeType = data.type || data.frais_type || "Livraison";
        const feeAmount = data.amount || data.montant || data.frais_montant || 0;
        const feeComment = data.comment || data.commentaire || data.frais_commentaire || "";
        
        section.innerHTML = `
            <div class="fee-row" style="display:flex; gap:10px; align-items:center;">
                <select class="form-control fee-type" style="flex:1;min-width:150px;">
                    <option value="Livraison" ${feeType === "Livraison" ? "selected" : ""}>Livraison</option>
                    <option value="Expédition" ${feeType === "Expédition" ? "selected" : ""}>Expédition</option>
                    <option value="Autre" ${feeType === "Autre" ? "selected" : ""}>Autre</option>
                </select>
                <input type="number" class="form-control fee-amount" placeholder="Montant" min="0" value="${feeAmount}" style="flex:1;min-width:220px;">
                <button type="button" class="delete-fee-btn" style="display: none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
            </div>
            <div class="fee-comment-container" style="${feeType === "Autre" ? "display:block;" : "display:none"}; margin-top:10px;">
                <input type="text" class="form-control fee-comment" placeholder="Commentaire" value="${feeComment}">
            </div>
        `;

        container.appendChild(section);
        
        // ✅ EVENT LISTENERS
        const typeSelect = section.querySelector(".fee-type");
        const commentContainer = section.querySelector(".fee-comment-container");
        const amountInput = section.querySelector(".fee-amount");
        const deleteBtn = section.querySelector(".delete-fee-btn");

        typeSelect.addEventListener("change", function() {
            commentContainer.style.display = this.value === "Autre" ? "block" : "none";
        });

        amountInput.addEventListener("input", updateCalculations);

        deleteBtn.addEventListener("click", function() {
            section.remove();
            updateCalculations();
            updateSupplementaryFeeDeleteButtonsVisibility();
        });
        
        updateSupplementaryFeeDeleteButtonsVisibility();
        
        console.log("✅ Supplementary fee row added:", {type: feeType, amount: feeAmount, comment: feeComment});
    }

    function updateDeleteButtonsVisibility() {
        const sections = document.querySelectorAll(".prestation-section");
        sections.forEach(section => {
            const deleteBtn = section.querySelector(".delete-prestation");
            if (deleteBtn) {
                deleteBtn.style.display = sections.length > 1 ? "block" : "none";
            }
        });
    }

    function updateSupplementaryFeeDeleteButtonsVisibility() {
        const sections = document.querySelectorAll(".supplementary-fee-section");
        sections.forEach(section => {
            const deleteBtn = section.querySelector(".delete-fee-btn");
            if (deleteBtn) {
                deleteBtn.style.display = sections.length > 1 ? "block" : "none";
            }
        });
    }

    function updateCalculations() {
        let subTotal = 0;
        
        // Calculer sous-total des prestations
        document.querySelectorAll(".prestation-section").forEach(section => {
            const type = section.querySelector(".prestation-type-select").value;
            let amount = 0;
            
            switch (type) {
                case "Livre":
                case "Fourniture":
                    const prix = parseFloat(section.querySelector(`.${type.toLowerCase()}-prix`).value) || 0;
                    const quantite = parseFloat(section.querySelector(`.${type.toLowerCase()}-quantity`).value) || 1;
                    amount = prix * quantite;
                    break;
                case "Service":
                    const prixJour = parseFloat(section.querySelector(".service-prix").value) || 0;
                    const jours = parseFloat(section.querySelector(".service-jours").value) || 1;
                    amount = prixJour * jours;
                    break;
                case "Formation":
                    // ✅ CORRECTION: Calcul sécurisé pour formation
                    const formationPrixInput = section.querySelector(".formation-prix");
                    const formationHeuresInput = section.querySelector(".formation-heures");
                    
                    const prixHeure = formationPrixInput ? parseFloat(formationPrixInput.value) || 0 : 0;
                    const heures = formationHeuresInput ? parseFloat(formationHeuresInput.value) || 1 : 1;
                    
                    amount = prixHeure * heures;
                    
                    console.log("Formation calculation:", {
                        prixHeure: prixHeure,
                        heures: heures,
                        amount: amount
                    });
                    break;
            }
            subTotal += amount;
        });

        // Calculer frais supplémentaires
        let totalFees = 0;
        document.querySelectorAll(".supplementary-fee-section").forEach(section => {
            const feeAmount = parseFloat(section.querySelector(".fee-amount").value) || 0;
            totalFees += feeAmount;
        });

        // Calculer remise en pourcentage
        const remisePercent = parseFloat(document.getElementById("remise").value) || 0;
        const remiseAmount = (subTotal * remisePercent) / 100;

        // TVA fixe à 0
        const tva = 0;

        // Total TTC
        const totalTTC = subTotal - remiseAmount + totalFees + tva;

        // Mettre à jour l'affichage
        updateDisplayValues(subTotal, remiseAmount, totalFees, tva, totalTTC);
    }

    function updateDisplayValues(subTotal, remiseAmount, totalFees, tva, totalTTC) {
        const elements = {
            'sub-total': subTotal,
            'discount-display': remiseAmount,
            'supplementary-fees-display': totalFees,
            'tva-amount': tva,
            'total-ttc': totalTTC
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = formatCurrency(value);
            }
        });
        
        // Montant en lettres
        const amountInWordsEl = document.getElementById("amount-in-words");
        if (amountInWordsEl) {
            amountInWordsEl.textContent = numberToWords(totalTTC);
        }
    }

    function validateRemise(input) {
        const value = parseFloat(input.value);
        if (value < 0) input.value = 0;
        if (value > 100) input.value = 100;
    }

    // ÉTAPE 2: Auto-complétion client AMÉLIORÉE
    let clientCheckTimeout = null;
    
    function debounceCheckClient() {
        clearTimeout(clientCheckTimeout);
        clientCheckTimeout = setTimeout(checkExistingClient, 500);
    }

    function checkExistingClient() {
        if (!iti) return;
        
        // UTILISER LA VALIDATION NATIVE : iti.isValidNumber()
        if (iti.isValidNumber()) {
            // ✅ CORRECTION : Utiliser le format compact comme dans le répertoire
            const phoneValue = document.getElementById("phone").value.trim();
            const phoneNumber = normalizePhoneForDB(phoneValue, iti);  // Format compact
            
            console.log("📞 Vérification client avec numéro:", phoneNumber);
            
            fetch("/api/check-client", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: phoneNumber }),  // Format compact
            })
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    fillClientFields(data.client);
                    showClientFoundNotification(data.client.nom);
                } else {
                    clearClientNotifications();
                    showNewClientNotification();
                }
            })
            .catch(error => console.error("Erreur:", error));
        }
    }


    // ✅ NOUVELLE FONCTION : Notification discrète (pas modal)
    function showNewClientNotification() {
        const phoneGroup = document.querySelector('#phone').closest('.form-group');
        
        // Supprimer notification existante
        clearClientNotifications();
        
        // Ajouter notification discrète
        const notification = document.createElement('div');
        notification.className = 'new-client-notification';
        notification.innerHTML = `Nouveau numéro détecté.`;
        phoneGroup.appendChild(notification);
        
        // Supprimer après 3 secondes
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    function fillClientFields(client) {
        const fields = [
            { id: 'clientName', value: client.nom },
            { id: 'address', value: client.adresse },
            { id: 'city', value: client.ville },
            { id: 'client-country', value: client.pays }
        ];
        
        fields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element && field.value) {
                element.value = field.value;
            }
        });
    }

    function showClientFoundNotification(clientName) {
        const phoneGroup = document.querySelector('#phone').closest('.form-group');
        
        // Supprimer notification existante
        clearClientNotifications();
        
        // Ajouter nouvelle notification ROSE
        const notification = document.createElement('div');
        notification.className = 'client-found-notification';
        notification.innerHTML = `✓ Client trouvé: ${clientName}.`;
        phoneGroup.appendChild(notification);
        
        // Supprimer après 5 secondes
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    window.handleProformaSubmit = handleProformaSubmit;
        async function handleProformaSubmit(e) {
        console.log("🔥 handleProformaSubmit déclenchée !");
        e.preventDefault();

        const saveBtn = document.querySelector(".save-btn");
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = "Enregistrement...";
        }

        try {
            // ✅ ÉTAPE 1 : Collecte et validation des données
            const formData = collectFormData();
            console.log("📋 Form data collected:", formData);
            
            // ✅ CORRECTION: Validation spécifique pour les formations
            formData.articles.forEach((article, index) => {
                if (article.type === 'Formation' || article.type === 'formation') {
                    if (!article.prix || article.prix === 0) {
                        console.log(`⚠️ Formation ${index + 1} sans prix détecté, tentative de récupération...`);
                        
                        // Récupérer depuis le DOM directement
                        const sections = document.querySelectorAll(".prestation-section");
                        const section = sections[index];
                        const prixInput = section?.querySelector(".formation-prix");
                        
                        if (prixInput && prixInput.value) {
                            article.prix = parseFloat(prixInput.value);
                            console.log(`✅ Prix récupéré: ${article.prix} pour ${article.designation}`);
                        }
                    }
                }
            });
            
            const isValid = validateFormData(formData);
            if (!isValid) {
                alert("Veuillez remplir tous les champs obligatoires.");
                return;
            }

            // ✅ ÉTAPE 2 : Envoyer directement à l'API
            const url = isEditMode ? `/api/proforma/${currentProformaId}` : "/api/proforma";
            const method = isEditMode ? "PUT" : "POST";

            console.log("🌐 Envoi vers:", url, "avec méthode:", method);

            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            console.log("📦 Réponse API:", data);

            if (response.ok && data.success) {
                if (isEditMode) {
                    document.getElementById('proformaModificationModal').style.display = 'flex';
                } else {
                    showProformaSuccessModal();
                    
                    if (data.client_created) {
                        const modal = document.getElementById('proformaSuccessModal');
                        const textEl = modal.querySelector('.modal-text');
                        const clientName = formData.client.nom;
                        
                        if (textEl) {
                            textEl.textContent = `Proforma enregistrée avec succès ! Un nouveau client "${clientName}" a été créé automatiquement.`;
                        }
                    }
                }
                
                closeSlideOver();
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                alert("Erreur: " + (data.message || "Impossible d'enregistrer"));
            }

        } catch (error) {
            console.error("💥 ERREUR:", error);
            alert("Erreur réseau: " + error.message);
        } finally {
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = "Enregistrer Proforma";
            }
        }
    }

    // ✅ FONCTION SÉPARÉE : Envoi direct
    async function submitProformaDirectly(formData) {
        const url = isEditMode ? `/api/proforma/${currentProformaId}` : "/api/proforma";
        const method = isEditMode ? "PUT" : "POST";

        const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
            if (data.client_created) {
                showSuccessModal("✅ Proforma enregistrée avec succès ! Un nouveau client a été ajouté automatiquement.");
            } else {
                showSuccessModal("✅ Proforma enregistrée avec succès !");
            }
            
            closeSlideOver();
            setTimeout(() => {
                closeProformaSuccessModal();
                window.location.reload();
            }, 2000);
        } else {
            alert("Erreur: " + (data.message || "Impossible d'enregistrer"));
        }
    }



    // ✅ Ajoute la proforma dans le tableau sans recharger
    function addProformaRowToTable(proforma) {
        const tbody = document.getElementById("proforma-tbody");
        const row = `
            <tr data-proforma-id="${proforma.proforma_id}" data-status="${proforma.etat}">
                <td>${proforma.numero}</td>
                <td>${proforma.date_creation}</td>
                <td>${proforma.client_nom}</td>
                <td>${proforma.total_ttc} FCFA</td>
                <td>-</td>
                <td>-</td>
                <td>
                    <span class="status-badge status-${proforma.etat || 'en_attente'}" 
                        onclick="changeProformaStatus(event, '${proforma.proforma_id}', '${proforma.etat || 'en_attente'}')">
                        ${proforma.etat === 'en_attente' || !proforma.etat ? 'En attente' :
                          proforma.etat === 'en_cours' ? 'En cours' :
                          proforma.etat === 'partiel' ? 'Partielle' :
                          proforma.etat === 'termine' ? 'Terminé' :
                          proforma.etat.charAt(0).toUpperCase() + proforma.etat.slice(1)}
                    </span>
                </td>
                <td>${proforma.created_by}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML("afterbegin", row);
    }

    function normalizePhoneForDB(phoneInput, itiInstance) {
        if (!phoneInput) return '';
        
        // Si intl-tel-input est disponible
        if (itiInstance && typeof itiInstance.getNumber === 'function') {
            try {
                if (typeof window.intlTelInputUtils !== 'undefined') {
                    // Utiliser E164 puis ajouter l'espace pour cohérence avec le répertoire
                    const e164 = itiInstance.getNumber(window.intlTelInputUtils.numberFormat.E164);
                    if (e164 && e164.startsWith('+')) {
                        const match = e164.match(/^\+(\d{1,3})(\d+)$/);
                        if (match) {
                            return `+${match[1]} ${match[2]}`;
                        }
                    }
                }
            } catch (e) {
                console.log('⚠️ Erreur intl-tel-input:', e);
            }
        }
        
        // Fallback manuel avec format d'affichage (même logique que répertoire)
        const clean = phoneInput.replace(/[^\d]/g, '');
        
        // Supprimer 00 s'il existe au début
        if (clean.startsWith('00')) {
            clean = clean.substring(2);
        }
        
        // Logique intelligente basée sur la longueur (cohérente avec répertoire)
        if (clean.length >= 8 && clean.length <= 9) {
            // Numéro local camerounais avec espace
            return `+237 ${clean}`;
        }
        if (clean.startsWith('237') && clean.length >= 11) {
            return `+237 ${clean.substring(3)}`;
        }
        if (clean.startsWith('00237')) {
            return `+237 ${clean.substring(5)}`;
        }
        
        // Autres pays - format avec espace pour cohérence
        if (clean.startsWith('1') && clean.length === 11) {
            return `+1 ${clean.substring(1)}`;
        }
        if (clean.length >= 10) {
            if (clean.startsWith('33') && clean.length >= 11) {
                return `+33 ${clean.substring(2)}`;
            }
            // Code pays à 3 chiffres + espace
            return `+${clean.substring(0, 3)} ${clean.substring(3)}`;
        }
        
        return '';
    }

    function collectFormData() {
        console.log("📊 collectFormData() called");
        
        const clientNameEl = document.getElementById("clientName");
        const addressEl = document.getElementById("address");
        const cityEl = document.getElementById("city");
        const countryEl = document.getElementById("client-country");
        const proformaDateEl = document.getElementById("proforma-date");
        const remiseEl = document.getElementById("remise");

        console.log("🔍 Form elements found:", {
            clientName: !!clientNameEl,
            address: !!addressEl,
            city: !!cityEl,
            country: !!countryEl,
            date: !!proformaDateEl,
            remise: !!remiseEl
        });

        // ✅ CORRECTION : Utiliser la même logique que le répertoire
        const phoneValue = document.getElementById("phone").value.trim();
        const phone = normalizePhoneForDB(phoneValue, iti);  // Format compact
        
        console.log("📞 Phone processing:");
        console.log("   Input:", phoneValue);
        console.log("   Normalized:", phone);

        const formData = {
            date: proformaDateEl ? proformaDateEl.value : new Date().toISOString().split('T')[0],
            client: {
                nom: clientNameEl ? clientNameEl.value : "",
                telephone: phone,  // ✅ Format compact: +237690072102
                adresse: addressEl ? addressEl.value : "",
                ville: cityEl ? cityEl.value : "",
                pays: countryEl ? countryEl.value : "Cameroun",
            },
            remise: remiseEl ? parseFloat(remiseEl.value) || 0 : 0,
            articles: collectArticlesData(),
            frais: collectFeesData(),
        };

        console.log("📋 Final form data:", formData);
        return formData;
    }


    function validateFormData(formData) {
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (field) {
                document.querySelectorAll('.field-error-indicator').forEach(el => el.remove());
                field.style.border = '2px solid #dc3545';
                
                const indicator = document.createElement('div');
                indicator.className = 'field-error-indicator';
                indicator.style.cssText = `
                    color: #dc3545;
                    font-size: 0.85rem;
                    margin-top: 5px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    font-weight: 500;
                `;
                indicator.innerHTML = `<span style="font-weight: bold;">⚠</span> Veuillez remplir ce champ.`;
                field.parentNode.insertBefore(indicator, field.nextSibling);
                field.focus();
                
                field.addEventListener('focus', function() {
                    field.style.border = '';
                    if (indicator.parentNode) {
                        indicator.remove();
                    }
                }, { once: true });
            }
        }
        
        // Validation client
        if (!formData.client.nom) {
            showFieldError("clientName", "Le nom du client est obligatoire");
            return false;
        }
        
        if (!formData.client.telephone) {
            showFieldError("phone", "Le téléphone du client est obligatoire");
            return false;
        }
        
        if (!formData.client.adresse) {
            showFieldError("address", "L'adresse du client est obligatoire");
            return false;
        }
        
        if (!formData.client.ville) {
            showFieldError("city", "La ville du client est obligatoire");
            return false;
        }
        
        // Validation chaque prestation avec gestion spéciale formations
    for (let i = 0; i < formData.articles.length; i++) {
        const article = formData.articles[i];
        
        if (!article.type) {
            alert(`⚠️ Veuillez sélectionner un type pour la prestation ${i + 1}.`);
            return false;
        }
        
        if (!article.designation) {
            alert(`⚠️ Veuillez sélectionner une désignation pour la prestation ${i + 1}.`);
            return false;
        }
        
        // VALIDATION SPÉCIALE POUR LES FORMATIONS
            if (article.type.toLowerCase() === 'formation') {
                if (!article.prix || article.prix <= 0) {
                    alert(`⚠️ Veuillez saisir un prix par heure pour la formation "${article.designation}" (prestation ${i + 1}).`);
                    
                    // FOCUS SUR LE CHAMP PRIX DE LA FORMATION
                    const sections = document.querySelectorAll(".prestation-section");
                    const section = sections[i];
                    if (section) {
                        const prixInput = section.querySelector(".formation-prix");
                        if (prixInput) {
                            prixInput.focus();
                            prixInput.style.border = '2px solid #dc3545';
                        }
                    }
                    return false;
                }
                
                if (!article.heures || article.heures <= 0) {
                    alert(`⚠️ Veuillez saisir le nombre d'heures pour la formation "${article.designation}" (prestation ${i + 1}).`);
                    return false;
                }
            } else {
                // Validation normale pour les autres types
                if (!article.prix || article.prix <= 0) {
                    alert(`⚠️ Le prix de la prestation ${i + 1} doit être supérieur à 0.`);
                    return false;
                }
            }
        }
        
        return true;
    }


    function resetEditMode() {
        isEditMode = false;
        currentProformaId = null;
        
        // Nettoyer les event listeners en douceur
        const phoneInput = document.getElementById("phone");
        if (phoneInput && iti) {
            // Recréer l'instance intl-tel-input
            iti.destroy();
            iti = window.intlTelInput(phoneInput, {
                initialCountry: "cm",
                separateDialCode: true,
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
            });
            
            phoneInput.addEventListener("blur", checkExistingClient);
            phoneInput.addEventListener("input", debounceCheckClient);
        }
        
        console.log("✅ Edit mode reset completed");
    }


    function collectArticlesData() {
        const articles = [];
        document.querySelectorAll(".prestation-section").forEach(section => {
            const type = section.querySelector(".prestation-type-select").value;
            if (!type) return;
            
            const article = { type };
            
            switch (type) {
                case "Livre":
                    collectLivreData(article, section);
                    break;
                case "Fourniture":
                    collectFournitureData(article, section);
                    break;
                case "Service":
                    collectServiceData(article, section);
                    break;
                case "Formation":
                    collectFormationData(article, section);
                    break;
            }
            
            articles.push(article);
        });
        return articles;
    }

    function collectLivreData(article, section) {
        const elements = {
            nature: section.querySelector(".livre-nature"),
            classe: section.querySelector(".livre-classe"),
            designation: section.querySelector(".livre-designation"),
            prix: section.querySelector(".livre-prix"),
            quantite: section.querySelector(".livre-quantity")
        };

        const selectedOption = elements.designation.selectedOptions[0];
        
        article.nature = elements.nature ? elements.nature.value : "";
        article.classe = elements.classe ? elements.classe.value : "";
        article.designation = selectedOption ? selectedOption.text : "";

        const value = selectedOption ? selectedOption.value : null;
        const parsedId = value && !isNaN(value) ? parseInt(value) : null;
        article.article_id = parsedId;

        article.prix = elements.prix ? parseFloat(elements.prix.value) || 0 : 0;
        article.quantite = elements.quantite ? parseInt(elements.quantite.value) || 1 : 1;
    }

    function collectFournitureData(article, section) {
        const elements = {
            ville: section.querySelector(".fourniture-ville-select"),
            designation: section.querySelector(".fourniture-designation"),
            prix: section.querySelector(".fourniture-prix"),
            quantite: section.querySelector(".fourniture-quantity")
        };

        article.ville_reference = elements.ville ? elements.ville.value : "";

        const selectedOption = elements.designation.selectedOptions[0];
        article.designation = selectedOption ? selectedOption.text : "";

        // ✅ Corriger ici : forcer un ID numérique valide ou null
        const value = selectedOption ? selectedOption.value : null;
        const parsedId = value && !isNaN(value) ? parseInt(value) : null;
        article.article_id = parsedId;

        article.prix = elements.prix ? parseFloat(elements.prix.value) || 0 : 0;
        article.quantite = elements.quantite ? parseInt(elements.quantite.value) || 1 : 1;
    }


    function collectServiceData(article, section) {
        const elements = {
            nature: section.querySelector(".service-nature-select"),
            precisez: section.querySelector(".service-precisez"),
            jours: section.querySelector(".service-jours"),
            prix: section.querySelector(".service-prix")
        };

        article.nature = elements.nature ? elements.nature.value : "";
        article.designation = elements.precisez && elements.precisez.style.display !== 'none' ? 
            elements.precisez.value : (elements.nature ? elements.nature.value : "");
        article.jours = elements.jours ? parseInt(elements.jours.value) || 1 : 1;
        article.prix = elements.prix ? parseFloat(elements.prix.value) || 0 : 0;
    }

function collectFormationData(article, section) {
    const elements = {
        designation: section.querySelector(".formation-designation-select"),
        heures: section.querySelector(".formation-heures"),
        prix: section.querySelector(".formation-prix")
    };

    console.log("🎓 DEBUG Formation collect - Elements:", {
        designation: !!elements.designation,
        heures: !!elements.heures,
        prix: !!elements.prix
    });

    // ✅ RÉCUPÉRATION DU TYPE ET DESIGNATION (pas d'article_id fixe)
    const selectedOption = elements.designation ? elements.designation.selectedOptions[0] : null;
    if (selectedOption && selectedOption.value && selectedOption.value !== "") {
        // Stocker l'ID de la formation pour référence
        article.formation_type_id = parseInt(selectedOption.value);
        article.designation = selectedOption.textContent.trim();
        console.log("✅ Formation:", article.designation);
    }

    // Heures
    const heuresValue = elements.heures ? parseInt(elements.heures.value) : null;
    article.heures = heuresValue && heuresValue > 0 ? heuresValue : 1;
    console.log("✅ Heures:", article.heures);
    
    // ✅ PRIX SAISI MANUELLEMENT (OBLIGATOIRE)
    const prixSaisi = elements.prix ? parseFloat(elements.prix.value) : null;
    
    if (prixSaisi !== null && prixSaisi > 0) {
        article.prix = prixSaisi;
        console.log("✅ Prix saisi utilisé:", article.prix);
    } else {
        article.prix = 0;
        console.warn("⚠️ Aucun prix saisi pour la formation");
    }

    console.log("🎓 Formation data final:", {
        formation_type_id: article.formation_type_id,
        designation: article.designation,
        heures: article.heures,
        prix: article.prix
    });
}

    function collectFeesData() {
        const fees = [];
        document.querySelectorAll(".supplementary-fee-section").forEach(section => {
            const typeEl = section.querySelector(".fee-type");
            const amountEl = section.querySelector(".fee-amount");
            const commentEl = section.querySelector(".fee-comment");

            const type = typeEl ? typeEl.value : "";
            const amount = amountEl ? parseFloat(amountEl.value) || 0 : 0;
            const comment = commentEl ? commentEl.value : "";
            
            if (amount > 0) {
                fees.push({ type, amount, comment });
            }
        });
        return fees;
    }

    // Fonctions utilitaires
    function formatCurrency(amount) {
        if (amount === 0 || isNaN(amount)) return "0 FCFA";
        // Utiliser le formatage français avec espaces comme séparateurs de milliers
        return new Intl.NumberFormat("fr-FR", {
            useGrouping: true,
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(Math.round(amount)).replace(/\s/g, ' ') + " FCFA";
    }

    function formatNumber(number) {
        if (number == 0) {
            return "0";
        }
        // Formatage cohérent avec espaces pour les milliers
        return new Intl.NumberFormat("fr-FR", {
            useGrouping: true,
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(parseInt(number)).replace(/\s/g, ' ');
    }



    function numberToWords(num) {
        if (num === 0 || isNaN(num)) return "zéro franc CFA";
        
        const ones = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf', 'dix', 
                     'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
        const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];
        
        function convertChunk(n) {
            let result = '';
            
            if (n >= 100) {
                const hundreds = Math.floor(n / 100);
                if (hundreds === 1) {
                    result += 'cent ';
                } else {
                    result += ones[hundreds] + ' cent ';
                }
                n %= 100;
            }
            
            if (n >= 20) {
                const tensDigit = Math.floor(n / 10);
                result += tens[tensDigit];
                n %= 10;
                if (n > 0) {
                    result += '-' + ones[n];
                }
            } else if (n > 0) {
                result += ones[n];
            }
            
            return result.trim();
        }
        
        const integerPart = Math.floor(num);
        
        if (integerPart === 0) return "zéro franc CFA";
        
        let result = '';
        
        if (integerPart >= 1000000) {
            const millions = Math.floor(integerPart / 1000000);
            result += convertChunk(millions) + ' million' + (millions > 1 ? 's' : '') + ' ';
        }
        
        const remainder = integerPart % 1000000;
        if (remainder >= 1000) {
            const thousands = Math.floor(remainder / 1000);
            if (thousands === 1) {
                result += 'mille ';
            } else {
                result += convertChunk(thousands) + ' mille ';
            }
        }
        
        const lastThree = remainder % 1000;
        if (lastThree > 0) {
            result += convertChunk(lastThree);
        }
        
        return result.trim() + ' franc' + (integerPart > 1 ? 's' : '') + ' CFA';
    }

    // ✅ GESTION DES TÉLÉCHARGEMENTS SELON STATUT
    function downloadProformaFromModal() {
        if (!currentModalProformaId) {
            alert("Erreur : Aucune proforma sélectionnée !");
            return;
        }
        
        closeProformaActionModal();
        
        // Récupérer le statut actuel de la proforma
        const row = document.querySelector(`tr[data-proforma-id="${currentModalProformaId}"]`);
        const currentStatus = row ? row.getAttribute('data-status') : 'en_attente';
        
        console.log("📄 Download requested for proforma:", currentModalProformaId, "status:", currentStatus);
        
        // ✅ DÉFINIR LES OPTIONS SELON LE STATUT
        let downloadOptions = [];
        let modalTitle = "Télécharger Document";
        
        switch(currentStatus) {
            case 'en_attente':
                downloadOptions = [
                    { type: 'proforma', label: 'Proforma', description: 'Document de devis' }
                ];
                modalTitle = "Document disponible";
                break;
                
            case 'en_cours':
                downloadOptions = [
                    { type: 'proforma', label: 'Proforma', description: 'Document de devis' },
                    { type: 'facture', label: 'Facture', description: 'Facture complète' },
                    { type: 'bon', label: 'Bon de Livraison', description: 'Bon de livraison complet' }
                ];
                break;
                
            case 'partiel':
                downloadOptions = [
                    { type: 'facture', label: 'Facture (Partielle)', description: 'Facture des éléments livrés' },
                    { type: 'bon', label: 'Bon de Livraison', description: 'Bon des éléments livrés' }
                ];
                break;
                
            case 'termine':
                // Aucun document à envoyer - commande terminée
                return;
                
            default:
                downloadOptions = [
                    { type: 'proforma', label: 'Proforma', description: 'Document par défaut' }
                ];
        }
        
        showDownloadOptionsModal(currentModalProformaId, downloadOptions, modalTitle);
    }

    // ✅ NOUVELLE FONCTION : Modal d'options de téléchargement
    function showDownloadOptionsModal(proformaId, options, title = "Télécharger Document") {
        const modal = document.getElementById("downloadModal");
        const optionsContainer = document.getElementById("download-options");
        const titleEl = modal.querySelector(".modal-title");
        
        if (titleEl) {
            titleEl.textContent = title;
        }
        
        let html = '';
        options.forEach(option => {
            html += `
                <button class="modal-button" onclick="downloadDocument('${option.type}')" 
                        style="margin: 8px; padding: 15px 20px; display: flex; flex-direction: column; align-items: center; min-width: 150px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${option.label}</div>
                    <div style="font-size: 0.85em; opacity: 0.8;">${option.description}</div>
                </button>
            `;
        });
        
        // ✅ AJOUTER BOUTON DÉTAILS (sauf pour statut terminé)
        if (options.length > 0) {
            html += `
                <button class="modal-button" onclick="showProformaDetails('${proformaId}')" 
                        style="margin: 8px; background: #17a2b8; min-width: 150px;">
                    Détails
                </button>
            `;
        }
        
        if (optionsContainer) {
            optionsContainer.innerHTML = html;
        }
        
        currentProformaId = proformaId;
        
        if (modal) {
            modal.style.display = "flex";
            console.log("Download modal opened with", options.length, "options for status");
        }
    }

    function openProformaActionModal(proformaId, numero, status) {
        if (!proformaId || proformaId === "undefined" || proformaId === "null") {
            console.error("❌ ID proforma invalide :", proformaId);
            alert("❌ ID proforma invalide !");
            return;
        }

        currentProformaId = proformaId; // ← C'est ça qui est essentiel

        document.getElementById("proformaActionModal").style.display = "flex";
    }

    window.confirmDeleteProforma = function() {
        console.log("🗑️ === DÉBUT SUPPRESSION ===");
        
        // CHERCHER L'ID DANS TOUTES LES SOURCES POSSIBLES
        let proformaId = window.currentDeleteProformaId || 
                        currentModalProformaId || 
                        currentProformaId;
        
        console.log("🔍 Variables de suppression:");
        console.log("  currentDeleteProformaId:", window.currentDeleteProformaId);
        console.log("  currentModalProformaId:", currentModalProformaId);
        console.log("  currentProformaId:", currentProformaId);
        console.log("  ID final utilisé:", proformaId);
        
        if (!proformaId || proformaId === "null" || proformaId === "undefined" || proformaId.toString().trim() === '') {
            console.error("❌ AUCUN ID VALIDE TROUVÉ");
            alert("❌ Erreur: ID proforma invalide ou manquant !");
            return;
        }
        
        // CONVERSION EN STRING POUR SÉCURITÉ
        proformaId = proformaId.toString();
        
        console.log("🚀 Suppression confirmée pour ID:", proformaId);

        // DÉSACTIVER LE BOUTON PENDANT LA REQUÊTE
        const deleteBtn = document.querySelector('#deleteModal .modal-button');
        if (deleteBtn) {
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Suppression...';
        }

        fetch(`/api/proforma/${proformaId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log("📡 Réponse suppression:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("📦 Data suppression:", data);
            
            if (data.success) {
                closeDeleteModal();
                showSuccessMessage("Proforma supprimée avec succès !");
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                alert("❌ Erreur: " + (data.message || "Suppression échouée"));
            }
        })
        .catch(error => {
            console.error("❌ Erreur réseau:", error);
            alert("❌ Erreur lors de la suppression: " + error.message);
        })
        .finally(() => {
            // RÉACTIVER LE BOUTON
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Supprimer';
            }
        });
    };


    function editProformaFromModal() {
        if (!currentProformaId) {
            alert("Erreur : ID proforma introuvable");
            return;
        }
        fetch(`/api/proforma/${currentProformaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateProformaForm(data.proforma); // Préremplir formulaire
                    openSlideOver(); // Ouvrir panneau latéral
                } else {
                    alert("Impossible de charger les détails de la proforma");
                }
            })
            .catch(error => {
                console.error("Erreur lors du chargement :", error);
                alert("Erreur réseau");
            });
    }


    function openDownloadModal(proformaId, status) {
        // Récupérer le statut mis à jour depuis l'interface
        const row = document.querySelector(`tr[data-proforma-id="${proformaId}"]`);
        const badge = row?.querySelector(".status-badge");
        const updatedStatus = badge?.className?.split(" ").find(c => c.startsWith("status-"))?.replace("status-", "") || status;

        currentProformaId = proformaId;
        currentProformaStatus = updatedStatus;

        const downloadOptions = document.getElementById("download-options");
        downloadOptions.innerHTML = ""; // Nettoyer

        // Affichage selon le statut réel à jour
        if (updatedStatus === "en_attente") {
            downloadOptions.innerHTML = `
                <button class="btn-action-rose" onclick="downloadDocument('proforma')">Proforma</button>
            `;
        } else if (updatedStatus === "en_cours") {
            downloadOptions.innerHTML = `
                <button class="btn-action-rose" onclick="downloadDocument('proforma')">Proforma</button>
                <button class="btn-action-rose" onclick="downloadDocument('facture')">Facture</button>
                <button class="btn-action-rose" onclick="downloadDocument('bon')">Bon de Livraison</button>
            `;
        } else {
            downloadOptions.innerHTML = "<p>Aucun document disponible pour ce statut</p>";
        }

        document.getElementById("downloadModal").style.display = "flex";
    }


    function closeProformaActionModal() {
        document.getElementById("proformaActionModal").style.display = "none";
    }

let pendingNewStatus = null;

function getStatusText(key){
  const map = { en_attente:'En attente', en_cours:'En cours', partiel:'Partiel', termine:'Terminé' };
  return map[key] || key;
}

function isTransitionAllowed(from,to){
  if (typeof window.isStatusTransitionAllowed === 'function') {
    try { return !!window.isStatusTransitionAllowed(from,to); } catch(e){}
  }
  return from !== to; // défaut : on interdit juste le même statut
}

function renderStatusButtons(current){
  const wrap = document.getElementById('status-actions');
  if (!wrap) return;
  wrap.querySelectorAll('.status-btn').forEach(btn=>{
    const s = btn.getAttribute('data-status');
    btn.classList.toggle('status-btn--active', s === current);
    const allowed = isTransitionAllowed(current, s);
    btn.disabled = (s === current) || !allowed;
    if (!allowed) btn.title = 'Transition non autorisée';

    btn.onclick = function(){
      if (btn.disabled) return;
      pendingNewStatus = s;                 // mémorise le choix
      openStatusConfirmModal(current, s);   // a) ferme statut et ouvre CONFIRM
    };
  });
}


function showStatusConfirmModal(from, to){
  console.log("🎯 Opening status confirm modal:", from, "->", to);
  
  // Créer ou récupérer le modal de confirmation
  let statusConfirmModal = document.getElementById('statusConfirmModal');
  
  // Si le modal n'existe pas, le créer
  if (!statusConfirmModal) {
    statusConfirmModal = document.createElement('div');
    statusConfirmModal.id = 'statusConfirmModal';
    statusConfirmModal.className = 'modal-backdrop';
    statusConfirmModal.style.display = 'none';
    document.body.appendChild(statusConfirmModal);
  }
  
  // Contenu du modal de confirmation
  statusConfirmModal.innerHTML = `
    <div class="modal-content" style="max-width:520px;">
      <button class="modal-close" onclick="closeStatusConfirmModal()">×</button>
      <div class="modal-icon">
        <svg class="svg-icon" viewBox="0 0 24 24">
          <path d="M12 8v5l4.28 2.54 1-1.64-3.72-2.23V8z"/>
        </svg>
      </div>
      <h5 class="modal-title">Confirmer le changement</h5>
      <p class="modal-text">Confirmer le passage de "${getStatusText(from)}" à "${getStatusText(to)}" ?</p>
      <div style="display:flex;gap:15px;justify-content:center;">
        <button class="btn-cancel" onclick="closeStatusConfirmModal()">Annuler</button>
        <button class="modal-button" id="statusConfirmBtn" onclick="confirmStatusChange()">Confirmer</button>
      </div>
    </div>
  `;
  
  // Afficher le modal
  statusConfirmModal.style.display = 'flex';
}

function closeStatusConfirmModal(){
  const m = document.getElementById('statusConfirmModal');
  if (m) m.style.display = 'none';
}

async function confirmStatusChange(){
  if (!currentProformaId || !pendingNewStatus) return;

  const b = document.getElementById('statusConfirmBtn');
  if (b){ b.disabled = true; b.innerHTML = 'Traitement… <span class="inline-spinner"></span>'; }

  // ---- CAS PARTICULIER : PARTIEL ----
  if (pendingNewStatus === 'partiel'){
    closeStatusConfirmModal();

    // b) pour Partiel : on ouvre la section partielle APRÈS confirmation
    const partialSection = document.getElementById('partialDeliverySection');
    const partialFooter  = document.getElementById('partial-footer');
    if (partialSection) partialSection.style.display = 'block';
    if (partialFooter)  partialFooter.style.display  = 'flex';
    try { loadPartialDeliveryItems(currentProformaId); } catch(e){}

    // bouton de validation partielle
    const validateBtn = document.getElementById('partialValidateBtn');
    if (validateBtn){
      validateBtn.onclick = async function(){
        const commentEl = document.getElementById('delivery-comment');
        const commentaire = commentEl ? (commentEl.value || '') : '';

        // Détecter le type de formulaire actif
        const isServiceForm = document.getElementById('serviceForm').style.display !== 'none';
        
        if (isServiceForm) {
          // Validation pour Service/Formation
          await validateServiceFormation(currentProformaId, commentaire);
        } else {
          // Validation pour Articles (Livres/Fournitures)
          await validateArticlesLivraison(currentProformaId, commentaire);
        }
      };
    }
    return; // on reste dans le statusModal (mode partiel)
  }

  // ---- AUTRES STATUTS : appliquer direct après confirmation ----
  const commentEl = document.getElementById('delivery-comment');
  const commentaire = commentEl ? (commentEl.value || '') : '';
  const ok = await updateProformaStatusWithAPI(currentProformaId, pendingNewStatus, commentaire);
  if (ok){
    updateProformaStatusVisual(currentProformaId, pendingNewStatus);
    try { updateKPITrends(); } catch(e){}
    closeStatusConfirmModal();
    closeStatusModal();
    
    // Recharger les données du tableau
    if (typeof loadProformas === 'function') {
      loadProformas();
    } else if (typeof filterProformas === 'function') {
      filterProformas();
    } else {
      console.log("🔄 Reloading page to update data...");
      window.location.reload();
    }
  } else {
    if (b){ b.disabled = false; b.innerHTML = 'Confirmer'; }
  }
}
window.confirmStatusChange = confirmStatusChange;
window.closeStatusConfirmModal = closeStatusConfirmModal;



    // ✅ FONCTION DE TÉLÉCHARGEMENT SÉCURISÉE
    function downloadDocument(type) {
        console.log("📥 Downloading document:", type, "for proforma:", currentProformaId);
        
        // Validation de l'ID proforma
        if (!currentProformaId || currentProformaId === 'undefined' || currentProformaId === 'null') {
            alert("Erreur: ID proforma manquant ou invalide");
            return;
        }
        
        // Validation du type de document
        const validTypes = ['proforma', 'facture', 'bon'];
        if (!validTypes.includes(type)) {
            alert(`Type de document invalide: ${type}`);
            return;
        }
        
        // Récupération du statut actuel depuis l'interface
        const row = document.querySelector(`tr[data-proforma-id="${currentProformaId}"]`);
        const currentStatus = row ? row.getAttribute('data-status') : 'en_attente';
        
        // Définition des documents autorisés selon le statut
        const allowedDocuments = {
            'en_attente': ['proforma'],
            'en_cours': ['proforma', 'facture', 'bon'],
            'partiel': ['facture', 'bon'],
            'termine': [] // Aucun document pour les commandes terminées
        };
        
        const allowed = allowedDocuments[currentStatus] || ['proforma'];
        
        // Vérification des autorisations
        if (!allowed.includes(type)) {
            const statusMessages = {
                'en_attente': 'Seule la proforma est disponible pour ce statut',
                'en_cours': 'Tous les documents sont disponibles',
                'partiel': 'Seules la facture et le bon de livraison sont disponibles',
                'termine': 'Aucun document n\'est disponible - commande terminée'
            };
            alert(`Document "${type}" non autorisé pour le statut "${currentStatus}". ${statusMessages[currentStatus]}`);
            return;
        }
        
        // Construction de l'URL de téléchargement
        const downloadUrl = `/api/proforma/${currentProformaId}/download/${type}`;
        console.log("📥 Download URL:", downloadUrl);
        
        // Tentative d'ouverture dans un nouvel onglet
        try {
            const downloadWindow = window.open(downloadUrl, '_blank');
            
            // Gestion des popups bloquées
            if (!downloadWindow || downloadWindow.closed || typeof downloadWindow.closed === 'undefined') {
                console.log("Popup bloquée, tentative de téléchargement direct");
                
                // Méthode alternative: création d'un lien temporaire
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `${type.toUpperCase()}_${currentProformaId}.pdf`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                // Nettoyage après un délai
                setTimeout(() => {
                    if (link.parentNode) {
                        document.body.removeChild(link);
                    }
                }, 100);
            }
            
            // Fermeture du modal après un délai
            setTimeout(() => {
                closeDownloadModal();
            }, 1000);
            
        } catch (error) {
            console.error("Erreur lors du téléchargement:", error);
            alert("Erreur lors du téléchargement du document. Veuillez réessayer.");
        }
    }




    // Fonction pour ouvrir le modal d'actions (clic sur ligne)
    window.openProformaActionModal = function(proformaId, proformaNumber, status) {
        console.log("🔥 Opening action modal for:", proformaId, proformaNumber, status);
        
        // ✅ VALIDATION IMMÉDIATE
        if (!proformaId || proformaId === 'undefined' || proformaId === 'null' || proformaId === null) {
            console.error("❌ CRITICAL: Invalid proforma ID:", proformaId);
            alert("Erreur: ID proforma invalide");
            return;
        }
        
        // ✅ DÉFINIR TOUTES LES VARIABLES GLOBALES
        const cleanId = proformaId.toString().trim();
        currentModalProformaId = cleanId;
        currentModalProformaStatus = status;
        currentProformaId = cleanId;  // Pour compatibilité
        
        console.log("✅ Variables définies:", {
            currentModalProformaId,
            currentModalProformaStatus,
            currentProformaId
        });
        
        // Afficher le modal
        const modal = document.getElementById('proformaActionModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    };

    // Fonction pour fermer le modal d'action
    window.closeProformaActionModal = function() {
        console.log("🔄 Closing action modal");
        const modal = document.getElementById('proformaActionModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentModalProformaId = null;
        currentModalProformaStatus = null;
    };

    window.editProformaFromModal = function() {
        console.log("✏️ Edit action triggered");
        console.log("📋 Current IDs - Modal:", currentModalProformaId, "Global:", currentProformaId);
        
        closeProformaActionModal();
        
        // ✅ UTILISER L'ID GLOBAL QUI EST MAINTENANT DÉFINI
        const idToUse = currentProformaId || currentModalProformaId;
        
        if (!idToUse || idToUse === 'null' || idToUse === 'undefined') {
            alert("Erreur: ID proforma invalide");
            return;
        }
        
        editProforma(idToUse);
    };

    window.deleteProformaFromModal = function() {
        console.log("🗑️ Delete action triggered");
        console.log("📋 Current IDs - Modal:", currentModalProformaId, "Global:", currentProformaId);
        
        // ✅ UTILISER L'ID GLOBAL QUI EST MAINTENANT DÉFINI
        const idToUse = currentProformaId || currentModalProformaId;
        
        if (!idToUse || idToUse === 'null' || idToUse === 'undefined') {
            alert("Erreur: ID proforma invalide");
            return;
        }
        
        // ✅ FERMER LE MODAL D'ACTION ET OUVRIR LE MODAL DE CONFIRMATION
        closeProformaActionModal();
        showDeleteModal(idToUse);
    };

    // ÉTAPE 3: Modal de téléchargement
    window.showDownloadModal = function(proformaId, status) {
        console.log("📄 Showing download modal for:", proformaId, "status:", status);
        
        currentProformaId = proformaId;
        const modal = document.getElementById("downloadModal");
        const optionsContainer = document.getElementById("download-options");
        const introText = document.getElementById("download-intro"); // Ajouté ici

        let options = '';

        switch (status) {
            case 'en_attente':
                if (introText) introText.style.display = 'block';
                options = `
                    <button class="modal-button" onclick="downloadDocument('proforma')">
                        Proforma
                    </button>
                `;
                break;

            case 'en_cours':
                if (introText) introText.style.display = 'block';
                options = `
                    <button class="modal-button" onclick="downloadDocument('proforma')">
                        Proforma
                    </button>
                    <button class="modal-button" onclick="downloadDocument('facture')">
                        Facture
                    </button>
                    <button class="modal-button" onclick="downloadDocument('bon')">
                        Bon de Livraison
                    </button>
                `;
                break;

            case 'partiel':
                if (introText) introText.style.display = 'block';
                options = `
                    <button class="modal-button" onclick="downloadDocument('facture')">
                        Facture (partielle)
                    </button>
                    <button class="modal-button" onclick="downloadDocument('bon')">
                        Bon de Livraison
                    </button>
                `;
                break;

            case 'termine':
                if (introText) introText.style.display = 'none'; // Masquer le texte
                options = `
                    <p style="text-align:center;">Aucun document disponible pour ce statut</p>
                `;
                break;

            default:
                if (introText) introText.style.display = 'none'; // Masquer par défaut
                options = '<p>Aucun document disponible pour ce statut</p>';
        }

        if (optionsContainer) {
            optionsContainer.innerHTML = options;
        }

        if (modal) {
            modal.style.display = "flex";
            console.log("✅ Download modal opened with options for status:", status);
        }
    };


    // Fonction de téléchargement de document avec validation du statut
window.downloadDocument = function(type) {
    console.log("📥 Downloading document:", type, "for proforma:", currentModalProformaId || currentProformaId);
    
    // Validation de l'ID proforma
    const proformaId = currentModalProformaId || currentProformaId;
    if (!proformaId || proformaId === 'undefined' || proformaId === 'null') {
        alert("Erreur: ID proforma manquant ou invalide");
        return;
    }
    
    // Validation du type de document
    const validTypes = ['proforma', 'facture', 'bon'];
    if (!validTypes.includes(type)) {
        alert(`Type de document invalide: ${type}`);
        return;
    }
    
    // Récupération du statut actuel depuis l'interface
    const row = document.querySelector(`tr[data-proforma-id="${proformaId}"]`);
    const currentStatus = row ? row.getAttribute('data-status') : 'en_attente';
    
    // Définition des documents autorisés selon le statut
    const allowed = getAllowedDocumentsByStatus(currentStatus);
    
    // Vérification des autorisations avec messages spécifiques
    if (!allowed.includes(type)) {
        const statusMessages = {
            'en_attente': 'Seule la proforma est disponible pour ce statut',
            'en_cours': 'Tous les documents sont disponibles',
            'partiel': 'Proforma, facture partielle et bon de livraison sont disponibles',
            'termine': 'Aucun document n\'est disponible - commande terminée'
        };
        alert(`Document "${type}" non autorisé pour le statut "${currentStatus}". ${statusMessages[currentStatus]}`);
        return;
    }
    
    // Construction de l'URL de téléchargement
    const downloadUrl = `/api/proforma/${proformaId}/download/${type}`;
    console.log("📥 Download URL:", downloadUrl);
    
    try {
        // Ouverture du document dans un nouvel onglet
        const downloadWindow = window.open(downloadUrl, '_blank');
        
        // Vérification si le popup a été bloqué
        if (!downloadWindow || downloadWindow.closed || typeof downloadWindow.closed === 'undefined') {
            console.log("Popup bloquée, tentative de téléchargement direct");
            
            // Méthode alternative avec création d'un lien temporaire
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${type.toUpperCase()}_${proformaId}.pdf`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            
            // Nettoyage du lien temporaire
            setTimeout(() => {
                if (link.parentNode) {
                    document.body.removeChild(link);
                }
            }, 100);
        }
        
        // Fermeture du modal après un délai
        setTimeout(() => {
            closeDownloadModal();
        }, 1000);
        
    } catch (error) {
        console.error("Erreur lors du téléchargement:", error);
        alert("Erreur lors du téléchargement du document. Veuillez réessayer.");
    }
};

    window.closeDownloadModal = function() {
        console.log("🔄 Closing download modal");
        const modal = document.getElementById("downloadModal");
        if (modal) {
            modal.style.display = "none";
        }
    };

    window.editProforma = function(proformaId) {
        console.log("🔧 Starting edit for proforma ID:", proformaId);
        
        if (!proformaId || proformaId === 'null') {
            alert("Erreur: ID proforma invalide");
            return;
        }
        
        currentProformaId = proformaId;
        isEditMode = true;
        
        // ✅ REQUÊTE AVEC TOUS LES DÉTAILS
        fetch(`/api/proforma/${proformaId}?include_articles=true&include_frais=true&include_client=true`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("📦 Edit data received:", data);
                if (data.success && data.proforma) {
                    const slideOverTitle = document.getElementById("slide-over-title");
                    if (slideOverTitle) {
                        slideOverTitle.textContent = "Modifier Proforma";
                    }
                    
                    populateFormWithData(data.proforma);
                    
                    const slideOver = document.getElementById("slide-over");
                    if (slideOver) {
                        slideOver.classList.add("open");
                    }
                } else {
                    alert("Erreur: Impossible de charger les données");
                }
            })
            .catch(error => {
                console.error('❌ Erreur:', error);
                alert("Erreur lors du chargement: " + error.message);
            });
    };

    window.showDeleteModal = function(proformaId) {
        console.log("🗑️ Showing delete modal for:", proformaId);
        
        // ✅ S'ASSURER QUE L'ID EST STOCKÉ GLOBALEMENT
        currentModalProformaId = proformaId;
        currentProformaId = proformaId;
        
        const modal = document.getElementById("deleteModal");
        if (modal) {
            modal.style.display = "flex";
        }
    };

    window.closeDeleteModal = function() {
        const modal = document.getElementById("deleteModal");
        if (modal) {
            modal.style.display = "none";
        }
        
        // NETTOYER LES VARIABLES
        window.currentDeleteProformaId = null;
    };

    function openProformaActionModal(proformaId, numero, status) {
        console.log("🧪 ID reçu :", proformaId);  // ← Tu dois voir l'ID réel dans la console

        if (!proformaId || proformaId === "undefined" || proformaId === "null") {
            console.error("Invalid proforma ID in row:", proformaId);
            alert("Erreur: ID proforma invalide");
            return;
        }

        // ✅ Ici on met à jour la BONNE variable utilisée pour la suppression
        currentModalProformaId = proformaId;
        currentModalProformaStatus = status;

        // On ouvre le modal
        document.getElementById("proformaActionModal").style.display = "flex";
    }


    // Modal de modification de statut
    window.showStatusModal = function(proformaId) {
        console.log("⚡ Showing status modal for:", proformaId);
        
        currentProformaId = proformaId;
        const modal = document.getElementById("statusModal");
        const statusSelect = document.getElementById("new-status-select");
        const partialSection = document.getElementById("partialDeliverySection");
        
        if (statusSelect) {
            statusSelect.value = "";
        }
        if (partialSection) {
            partialSection.style.display = "none";
        }
        
        if (statusSelect) {
            statusSelect.replaceWith(statusSelect.cloneNode(true));
            const freshSelect = document.getElementById("new-status-select");
            
            freshSelect.addEventListener("change", function() {
                const partialSection = document.getElementById("partialDeliverySection");
                
                if (this.value === "partiel") {
                    if (partialSection) {
                        partialSection.style.display = "block";
                        loadPartialDeliveryItems(proformaId);
                    }
                } else {
                    if (partialSection) {
                        partialSection.style.display = "none";
                    }
                }
            });
        }
        
        if (modal) {
            modal.style.display = "flex";
            console.log("✅ Status modal opened");
        }
    };

    window.closeStatusModal = function() {
        console.log("🔄 Closing status modal");
        const modal = document.getElementById("statusModal");
        if (modal) {
            modal.style.display = "none";
        }
    };
    
    window.saveStatusChange = function() {
        console.log("🔄 saveStatusChange appelée avec ID:", currentProformaId);
        
        const modal = document.getElementById("statusModal");
        const newStatusEl = document.getElementById("new-status-select");
        const commentaireEl = document.getElementById("delivery-comment");

        // Validation des éléments requis
        if (!newStatusEl || !newStatusEl.value) {
            alert("Veuillez sélectionner un nouveau statut");
            return;
        }
        
        const newStatus = newStatusEl.value;
        const commentaire = commentaireEl ? commentaireEl.value.trim() : '';
        
        // Validation stricte de l'ID proforma
        if (!currentProformaId || currentProformaId === 'undefined' || currentProformaId === 'null') {
            alert("Erreur: ID proforma manquant ou invalide");
            console.error("❌ currentProformaId is invalid:", currentProformaId);
            return;
        }
        
        // Validation du nouveau statut  
        const validStatuses = ['en_attente', 'en_cours', 'partiel', 'termine'];
        if (!validStatuses.includes(newStatus)) {
            alert("Erreur: Statut sélectionné invalide");
            console.error("❌ Invalid new status:", newStatus);
            return;
        }
        
        console.log(`🔄 DÉBUT SAVE STATUS: ${currentProformaId} -> ${newStatus}`);
        
        // Désactiver le bouton pendant le traitement
        const saveButton = modal.querySelector('.modal-button');
        const originalText = saveButton ? saveButton.textContent : 'Enregistrer';
        if (saveButton) {
            saveButton.disabled = true;
            saveButton.textContent = 'Mise à jour...';
        }
        
        // Appel API direct
        fetch(`/api/proforma/${currentProformaId}/status`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 
                statut: newStatus,
                commentaire: commentaire 
            })
        })
        .then(response => {
            console.log(`📡 Response status: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`📡 Response data:`, data);
            
            if (data.success) {
                console.log(`✅ API Success: ${currentProformaId} -> ${newStatus}`);
                
                // 1. Fermer le modal immédiatement
                closeStatusModal();
                
                // 2. Mise à jour visuelle
                const visualSuccess = updateProformaStatusVisual(currentProformaId, newStatus);
                console.log(`🔍 Visual update result: ${visualSuccess}`);
                
                // 3. Message de succès
                showSuccessMessage(`Statut mis à jour vers "${getStatusText(newStatus)}"`);
                
                // 4. FORCER LE REFRESH APRÈS 2 SECONDES SYSTÉMATIQUEMENT
                console.log("⏰ Programmation du refresh dans 2 secondes...");
                setTimeout(() => {
                    console.log("🔄 REFRESH AUTOMATIQUE FORCÉ");
                    window.location.reload();
                }, 2000);
                
            } else {
                console.error('❌ API Error:', data.message);
                alert('Erreur: ' + (data.message || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('❌ Network Error:', error);
            alert('Erreur réseau: ' + error.message);
        })
        .finally(() => {
            // Réactiver le bouton
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        });
    };

    // ÉTAPE 2: Modal nouveau client
    window.closeNewClientModal = function() {
        const modal = document.getElementById("newClientModal");
        if (modal) {
            modal.style.display = "none";
        }
    };

    window.confirmNewClient = function() {
        closeNewClientModal();
        const clientData = {
            nom: document.getElementById("clientName").value,
            telephone: iti ? iti.getNumber() : document.getElementById("phone").value,
            adresse: document.getElementById("address").value,
            ville: document.getElementById("city").value,
            pays: document.getElementById("client-country").value
        };

        fetch('/api/clients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clientData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessModal("Nouveau client enregistré avec succès!");
                setTimeout(() => location.reload(), 2000);
            } else {
                alert("Erreur lors de l'enregistrement du client: " + data.message);
            }
        })
        .catch(error => console.error('Erreur:', error));
    };

    function showNewClientModal() {
        const modal = document.getElementById("newClientModal");
        if (modal) {
            modal.style.display = "flex";
        }
    }

    function showStatusModal(proformaId) {
        console.log("⚡ Showing status modal for:", proformaId);
        
        currentProformaId = proformaId;
        const modal = document.getElementById("statusModal");
        const statusSelect = document.getElementById("new-status-select");
        const partialSection = document.getElementById("partialDeliverySection");
        
        // Reset du modal
        if (statusSelect) {
            statusSelect.value = "";
            // Supprimer les anciens event listeners
            statusSelect.replaceWith(statusSelect.cloneNode(true));
            const freshSelect = document.getElementById("new-status-select");
            
            // Ajouter le nouvel event listener
            freshSelect.addEventListener("change", function() {
                const partialSection = document.getElementById("partialDeliverySection");
                
                if (this.value === "partiel") {
                    if (partialSection) {
                        partialSection.style.display = "block";
                        loadPartialDeliveryItems(proformaId);
                    }
                } else {
                    if (partialSection) {
                        partialSection.style.display = "none";
                    }
                }
            });
        }
        
        if (partialSection) {
            partialSection.style.display = "none";
        }
        
        if (modal) {
            modal.style.display = "flex";
            console.log("✅ Status modal opened");
        }
    }

    // NOUVELLE FONCTION : Charger les articles pour livraison partielle
    function loadPartialDeliveryItems(proformaId) {
        console.log("Loading partial delivery items for:", proformaId);
        
        fetch(`/api/proforma/${proformaId}/details`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentProformaData = data.proforma;
                    selectedArticles = [];
                    
                    // Détecter le type de prestation
                    const isServiceFormation = detectServiceFormation(data.proforma.articles);
                    
                    // Afficher le bon formulaire
                    if (isServiceFormation) {
                        showServiceForm(data.proforma);
                    } else {
                        showArticleForm(data.proforma);
                    }
                }
            })
            .catch(error => {
                console.error('❌ Erreur chargement articles:', error);
                alert("Erreur lors du chargement des articles");
            });
    }

    // Fonction pour détecter si c'est un service/formation
    function detectServiceFormation(articles) {
        if (!articles || articles.length === 0) return false;
        
        // Vérifier si tous les articles sont des services/formations
        return articles.every(article => {
            const designation = article.designation?.toLowerCase() || '';
            const type = article.type_article?.toLowerCase() || '';
            
            return designation.includes('service') || 
                   designation.includes('formation') || 
                   designation.includes('consultation') ||
                   designation.includes('accompagnement') ||
                   type === 'service' || 
                   type === 'formation';
        });
    }

    // Fonction pour afficher le formulaire service/formation
    function showServiceForm(proforma) {
        document.getElementById('serviceForm').style.display = 'block';
        document.getElementById('articleForm').style.display = 'none';
        
        // Calculer le total
        const total = proforma.articles?.reduce((sum, article) => sum + (article.prix * article.quantite), 0) || 0;
        
        // Récupérer les versements cumulés (à implémenter selon votre structure DB)
        const versementsCumules = proforma.versements_cumules || 0;
        
        // Afficher les informations
        document.getElementById('total-proforma-service').textContent = formatCurrency(total);
        document.getElementById('versements-cumules').textContent = formatCurrency(versementsCumules);
        
        // Calculer le reste
        updateResteService();
        
        // Event listener pour le nouveau versement
        document.getElementById('nouveau-versement').addEventListener('input', updateResteService);
    }

    // Fonction pour afficher le formulaire articles
    function showArticleForm(proforma) {
        document.getElementById('serviceForm').style.display = 'none';
        document.getElementById('articleForm').style.display = 'block';
        
        const container = document.getElementById("partialDeliveryItems");
        const totalProformaDisplay = document.getElementById("total-proforma-article");
        
        if (container && proforma.articles) {
            let html = '';
            let totalProforma = 0;
            
            proforma.articles.forEach((article, index) => {
                const totalArticle = article.prix * article.quantite;
                totalProforma += totalArticle;
                
                html += `
                    <div class="partial-item" style="display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid #eee;">
                        <input type="checkbox" class="item-checkbox" data-article-index="${index}" onchange="updatePartialSelection()">
                        <div style="flex: 1;">
                            <strong>${article.designation}</strong>
                            <div style="font-size: 0.85rem; color: #666;">
                                Quantité: ${article.quantite} | Prix unitaire: ${formatCurrency(article.prix)}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #d81b60;">
                            ${formatCurrency(totalArticle)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            totalProformaDisplay.textContent = formatCurrency(totalProforma);
            updatePartialSelection(); // Calcul initial
        }
    }

    // Fonction pour mettre à jour le reste pour les services
    function updateResteService() {
        const total = parseFloat(document.getElementById('total-proforma-service').textContent.replace(/[^\d]/g, '')) || 0;
        const versementsCumules = parseFloat(document.getElementById('versements-cumules').textContent.replace(/[^\d]/g, '')) || 0;
        const nouveauVersement = parseFloat(document.getElementById('nouveau-versement').value) || 0;
        
        const reste = total - versementsCumules - nouveauVersement;
        document.getElementById('reste-service').textContent = formatCurrency(Math.max(0, reste));
    }

    // Fonction de validation pour Service/Formation
    async function validateServiceFormation(proformaId, commentaire) {
        try {
            const nouveauVersement = parseFloat(document.getElementById('nouveau-versement').value) || 0;
            const reste = parseFloat(document.getElementById('reste-service').textContent.replace(/[^\d]/g, '')) || 0;
            
            // Créer une nouvelle vague d'historisation
            const vagueData = {
                proforma_id: proformaId,
                type: 'service_formation',
                versement: nouveauVersement,
                commentaire: commentaire,
                reste: reste,
                date_creation: new Date().toISOString()
            };
            
            // Appel API pour sauvegarder la vague (à implémenter selon votre structure)
            const success = await saveVagueHistorisation(vagueData);
            
            if (success) {
                // Mettre à jour le statut
                const ok = await updateProformaStatusWithAPI(proformaId, 'partiel', commentaire);
                if (ok) {
                    // Mettre à jour l'affichage dans le tableau
                    updateTableauVersements(proformaId, nouveauVersement, reste);
                    
                    // Fermer le modal et rafraîchir
                    closeStatusModal();
                    showSuccessMessage('Versement enregistré avec succès');
                    
                    // Rafraîchir la page
                    setTimeout(() => window.location.reload(), 1000);
                }
            }
        } catch (error) {
            console.error('❌ Erreur validation service/formation:', error);
            alert('Erreur lors de la validation');
        }
    }

    // Fonction de validation pour Articles (Livres/Fournitures)
    async function validateArticlesLivraison(proformaId, commentaire) {
        try {
            if (selectedArticles.length === 0) {
                alert('Veuillez sélectionner au moins un article à livrer');
                return;
            }
            
            const montantRecu = parseFloat(document.getElementById('montant-recu').value) || 0;
            const reste = parseFloat(document.getElementById('reste-a-payer').textContent.replace(/[^\d]/g, '')) || 0;
            
            // Créer une nouvelle vague d'historisation
            const vagueData = {
                proforma_id: proformaId,
                type: 'articles_livraison',
                articles_livres: selectedArticles,
                versement: montantRecu,
                commentaire: commentaire,
                reste: reste,
                date_creation: new Date().toISOString()
            };
            
            // Appel API pour sauvegarder la vague (à implémenter selon votre structure)
            const success = await saveVagueHistorisation(vagueData);
            
            if (success) {
                // Mettre à jour le statut
                const ok = await updateProformaStatusWithAPI(proformaId, 'partiel', commentaire);
                if (ok) {
                    // Mettre à jour l'affichage dans le tableau
                    updateTableauVersements(proformaId, montantRecu, reste);
                    
                    // Fermer le modal et rafraîchir
                    closeStatusModal();
                    showSuccessMessage('Livraison partielle enregistrée avec succès');
                    
                    // Rafraîchir la page
                    setTimeout(() => window.location.reload(), 1000);
                }
            }
        } catch (error) {
            console.error('❌ Erreur validation articles:', error);
            alert('Erreur lors de la validation');
        }
    }

    // Fonction pour sauvegarder une vague d'historisation (à implémenter selon votre structure DB)
    async function saveVagueHistorisation(vagueData) {
        try {
            // Appel API pour sauvegarder la vague
            const response = await fetch('/api/proforma/vague-historisation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(vagueData)
            });
            
            const data = await response.json();
            return data.success;
        } catch (error) {
            console.error('❌ Erreur sauvegarde vague:', error);
            return false;
        }
    }

    // Fonction pour mettre à jour l'affichage dans le tableau
    function updateTableauVersements(proformaId, versement, reste) {
        const row = document.querySelector(`tr[data-proforma-id="${proformaId}"]`);
        if (row) {
            // Mettre à jour la colonne Versement
            const versementCell = row.cells[4]; // 5ème colonne (index 4)
            if (versementCell) {
                versementCell.textContent = formatCurrency(versement);
            }
            
            // Mettre à jour la colonne Restant
            const restantCell = row.cells[5]; // 6ème colonne (index 5)
            if (restantCell) {
                restantCell.textContent = formatCurrency(reste);
            }
        }
    }

    // NOUVELLE FONCTION : Mise à jour de la sélection partielle
    function updatePartialSelection() {
        if (!currentProformaData || !currentProformaData.articles) return;
        
        selectedArticles = [];
        let montantSelectionne = 0;
        
        // Parcourir les checkboxes sélectionnées
        document.querySelectorAll(".item-checkbox:checked").forEach(checkbox => {
            const articleIndex = parseInt(checkbox.dataset.articleIndex);
            const article = currentProformaData.articles[articleIndex];
            
            if (article) {
                const totalArticle = article.prix * article.quantite;
                selectedArticles.push({
                    ...article,
                    index: articleIndex,
                    total: totalArticle
                });
                montantSelectionne += totalArticle;
            }
        });
        
        // Mettre à jour l'affichage
        const montantSelectionneDisplay = document.getElementById("montant-selectionne-display");
        const montantRecuInput = document.getElementById("montant-recu");
        const resteAPayerDisplay = document.getElementById("reste-a-payer");
        
        if (montantSelectionneDisplay) {
            montantSelectionneDisplay.textContent = formatCurrency(montantSelectionne);
        }
        
        // Auto-remplir le montant reçu avec le montant sélectionné
        if (montantRecuInput) {
            montantRecuInput.value = montantSelectionne;
            montantRecuInput.addEventListener('input', updateResteAPayer);
        }
        
        updateResteAPayer();
        
        console.log(`Sélection mise à jour: ${selectedArticles.length} articles, ${formatCurrency(montantSelectionne)}`);
    }

    // NOUVELLE FONCTION : Calcul du reste à payer
    function updateResteAPayer() {
        if (!currentProformaData) return;
        
        const montantRecuInput = document.getElementById("montant-recu");
        const resteAPayerDisplay = document.getElementById("reste-a-payer");
        
        if (montantRecuInput && resteAPayerDisplay) {
            const montantRecu = parseFloat(montantRecuInput.value) || 0;
            const totalProforma = currentProformaData.total_ttc || 0;
            const resteAPayer = Math.max(0, totalProforma - montantRecu);
            
            resteAPayerDisplay.textContent = formatCurrency(resteAPayer);
            resteAPayerDisplay.style.color = resteAPayer > 0 ? '#d81b60' : '#28a745';
        }
    }

    // ✅ FONCTION AJOUTÉE : Afficher modal de succès
    window.showSuccessModal = function(message) {
        const modal = document.getElementById('proformaSuccessModal');
    const textEl = modal.querySelector('.modal-text');
    
    if (textEl) {
        textEl.textContent = message;
    }
    
    if (modal) {
        modal.style.display = 'flex';
        console.log('✅ Modal succès affiché:', message);
    }
};

    // ✅ FONCTION AJOUTÉE : Fermer modal succès
    window.closeProformaSuccessModal = function() {
        const modal = document.getElementById('proformaSuccessModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    window.closeSuccessModal = function() {
        const modal = document.getElementById("successModal");
        if (modal) {
            modal.style.display = "none";
        }
    };

    window.goToPage = function(page) {
        currentPage = page;
        const statusEl = document.getElementById("status-filter");
        const periodEl = document.getElementById("period-filter");
        
        const status = statusEl ? statusEl.value : "";
        const period = periodEl ? periodEl.value : "";
        
        filterProformas(status, period);
    };

    function filterProformas(status, period) {
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (period) params.append('period', period);
        params.append('page', currentPage);

        fetch(`/api/proformas/filter?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateProformaTable(data.proformas);
                    updatePagination(data.pagination);
                }
            })
            .catch(error => console.error('Erreur:', error));
    }

    window.deleteProformaFromModal = function() {
        console.log("🗑️ Delete action triggered");
        
        // RÉCUPÉRER L'ID DE PLUSIEURS SOURCES
        let proformaId = currentProformaId || currentModalProformaId;
        
        console.log("🔍 ID disponible:", proformaId);
        
        if (!proformaId || proformaId === 'null' || proformaId === 'undefined') {
            alert("Erreur: ID proforma invalide");
            return;
        }
        
        // STOCKER L'ID DANS TOUTES LES VARIABLES GLOBALES
        window.currentDeleteProformaId = proformaId;  // NOUVELLE VARIABLE DÉDIÉE
        currentModalProformaId = proformaId;
        currentProformaId = proformaId;
        
        closeProformaActionModal();
        
        // AFFICHER LE MODAL DE SUPPRESSION
        const deleteModal = document.getElementById("deleteModal");
        if (deleteModal) {
            deleteModal.style.display = "flex";
        }
    };


    function updateProformaTable(proformas) {
        const tbody = document.getElementById('proforma-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        proformas.forEach(proforma => {
            const row = document.createElement('tr');
            // ✅ VÉRIFIER QUE L'ID EST VALIDE AVANT DE L'ASSIGNER
            const proformaId = proforma.proforma_id || proforma.id;
            console.log("🔍 Setting row data - ID:", proformaId, "Status:", proforma.etat);

            if (proformaId && proformaId !== 'null') {
                row.dataset.proformaId = proformaId;
                row.dataset.status = proforma.etat;
            } else {
                console.error("❌ Invalid proforma ID:", proformaId);
                row.style.opacity = '0.5';
                row.style.pointerEvents = 'none';
                return; // Skip this row
            }
            
            row.innerHTML = `
                <td>${proforma.numero}</td>
                <td>${proforma.date_creation}</td>
                <td>${proforma.client_nom}</td>
                <td>${formatCurrency(proforma.total_ttc)}</td>
                <td>${proforma.montant_paye ? formatCurrency(proforma.montant_paye) : '-'}</td>
                <td>${proforma.montant_restant ? formatCurrency(proforma.montant_restant) : '-'}</td>
                <td>
                    <span class="status-badge status-${proforma.etat || 'en_attente'}" 
                        onclick="changeProformaStatus(event, '${proforma.proforma_id}', '${proforma.etat || 'en_attente'}')">
                        ${proforma.etat === 'en_attente' || !proforma.etat ? 'En attente' :
                          proforma.etat === 'en_cours' ? 'En cours' :
                          proforma.etat === 'partiel' ? 'Partielle' :
                          proforma.etat === 'termine' ? 'Terminé' :
                          proforma.etat.charAt(0).toUpperCase() + proforma.etat.slice(1)}
                    </span>
                </td>
                <td>${proforma.created_by}</td>
                <td style="display: none;"></td>
            `;
            
            rrow.onclick = function() {
                openProformaActionModal(proforma.proforma_id, proforma.numero, proforma.etat);
            };
            
            tbody.appendChild(row);
        });

        document.getElementById('proforma-count').textContent = proformas.length;
        const totalAmount = proformas.reduce((sum, p) => sum + p.total_ttc, 0);
        document.getElementById('proforma-total-amount').textContent = formatCurrency(totalAmount);
    }

    function updatePagination(paginationData) {
        currentPage = paginationData.page;
        totalPages = paginationData.pages;
        generatePagination(currentPage, totalPages);
    }

    function exportProformas() {
        console.log("📊 Exporting with current filters:", currentFilters);
        
        const params = new URLSearchParams();
        if (currentFilters.status) params.append('status', currentFilters.status);
        if (currentFilters.year) params.append('year', currentFilters.year);
        if (currentFilters.period) params.append('period', currentFilters.period);
        
        const exportUrl = `/api/export/proformas?${params}`;
        console.log("📊 Export URL:", exportUrl);
        
        // Ouvrir l'export dans un nouvel onglet
        window.open(exportUrl, '_blank');
    }

    function loadPartialDeliveryItems(proformaId) {
        console.log("📦 Loading articles for proforma:", proformaId);
        
        fetch(`/api/proforma/${proformaId}/articles`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("📦 Articles loaded:", data.articles);
                    
                    // Mettre à jour le contenu du modal de livraison partielle
                    const container = document.getElementById("partialDeliveryContent");
                    if (container) {
                        container.innerHTML = `
                            <div class="form-group">
                                <label style="font-weight: 600; margin-bottom: 15px; color: #333;">Sélection des articles à livrer :</label>
                                <div id="partialDeliveryItems" style="max-height: 400px; overflow-y: auto;">
                                    ${data.articles.map((article, index) => {
                                        const isServiceOrFormation = article.type === 'Service' || article.type === 'Formation';
                                        return `
                                        <div class="article-block" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                                <input type="checkbox" class="item-checkbox" data-article-id="${article.id}" data-prix="${article.prix_unitaire || 0}" data-quantite="${article.quantite}" data-type="${article.type}" onchange="updatePartialAmounts()" style="width: 18px; height: 18px; accent-color: #d81b60;">
                                                <div style="flex: 1;">
                                                    <h4 style="margin: 0 0 5px 0; color: #333; font-size: 16px;">${article.designation}</h4>
                                                    <p style="margin: 0; color: #666; font-size: 14px;">Type: ${article.type}</p>
                                                </div>
                                            </div>
                                            
                                            ${isServiceOrFormation ? `
                                            <!-- Pour Services et Formations : Avancement/Reste -->
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Avancement (%):</label>
                                                    <input type="number" class="form-control progress-input" min="0" max="100" value="0" data-article-id="${article.id}" onchange="updatePartialAmounts()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Reste (%):</label>
                                                    <div class="form-control" style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 6px; text-align: center; font-weight: 600;" id="reste-${article.id}">
                                                        100%
                                                    </div>
                                                </div>
                                            </div>
                                            ` : `
                                            <!-- Pour Livres et Fournitures : Prix/Quantité -->
                                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center;">
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Prix unitaire:</label>
                                                    <div class="form-control" style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 6px; text-align: center; font-weight: 600;">
                                                        ${formatCurrency(article.prix_unitaire || 0)}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Quantité totale:</label>
                                                    <div class="form-control" style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 6px; text-align: center; font-weight: 600;">
                                                        ${article.quantite}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Quantité à livrer:</label>
                                                    <input type="number" class="form-control quantity-input" min="0" max="${article.quantite}" value="0" data-article-id="${article.id}" onchange="updatePartialAmounts()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                                </div>
                                            </div>
                                            `}
                                            
                                            <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #d81b60, #ff8a80); border-radius: 6px; color: white;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: 500;">${isServiceOrFormation ? 'Montant pour cet article:' : 'Total pour cet article:'}</span>
                                                    <span style="font-weight: 600; font-size: 16px;" id="article-total-${article.id}">0 FCFA</span>
                                                </div>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <h4 style="margin: 0 0 15px 0; color: #333;">Récapitulatif financier</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Total:</label>
                                        <div class="form-control" style="background: white; border: 1px solid #ddd; padding: 12px; border-radius: 6px; text-align: center; font-weight: 600; font-size: 16px;">
                                            ${formatCurrency(data.total_proforma || 0)}
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Versement:</label>
                                        <input type="number" class="form-control" id="receivedAmount" value="0" onchange="updatePartialAmounts()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Reste:</label>
                                        <div class="form-control" id="remainingAmount" style="background: white; border: 1px solid #ddd; padding: 12px; border-radius: 6px; text-align: center; font-weight: 600; font-size: 16px; color: #d81b60;">
                                            0 FCFA
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">Commentaire sur la livraison:</label>
                                <textarea class="form-control" id="deliveryComment" rows="3" placeholder="Précisions sur la livraison partielle..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                                <button class="btn-cancel" onclick="closePartialDeliveryModal()" style="padding: 12px 24px; border: 1px solid #ddd; background: white; color: #666; border-radius: 6px; cursor: pointer; font-weight: 500;">Annuler</button>
                                <button class="modal-button" onclick="validatePartialDelivery()" style="padding: 12px 24px; background: linear-gradient(135deg, #d81b60, #ff8a80); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Valider la livraison partielle</button>
                            </div>
                        `;
                        
                        // Initialiser les montants
                        updatePartialAmounts();
                    }
                } else {
                    console.error("❌ Failed to load articles:", data.message);
                    const container = document.getElementById("partialDeliveryContent");
                    if (container) {
                        container.innerHTML = `<p style="color: red;">Erreur lors du chargement des articles: ${data.message}</p>`;
                    }
                }
            })
            .catch(error => {
                console.error('❌ Error loading articles:', error);
                const container = document.getElementById("partialDeliveryContent");
                if (container) {
                    container.innerHTML = `<p style="color: red;">Erreur lors du chargement des articles</p>`;
                }
            });
    }

    function openPartialDeliveryModal(proformaId) {
        console.log("📦 Opening partial delivery modal for proforma:", proformaId);
        
        // Créer ou récupérer le modal de livraison partielle
        let partialModal = document.getElementById('partialDeliveryModal');
        
        // Si le modal n'existe pas, le créer
        if (!partialModal) {
            partialModal = document.createElement('div');
            partialModal.id = 'partialDeliveryModal';
            partialModal.className = 'modal-backdrop';
            partialModal.style.display = 'none';
            document.body.appendChild(partialModal);
        }
        
        // Afficher le modal avec un loader pendant le chargement des articles
        partialModal.innerHTML = `
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <button class="modal-close" onclick="closePartialDeliveryModal()">×</button>
                <div class="modal-icon">
                    <svg class="svg-icon" viewBox="0 0 24 24">
                        <path d="M12 8v5l4.28 2.54 1-1.64-3.72-2.23V8z"/>
                    </svg>
                </div>
                <h5 class="modal-title">Livraison partielle</h5>
                <div class="modal-text">
                    <div id="partialDeliveryContent">
                        <p>Chargement des articles...</p>
                    </div>
                </div>
            </div>
        `;
        
        partialModal.style.display = 'flex';
        
        // Récupérer les articles de la proforma
        loadPartialDeliveryItems(proformaId);
    }

    function closePartialDeliveryModal() {
        const modal = document.getElementById('partialDeliveryModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function updatePartialAmounts() {
        let selectedAmount = 0;
        
        // Calculer le montant des articles sélectionnés et mettre à jour les totaux par article
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            const articleId = checkbox.dataset.articleId;
            const articleType = checkbox.dataset.type;
            const price = parseFloat(checkbox.dataset.prix) || 0;
            
            if (articleType === 'Service' || articleType === 'Formation') {
                // Pour Services et Formations : calcul basé sur l'avancement
                const progressInput = document.querySelector(`.progress-input[data-article-id="${articleId}"]`);
                if (progressInput) {
                    const progress = parseInt(progressInput.value) || 0;
                    const resteEl = document.getElementById(`reste-${articleId}`);
                    if (resteEl) {
                        resteEl.textContent = `${100 - progress}%`;
                    }
                    
                    // Calculer le montant basé sur l'avancement (pourcentage du prix total)
                    const articleTotal = (progress / 100) * price;
                    
                    // Mettre à jour le total de l'article
                    const articleTotalEl = document.getElementById(`article-total-${articleId}`);
                    if (articleTotalEl) {
                        articleTotalEl.textContent = formatCurrency(articleTotal);
                    }
                    
                    // Ajouter au montant sélectionné seulement si la checkbox est cochée
                    if (checkbox.checked) {
                        selectedAmount += articleTotal;
                    }
                }
            } else {
                // Pour Livres et Fournitures : calcul basé sur la quantité
                const quantityInput = document.querySelector(`.quantity-input[data-article-id="${articleId}"]`);
                if (quantityInput) {
                    const quantity = parseInt(quantityInput.value) || 0;
                    const articleTotal = quantity * price;
                    
                    // Mettre à jour le total de l'article
                    const articleTotalEl = document.getElementById(`article-total-${articleId}`);
                    if (articleTotalEl) {
                        articleTotalEl.textContent = formatCurrency(articleTotal);
                    }
                    
                    // Ajouter au montant sélectionné seulement si la checkbox est cochée
                    if (checkbox.checked) {
                        selectedAmount += articleTotal;
                    }
                }
            }
        });
        
        // Calculer le reste à payer (Total - Versement)
        const receivedAmount = parseFloat(document.getElementById('receivedAmount')?.value || 0);
        const remainingAmount = selectedAmount - receivedAmount;
        
        const remainingAmountEl = document.getElementById('remainingAmount');
        if (remainingAmountEl) {
            remainingAmountEl.textContent = formatCurrency(remainingAmount);
            remainingAmountEl.style.color = '#d81b60';
        }
    }

    function validatePartialDelivery() {
        const articlesLivres = collectPartialDeliveryData();
        const receivedAmount = parseFloat(document.getElementById('receivedAmount')?.value || 0);
        const comment = document.getElementById('deliveryComment')?.value || '';
        
        if (articlesLivres.length === 0) {
            alert('Veuillez sélectionner au moins un article à livrer.');
            return;
        }
        
        console.log("📦 Validating partial delivery:", {
            proformaId: currentProformaId,
            articles: articlesLivres,
            receivedAmount: receivedAmount,
            comment: comment
        });
        
        // Procéder au changement de statut avec les données de livraison partielle
        proceedWithStatusChange('partiel', {
            articles_livres: articlesLivres,
            montant_recu: receivedAmount,
            commentaire: comment
        });
        
        // Fermer le modal
        closePartialDeliveryModal();
    }

    function proceedWithStatusChange(newStatus, partialData = null) {
        console.log("🎯 Proceeding with status change to:", newStatus, "for proforma:", currentProformaId, "partial data:", partialData);
        
        // Validation finale
        if (!currentProformaId || !newStatus) {
            console.error("❌ Missing data for status change");
            alert("Erreur: données manquantes pour le changement de statut");
            return;
        }
        
        // Préparer les données pour l'API
        const updateData = {
            etat: newStatus,
            montant_paye: 0, // Sera calculé côté serveur selon le statut
            montant_restant: 0 // Sera calculé côté serveur selon le statut
        };
        
        // Ajouter les données de livraison partielle si nécessaire
        if (newStatus === 'partiel' && partialData) {
            updateData.articles_livres = partialData.articles_livres;
            updateData.montant_recu = partialData.montant_recu;
            updateData.commentaire = partialData.commentaire;
        }
        
        // Appel API pour mettre à jour le statut
        fetch(`/api/proforma/${currentProformaId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("✅ Status updated successfully:", data);
                
                // Mettre à jour l'affichage visuel
                updateProformaStatusVisual(currentProformaId, newStatus);
                
                // Recharger les données du tableau
                if (typeof loadProformas === 'function') {
                    loadProformas();
                } else if (typeof filterProformas === 'function') {
                    // Si loadProformas n'existe pas, essayer filterProformas
                    filterProformas();
                } else {
                    // Recharger la page si aucune fonction de rechargement n'est disponible
                    console.log("🔄 Reloading page to update data...");
                    window.location.reload();
                }
                
                // Afficher un message de succès
                const message = newStatus === 'partiel' ? 
                    `Livraison partielle validée pour ${partialData?.articles_livres?.length || 0} article(s)` :
                    `Statut mis à jour vers "${getStatusText(newStatus)}"`;
                showSuccessMessage(message);
                
            } else {
                console.error("❌ Failed to update status:", data.message);
                alert(`Erreur lors de la mise à jour: ${data.message}`);
            }
        })
        .catch(error => {
            console.error("❌ Error updating status:", error);
            alert("Erreur lors de la mise à jour du statut");
        })
        .finally(() => {
            // Nettoyer les variables globales
            currentProformaId = null;
            currentProformaStatus = null;
            pendingNewStatus = null;
        });
    }

    function collectPartialDeliveryData() {
        const articlesLivres = [];
        document.querySelectorAll(".item-checkbox:checked").forEach(checkbox => {
            const articleId = checkbox.dataset.articleId;
            const articleType = checkbox.dataset.type;
            
            if (articleType === 'Service' || articleType === 'Formation') {
                // Pour Services et Formations : récupérer l'avancement
                const progressInput = document.querySelector(`.progress-input[data-article-id="${articleId}"]`);
                if (progressInput) {
                    articlesLivres.push({
                        article_id: articleId,
                        type: articleType,
                        avancement: parseInt(progressInput.value) || 0
                    });
                }
            } else {
                // Pour Livres et Fournitures : récupérer la quantité
                const quantityInput = document.querySelector(`.quantity-input[data-article-id="${articleId}"]`);
                if (quantityInput) {
                    articlesLivres.push({
                        article_id: articleId,
                        type: articleType,
                        quantite_livree: parseInt(quantityInput.value) || 0
                    });
                }
            }
        });
        return articlesLivres;
    }

    function showSuccessMessage(message) {
        // Créer un toast de succès
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-weight: 500;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        `;
        toast.textContent = message;
        
        // Ajouter l'animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(toast);
        
        // Supprimer après 3 secondes
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    function populateFormWithData(proforma) {
        console.log("🔧 Populating form with data:", proforma);
        
        // 1. REMPLIR LES CHAMPS CLIENT
        if (proforma.client_nom) document.getElementById('clientName').value = proforma.client_nom;
        if (proforma.client_adresse) document.getElementById('address').value = proforma.client_adresse;
        if (proforma.client_ville) document.getElementById('city').value = proforma.client_ville;
        if (proforma.client_pays) document.getElementById('client-country').value = proforma.client_pays;
        if (proforma.date_creation) document.getElementById('proforma-date').value = proforma.date_creation;
        if (proforma.remise) document.getElementById('remise').value = proforma.remise;
        
        // 2. TÉLÉPHONE
        if (iti && proforma.client_telephone) {
            const phoneToSet = proforma.client_telephone.startsWith('+') ? 
                proforma.client_telephone : '+' + proforma.client_telephone;
            iti.setNumber(phoneToSet);
        }
        
        // 3. VIDER ET RECHARGER LES CONTENEURS
        const articlesContainer = document.getElementById("articles-container");
        const feesContainer = document.getElementById("supplementary-fees-container");
        
        if (articlesContainer) articlesContainer.innerHTML = "";
        if (feesContainer) feesContainer.innerHTML = "";
        
        // 4. CHARGER LES ARTICLES AVEC DÉTAILS COMPLETS
        if (proforma.articles && proforma.articles.length > 0) {
            console.log("📝 Loading articles:", proforma.articles);
            
            proforma.articles.forEach((article, index) => {
                console.log(`📝 Processing article ${index}:`, article);
                
                // STRUCTURER LES DONNÉES ARTICLE CORRECTEMENT avec debug
                const articleData = {
                    type: article.type || "service",
                    designation: article.designation || "",
                    prix: article.prix || 0,
                    quantite: article.quantite || 1,
                    nature: article.nature || null,
                    classe: article.classe || null,
                    article_id: article.article_id || null,
                    jours: article.jours || 1,
                    heures: article.heures || 1
                };

                console.log(`📚 Article ${index} data:`, articleData);
                
                console.log(`📝 Adding prestation row with data:`, articleData);
                addPrestationRow(articleData);
            });
        } else {
            console.log("📝 No articles found, adding default row");
            addPrestationRow();
        }
        
        // 5. CHARGER LES FRAIS SUPPLÉMENTAIRES
        if (proforma.frais && proforma.frais.length > 0) {
            console.log("💰 Loading fees:", proforma.frais);
            
            proforma.frais.forEach(fee => {
                const feeData = {
                    type: fee.type || "Livraison",
                    amount: fee.montant || fee.amount || 0,
                    comment: fee.commentaire || fee.comment || ""
                };
                addSupplementaryFeeRow(feeData);
            });
        } else {
            addSupplementaryFeeRow();
        }
        
        // 6. RECALCULER LES TOTAUX
        setTimeout(() => {
            updateCalculations();
            console.log("✅ Form population completed and calculations updated");
        }, 500);
    }

    function populateArticlesAndFees(proforma) {
        const articlesContainer = document.getElementById("articles-container");
        const feesContainer = document.getElementById("supplementary-fees-container");
        
        if (articlesContainer) articlesContainer.innerHTML = "";
        if (feesContainer) feesContainer.innerHTML = "";
        
        if (proforma.articles && proforma.articles.length > 0) {
            proforma.articles.forEach(article => addPrestationRow(article));
        } else {
            addPrestationRow();
        }
        
        if (proforma.frais && proforma.frais.length > 0) {
            proforma.frais.forEach(fee => addSupplementaryFeeRow(fee));
        } else {
            addSupplementaryFeeRow();
        }
    }

    // Gestion des événements clavier
    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape") {
            // Fermer toutes les modales ouvertes
            document.querySelectorAll(".modal-backdrop").forEach(modal => {
                if (modal.style.display === "flex") {
                    modal.style.display = "none";
                }
            });
            
            // Fermer le slide-over s'il est ouvert
            const slideOver = document.getElementById("slide-over");
            if (slideOver && slideOver.classList.contains("open")) {
                closeSlideOver();
            }
        }
    });

    // Fermer modales en cliquant sur le backdrop
    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("modal-backdrop")) {
            e.target.style.display = "none";
        }
    });

    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
        iti = window.intlTelInput(phoneInput, {
            initialCountry: "cm",
            separateDialCode: false,
            preferredCountries: ['cm', 'fr', 'us'],
            validationNumberTypes: ['MOBILE', 'FIXED_LINE', 'FIXED_LINE_OR_MOBILE'],
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
        });

        console.log("✅ intl-tel-input initialized for proforma phone");

        // Activer auto-complétion client
        phoneInput.addEventListener("blur", checkExistingClient);
        phoneInput.addEventListener("input", debounceCheckClient);
    }



    console.log("JavaScript initialization complete");

   // Délégation d'événements pour les clics
    document.addEventListener('click', function(e) {
        console.log("✅ Event delegation active:", e.target.id || e.target.className);

        // Nouvelle Proforma
        if (e.target && e.target.id === 'new-invoice-btn') {
            e.preventDefault();
            openNewProformaForm();
            return;
        }

        // Export
        if (e.target && e.target.id === 'export-btn') {
            e.preventDefault();
            exportProformas();
            return;
        }

        //  Ligne proforma clickée (éviter double événement avec boutons de statut)
        const row = e.target.closest('.proforma-table tbody tr');
        if (row && !e.target.closest('.status-btn')) { // Éviter double événement avec boutons de statut
            e.preventDefault();
            const proformaId = row.dataset.proformaId;
            const status = row.dataset.status;
            const numero = row.cells[0].textContent.trim();
            
            console.log("🎯 Row clicked - ID:", proformaId, "Status:", status, "Numero:", numero);
            
            if (proformaId && proformaId !== 'undefined' && proformaId !== 'null' && proformaId.trim() !== '') {
                openProformaActionModal(proformaId, numero, status);
            } else {
                console.error("❌ Invalid proforma ID in row:", proformaId);
                alert("Erreur: ID proforma invalide");
            }
            return;
        }
        
        // Fermer Slide-over
        if (e.target && e.target.id === 'slide-over-close') {
            e.preventDefault();
            closeSlideOver();
            return;
        }
    });

    bindActionButtons();

</script>
{% endblock %}
