{% extends 'base.html' %}
{% block title %}Répertoire{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <style>
        .content-area {
            padding: 30px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
        }

        .page-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .new-client-btn {
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .new-client-btn:hover {
            transform: translateY(-2px);
        }

        /* KPIs Section */
        .kpi-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .kpi-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .kpi-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #000;
            margin-bottom: 5px;
        }

        .kpi-trend {
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 5px;
        }

        .trend-up {
            color: #4CAF50;
        }
        
        .trend-up::before {
            content: "▲";
            margin-right: 3px;
        }

        .trend-down {
            color: #F44336;
        }
        
        .trend-down::before {
            content: "▼";
            margin-right: 3px;
        }

        /* Formulaire - Structure corrigée */
        .client-form {
            margin-top: 20px;
        }

        .form-header {
            margin-bottom: 30px;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .form-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .required-asterisk {
            color: #d81b60;
        }

        /* LIGNE 1: NOM COMPLET - MÊME LARGEUR QUE TÉLÉPHONE PRINCIPAL */
        .form-row-full {
            display: flex;
            margin-bottom: 20px;
        }

        .form-row-full .form-group {
            flex: 0 0 calc(50% - 10px);
            max-width: calc(50% - 10px);
        }

        /* LIGNE 2: TÉLÉPHONES (2 colonnes égales) - CORRECTION LARGEUR */
        .form-row-dual {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-dual .form-group {
            flex: 1;
            max-width: calc(50% - 10px);
        }

        .form-row-dual .form-group:first-child {
            flex: 0 0 calc(50% - 10px);
        }

        /* LIGNE 3: ADRESSE, VILLE, PAYS (3 colonnes égales) */
        .form-row-triple {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-triple .form-group {
            flex: 1;
            max-width: calc(33.333% - 14px);
        }

        /* STYLES DES INPUTS - Hauteur uniforme */
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95rem;
            background-position: 10px center;
            background-repeat: no-repeat;
            background-size: 20px;
            box-sizing: border-box;
            height: 44px;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #d81b60;
            outline: none;
        }

        /* ICÔNES POUR CHAMPS - Conservation des icônes existantes */
        #nom {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
        }

        #adresse {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>');
        }

        #ville {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15 11V5l-3-3-3 3v2H3v14h18V11h-6zm-8 8H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm6 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm6 12h-2v-2h2v2zm0-4h-2v-2h2v2z"/></svg>');
        }

        #pays {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>');
        }

        /* INTL-TEL-INPUT CORRECTIONS - Alignement avec autres champs + Drapeaux */
        .iti {
            width: 100% !important;
            display: block;
        }

        .iti__input {
            width: 100% !important;
            padding: 12px !important;
            border: 1px solid #ddd !important;
            border-radius: 5px !important;
            font-size: 0.95rem !important;
            box-sizing: border-box !important;
            height: 44px !important;
        }

        .iti__input:focus {
            border-color: #d81b60 !important;
            outline: none !important;
        }

        /* Correction des drapeaux - Affichage forcé */
        .iti__flag {
            background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/img/flags.png") !important;
        }

        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .iti__flag {
                background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/img/flags@2x.png") !important;
            }
        }

        .iti__country-list {
            z-index: 9999 !important;
        }

        /* Form actions */
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-save {
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .btn-save:hover {
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: #e0e0e0;
            color: #333;
            border: 1px solid #ccc;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-cancel:hover {
            background: #d5d5d5;
        }

        /* COULEUR ROSE POUR MODIFIER/HISTORIQUE */
        .btn-action-rose {
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-action-rose:hover {
            transform: translateY(-2px);
        }

        /* Table Section */
        .table-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .search-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-filters select,
        .search-filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .search-filters select:focus,
        .search-filters input:focus {
            border: 2px solid #d81b60;
            outline: none;
        }

        .export-btn {
            background: #f8d7da;
            color: #d81b60;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .export-btn:hover {
            background: #f5c6cb;
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .clients-table th,
        .clients-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        .clients-table th {
            background: #f8f9fa;
            font-weight: 500;
            color: #333;
        }

        .clients-table tbody tr {
            position: relative;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .clients-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* INDICATEUR D'ACTION AU SURVOL */
        .clients-table tbody tr::after {
            content: "⋮";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #d81b60;
            opacity: 0;
            cursor: pointer;
            transition: opacity 0.2s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .clients-table tbody tr:hover::after {
            opacity: 1;
        }

        .clients-table tbody tr::after:hover {
            background: rgba(216, 27, 96, 0.1);
        }

        /* PAGINATION */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(.disabled) {
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            color: white;
            transform: translateY(-2px);
        }

        .pagination button.active {
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            color: white;
            border-color: #d81b60;
        }

        .pagination button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
            color: #999;
        }

        .pagination .nav-btn {
            padding: 8px 16px;
            min-width: auto;
            font-weight: 500;
        }

        .pagination .ellipsis {
            background: none;
            border: none;
            cursor: default;
            padding: 8px 4px;
        }

        .pagination .ellipsis:hover {
            background: none;
            transform: none;
        }

        /* Modals */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 700px;
            max-width: 95%;
            text-align: center;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #d81b60;
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 1.8rem;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-text {
            color: #666;
            margin-bottom: 30px;
        }

        .modal-button {
            background: linear-gradient(90deg, #d81b60, #ff8a80);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .modal-button:hover {
            transform: translateY(-2px);
        }

        .svg-icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* Responsive - Adaptation mobile */
        @media (max-width: 1024px) {
            .kpi-section {
                flex-wrap: wrap;
            }
            .kpi-card {
                min-width: calc(50% - 10px);
            }
        }

        @media (max-width: 768px) {
            .form-row-dual,
            .form-row-triple {
                flex-direction: column;
                gap: 0;
            }
            
            .form-row-dual .form-group,
            .form-row-triple .form-group {
                max-width: 100%;
                margin-bottom: 20px;
            }
            
            .content-area {
                padding: 20px 15px;
            }
        }

        @media (max-width: 480px) {
            .table-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .pagination {
                gap: 3px;
            }
            .pagination button {
                min-width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }
        }

        /* Styles pour les notifications de succès */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .client-success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-weight: 500;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="content-area">
        <!-- Interface principale (Clients et KPIs) -->
        <div id="mainInterface">
            <div class="page-header">
                <h1 class="page-title">REPERTOIRE</h1>
                <button class="new-client-btn" onclick="showNewClientForm()">Nouveau Client +</button>
            </div>

            <!-- Section KPIs -->
            <div class="kpi-section">
                <div class="kpi-card">
                    <h3>Chiffre d'Affaires</h3>
                    <div class="value">{{ kpi_ca }}</div>
                    <div class="kpi-trend {% if kpi_ca_trend > 0 %}trend-up{% elif kpi_ca_trend < 0 %}trend-down{% endif %}">
                        {% if kpi_ca_trend > 0 %}+{% elif kpi_ca_trend < 0 %}-{% endif %}{{ kpi_ca_trend|abs }}%
                    </div>
                </div>
                <div class="kpi-card">
                    <h3>Total Clients</h3>
                    <div class="value">{{ kpi_total_clients }}</div>
                </div>
                <div class="kpi-card">
                    <h3>Ville la Plus Active</h3>
                    <div class="value">{{ kpi_top_city }}</div>
                    <div class="kpi-trend">
                        {{ kpi_top_city_count }} clients
                        {% if kpi_top_city_trend > 0 %}
                            <span class="trend-up">+{{ kpi_top_city_trend }}%</span>
                        {% elif kpi_top_city_trend < 0 %}
                            <span class="trend-down">{{ kpi_top_city_trend }}%</span>
                        {% endif %}
                    </div>
                </div>
                <div class="kpi-card">
                    <h3>Nouveaux Clients</h3>
                    <div class="value">{{ kpi_new_clients }}</div>
                    <div class="kpi-trend {% if kpi_new_clients_trend > 0 %}trend-up{% elif kpi_new_clients_trend < 0 %}trend-down{% endif %}">
                        {% if kpi_new_clients_trend > 0 %}+{% elif kpi_new_clients_trend < 0 %}-{% endif %}{{ kpi_new_clients_trend|abs }}%
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-section">
                <div class="table-controls">
                    <div class="table-section-title">Liste des Clients</div>
                    <div class="search-filters">
                        <input type="text" placeholder="Rechercher un client..." id="searchInput" value="{{ search }}">
                        <select id="filterCity">
                            <option value="">Toutes les villes</option>
                            {% for ville in villes %}
                                {% if ville and ville != 'Non renseigné' %}
                                    <option value="{{ ville }}" {% if ville_filter == ville %}selected{% endif %}>{{ ville }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button class="export-btn" id="export-btn">Exporter</button>
                    </div>
                </div>
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Nom</th>
                            <th style="width: 20%;">Téléphone</th>
                            <th style="width: 20%;">Tél. 2</th>
                            <th style="width: 10%;">Adresse</th>
                            <th style="width: 10%;">Ville</th>
                            <th style="width: 5%;">Commande</th>
                            <th style="width: 30%;">Versement</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for client in clients %}
                        {% if client.client_id and client.client_id != 'None' and client.client_id != 'null' and not client.client_id.startswith('temp_') %}
                        <tr onclick="openActionModal('{{ client.client_id }}', '{{ client.nom|replace("'", "\\'") }}')">
                        {% else %}
                        <tr style="opacity: 0.5; cursor: not-allowed;" title="Client sans ID valide - Action désactivée">
                        {% endif %}
                            <td>{{ client.nom }}{% if not client.client_id or client.client_id.startswith('temp_') %} ⚠️{% endif %}</td>
                            <td>{{ client.telephone }}</td>
                            <td>{{ client.telephone_secondaire or '-' }}</td>
                            <td>{{ client.adresse or '-' }}</td>
                            <td>{{ client.ville }}</td>
                            <td>{{ client.nb_commandes or 0 }}</td>
                            <td>{{ client.montant_total_paye }} FCFA</td>
                        </tr>
                    {% endfor %} 
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer">
                    <!-- Généré dynamiquement par JavaScript -->
                </div>
            </div>
        </div>

        <!-- Formulaire Nouveau Client - STRUCTURE CORRIGÉE -->
        <div id="newClientPage" style="display:none; padding:20px; background:#fff;">
            <div class="form-header">
                <h2 class="form-title">Clients / Nouveau client</h2>
                <p class="form-subtitle">Ajoutez un nouveau client avec ses coordonnées complètes.</p>
            </div>

            <form id="clientForm">
                <input type="hidden" id="clientId">

                <!-- LIGNE 1: NOM COMPLET - MÊME LARGEUR QUE TÉLÉPHONE PRINCIPAL -->
                <div class="form-row-full">
                    <div class="form-group">
                        <label for="nom">Nom complet <span class="required-asterisk">*</span></label>
                        <input type="text" id="nom" name="nom" placeholder="Nom du client" required>
                    </div>
                </div>

                <!-- LIGNE 2: TÉLÉPHONES (2 colonnes égales) -->
                <div class="form-row-dual">
                    <div class="form-group">
                        <label for="telephone">Téléphone principal <span class="required-asterisk">*</span></label>
                        <input type="tel" id="telephone" name="telephone" required>
                    </div>
                    <div class="form-group">
                        <label for="telephone_secondaire">Téléphone secondaire</label>
                        <input type="tel" id="telephone_secondaire" name="telephone_secondaire">
                    </div>
                </div>

                <!-- LIGNE 3: ADRESSE, VILLE, PAYS (3 colonnes égales) -->
                <div class="form-row-triple">
                    <div class="form-group">
                        <label for="adresse">Adresse complète <span class="required-asterisk">*</span></label>
                        <input type="text" id="adresse" name="adresse" placeholder="Adresse complète" required>
                    </div>
                    <div class="form-group">
                        <label for="ville">Ville <span class="required-asterisk">*</span></label>
                        <input type="text" id="ville" name="ville" placeholder="Ville de résidence" required>
                    </div>
                    <div class="form-group">
                        <label for="pays">Pays <span class="required-asterisk">*</span></label>
                        <input type="text" id="pays" name="pays" placeholder="Pays de résidence" required>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="showClientList()">Annuler</button>
                    <button type="submit" class="btn-save">Enregistrer le client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal d'actions - COULEURS UNIFORMISÉES -->
    <div class="modal-backdrop" id="actionModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeActionModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h5 class="modal-title">Actions Client</h5>
            <p id="actionModalClientName" class="modal-text"></p>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button class="btn-action-rose" onclick="editClientFromModal()">
                    <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    Modifier
                </button>
                <button class="btn-action-rose" onclick="viewHistoryFromModal()">
                    <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24">
                        <path d="M12 8v5l4.28 2.54 1-1.64-3.72-2.23V8z"/><path d="M12 4a8 8 0 108 8 8 8 0 00-8-8zm0 14a6 6 0 116-6 6 6 0 01-6 6z"/>
                    </svg>
                    Historique
                </button>  
                <button class="modal-button" onclick="deleteClientFromModal()">
                    <svg style="width: 16px; height: 16px; fill: white;" viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div class="modal-backdrop" id="confirmationModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h5 class="modal-title">Client ajouté avec succès</h5>
            <p class="modal-text">Les informations ont bien été enregistrées et sont prêtes pour la facturation.</p>
            <button class="modal-button" onclick="closeModal()">Retour à la liste des clients</button>
        </div>
    </div>

    <!-- Modal de confirmation pour modification -->
    <div class="modal-backdrop" id="modificationModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModificationModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
            </div>
            <h5 class="modal-title">Client modifié avec succès</h5>
            <p class="modal-text">Les informations du client ont été mises à jour avec succès.</p>
            <button class="modal-button" onclick="closeModificationModal()">Retour à la liste des clients</button>
        </div>
    </div>

    <!-- Modal de suppression -->
    <div class="modal-backdrop" id="deleteModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDeleteModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
                </svg>
            </div>
            <h5 class="modal-title">Confirmer la suppression</h5>
            <p class="modal-text">Êtes-vous sûr de vouloir supprimer ce client ? Cette action est irréversible.</p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn-cancel" onclick="closeDeleteModal()">Annuler</button>
                <button class="modal-button" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Modal d'historique -->
    <div class="modal-backdrop" id="historyModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeHistoryModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
                </svg>
            </div>
            <h5 class="modal-title">Historique des commandes</h5>
            <div id="historyContent" style="margin-top:20px; max-height: 300px; overflow-y: auto;">
                <p style="text-align:center; color:#666;">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Modal de doublon -->
    <div class="modal-backdrop" id="duplicateModal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDuplicateModal()">×</button>
            <div class="modal-icon">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
            </div>
            <h5 class="modal-title">Client existant</h5>
            <p id="duplicateMessage" class="modal-text"></p>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="btn-cancel" onclick="closeDuplicateModal()">Annuler</button>
                <button class="modal-button" onclick="editDuplicateClient()">Modifier</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script>
let itiPhone = null;
let itiPhoneSecondary = null;
let currentClientId = null;
let currentClientName = null;
let searchTimeout = null;

const currentPage = {{ current_page|default(1)|tojson }};
const totalPages = {{ total_pages|default(1)|tojson }};

document.addEventListener('DOMContentLoaded', function () {
    // CONFIGURATION INTL-TEL-INPUT AMÉLIORÉE AVEC FORMATAGE AUTOMATIQUE
    itiPhone = window.intlTelInput(document.getElementById('telephone'), {
        initialCountry: "cm",
        separateDialCode: true,
        preferredCountries: ['cm', 'fr', 'us', 'ca', 'gb'],
        formatOnDisplay: true,  // ✅ FORMATAGE AUTOMATIQUE
        autoPlaceholder: "aggressive",  // ✅ PLACEHOLDER INTELLIGENT
        validationNumberTypes: ['MOBILE', 'FIXED_LINE', 'FIXED_LINE_OR_MOBILE'],
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });

    itiPhoneSecondary = window.intlTelInput(document.getElementById('telephone_secondaire'), {
        initialCountry: "cm", 
        separateDialCode: true,
        preferredCountries: ['cm', 'fr', 'us', 'ca', 'gb'],
        formatOnDisplay: true,  // ✅ FORMATAGE AUTOMATIQUE
        autoPlaceholder: "aggressive",  // ✅ PLACEHOLDER INTELLIGENT
        validationNumberTypes: ['MOBILE', 'FIXED_LINE', 'FIXED_LINE_OR_MOBILE'],
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });

    generatePagination();

    document.getElementById('clientForm').addEventListener('submit', function (e) {
        e.preventDefault();
        saveClient();
    });

    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 1000);
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            applyFilters();
        }
    });
        
    document.getElementById('filterCity').addEventListener('change', applyFilters);

    // Export des clients
    document.getElementById('export-btn').addEventListener('click', function() {
        exportClients();
    });
});

// --- MODAL D'ACTIONS ---
// Ouvrir modal actions
function openActionModal(clientId, clientName) {
    console.log("✅ openActionModal déclenché avec ID:", clientId, "Nom:", clientName);
    currentClientId = clientId;
    currentClientName = clientName; // Stocker le nom pour les notifications
    document.getElementById('actionModalClientName').textContent = `Que souhaitez-vous faire avec "${clientName || 'Client inconnu'}" ?`;
    document.getElementById('actionModal').style.display = 'flex';
}

// Fermer modal actions (ne pas toucher à currentClientId)
function closeActionModal() {
    document.getElementById('actionModal').style.display = 'none';
}

// MODIFIER
function editClientFromModal() {
    console.log("✏️ editClientFromModal() - ID:", currentClientId);
    if (!currentClientId) {
        alert("Erreur: Aucun client sélectionné");
        return;
    }
    closeActionModal();
    editClient(currentClientId);
}


// SUPPRIMER
function deleteClientFromModal() {
    console.log("🛠 deleteClientFromModal() - ID:", currentClientId);
    if (!currentClientId) {
        alert("Erreur: Aucun client sélectionné");
        return;
    }
    closeActionModal();
    openDeleteModal(currentClientId);
}

// CONFIRM DELETE
function confirmDelete() {
    console.log("🚨 confirmDelete() avec ID:", currentClientId);
    if (!currentClientId) {
        alert("Erreur: ID invalide");
        return;
    }
    fetch(`/api/clients/${currentClientId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            console.log("✅ Réponse suppression:", data);
            if (data.success) {
                closeDeleteModal();
                showSuccessMessage(`Client "${currentClientName || 'inconnu'}" supprimé avec succès`);
                location.reload();
            } else {
                closeDeleteModal();
                // Afficher une notification stylisée au lieu d'un alert
                showSuccessMessage(`Impossible de supprimer "${currentClientName || 'ce client'}": Le client est lié à une proforma ou facture`);
            }
        })
        .catch(error => {
            console.error("❌ Erreur réseau DELETE:", error);
            closeDeleteModal();
            showSuccessMessage(`Erreur réseau lors de la suppression de "${currentClientName || 'ce client'}"`);
        });
}


// HISTORIQUE
function viewHistory(clientId) {
    fetch(`/api/clients/${clientId}/history`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('historyContent');
            if (!data.success || !data.history || data.history.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 40px 20px;">
                        <div style="color:#666; font-size: 16px; margin-bottom: 10px;">Aucune commande trouvée</div>
                        <div style="color:#999; font-size: 14px;">Ce client n'a pas encore de commandes enregistrées</div>
                    </div>
                `;
                return;
            }

            let html = `
                <table style="width:100%; border-collapse: collapse; font-size: 14px; table-layout: fixed;">
                    <thead>
                        <tr style="background:#f9f9f9; font-weight: 600;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:15%;">Date</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:18%;">Code</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:18%;">Montant</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:14%;">Statut</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Articles</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.history.forEach(item => {
                let articlesHtml = "<ul style='margin:0; padding-left:12px; list-style: disc;'>";
                if (item.articles && item.articles.length > 0) {
                    item.articles.forEach(a => {
                        articlesHtml += `<li style="margin:0 0 3px 0; font-size:13px;">${a.nom}</li>`;
                    });
                } else {
                    articlesHtml += `<li style="color:#666; font-style:italic;">Commande sans détail</li>`;
                }
                articlesHtml += "</ul>";

                // Normalisation du statut pour l'affichage
                let statusDisplay = item.status;
                if (item.status && item.status.toLowerCase().includes('termine')) {
                    statusDisplay = 'terminé';
                }

                html += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding: 12px; vertical-align: middle;">${item.date}</td>
                        <td style="padding: 12px; vertical-align: middle; font-family: monospace; font-weight: 500; white-space: nowrap;">${item.code}</td>
                        <td style="padding: 12px; text-align: left; vertical-align: middle; color: #2E7D32; font-weight: 600;"><span style="white-space: nowrap;">${item.montant}</span></td>
                        <td style="padding: 12px; text-align: left; vertical-align: middle;"><span style="background: #E8F5E8; color: #2E7D32; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; white-space: nowrap;">${statusDisplay}</span></td>
                        <td style="padding: 12px; vertical-align: middle;">${articlesHtml}</td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            container.innerHTML = html;
        })
        .catch(err => {
            document.getElementById('historyContent').innerHTML = `
                <div style="text-align:center; padding: 40px 20px;">
                    <div style="color:#d32f2f; font-size: 16px; margin-bottom: 10px;">Erreur lors du chargement</div>
                    <div style="color:#666; font-size: 14px;">Impossible de récupérer l'historique des commandes</div>
                </div>
            `;
            console.error('Erreur historique:', err);
        });
}

function viewHistoryFromModal() {
    console.log("📜 viewHistoryFromModal() - ID:", currentClientId);
    if (!currentClientId) {
        alert("Erreur: Aucun client sélectionné");
        return;
    }
    closeActionModal();
    viewHistory(currentClientId); // Appelle la bonne fonction
}


function generatePagination() {
    const container = document.getElementById('paginationContainer');
    let html = '';

    if (currentPage > 1) {
        html += `<button class="nav-btn" onclick="goToPage(${currentPage - 1})">Précédent</button>`;
    } else {
        html += `<button class="nav-btn disabled">Précédent</button>`;
    }

    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);

    if (currentPage <= 3) {
        endPage = Math.min(5, totalPages);
    }
    if (currentPage >= totalPages - 2) {
        startPage = Math.max(1, totalPages - 4);
    }

    if (startPage > 1) {
        html += `<button onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            html += `<button class="ellipsis">...</button>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        html += `<button class="${activeClass}" onclick="goToPage(${i})">${i}</button>`;
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<button class="ellipsis">...</button>`;
        }
        html += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }

    if (currentPage < totalPages) {
        html += `<button class="nav-btn" onclick="goToPage(${currentPage + 1})">Suivant</button>`;
    } else {
        html += `<button class="nav-btn disabled">Suivant</button>`;
    }

    container.innerHTML = html;
}

function showNewClientForm() {
    document.getElementById('mainInterface').style.display = 'none';
    document.getElementById('newClientPage').style.display = 'block';
    
    // ✅ IMPORTANT : Ne reset que si c'est vraiment un NOUVEAU client
    if (!currentClientId) {
        console.log('➕ Nouveau client - reset du formulaire');
        document.getElementById('clientForm').reset();
        
        // Reset des champs intl-tel-input seulement pour nouveau client
        if (itiPhone) {
            itiPhone.setNumber('');
        }
        if (itiPhoneSecondary) {
            itiPhoneSecondary.setNumber('');
        }
        
        // Titre pour nouveau client
        document.querySelector('.form-title').textContent = 'Clients / Nouveau client';
        document.querySelector('.form-subtitle').textContent = 'Ajoutez un nouveau client avec ses coordonnées complètes.';
    } else {
        console.log('✏️ Modification client - conservation des données pour ID:', currentClientId);
        // Ne pas faire de reset ! Les données seront remplies par editClient()
        // Le titre sera changé par editClient()
    }
}

function showClientList() {
    document.getElementById('newClientPage').style.display = 'none';
    document.getElementById('mainInterface').style.display = 'block';
}

function applyFilters() {
    const search = document.getElementById('searchInput').value;
    const ville = document.getElementById('filterCity').value;
    window.location.href = `/repertoire?page=1&search=${encodeURIComponent(search)}&ville=${encodeURIComponent(ville)}`;
}

function goToPage(page) {
    const search = document.getElementById('searchInput').value;
    const ville = document.getElementById('filterCity').value;
    window.location.href = `/repertoire?page=${page}&search=${encodeURIComponent(search)}&ville=${encodeURIComponent(ville)}`;
}

function normalizePhoneForDB(phoneInput, itiInstance) {
    if (!phoneInput) return '';
    
    // Si intl-tel-input est disponible
    if (itiInstance && typeof itiInstance.getNumber === 'function') {
        try {
            if (typeof window.intlTelInputUtils !== 'undefined') {
                // ✅ UTILISER E164 qui donne +237690486101 (compact)
                const e164 = itiInstance.getNumber(window.intlTelInputUtils.numberFormat.E164);
                if (e164 && e164.startsWith('+')) {
                    // ✅ Ajouter UN SEUL espace après code pays
                    const match = e164.match(/^\+(\d{1,3})(\d+)$/);
                    if (match) {
                        return `+${match[1]} ${match[2]}`;
                    }
                }
            }
        } catch (e) {
            console.log('⚠️ Erreur intl-tel-input:', e);
        }
    }
    
    // Fallback
    const clean = phoneInput.replace(/[^\d]/g, '');
    if (clean.length >= 8 && clean.length <= 9) {
        return `+237 ${clean}`;
    }
    if (clean.startsWith('237') && clean.length >= 11) {
        return `+237 ${clean.substring(3)}`;
    }
    return '';
}

// FONCTION saveClient CORRIGÉE - GESTION 409 SIMPLIFIÉE
function saveClient() {
    // Validation du formulaire
    const nom = document.getElementById('nom').value.trim();
    const adresse = document.getElementById('adresse').value.trim();
    const ville = document.getElementById('ville').value.trim();
    const pays = document.getElementById('pays').value.trim();

    // Vérifications des champs obligatoires
    if (!nom) {
        alert('Le nom est obligatoire');
        return;
    }
    
    if (!adresse) {
        alert('L\'adresse est obligatoire');
        return;
    }
    
    if (!ville) {
        alert('La ville est obligatoire');
        return;
    }
    
    if (!pays) {
        alert('Le pays est obligatoire');
        return;
    }

    // ✅ CORRECTION VALIDATION TÉLÉPHONE PRINCIPAL
    const phoneValue = document.getElementById('telephone').value.trim();
    if (!phoneValue || phoneValue.length < 8) {
        alert('Le numéro de téléphone principal est obligatoire et doit contenir au moins 8 chiffres');
        document.getElementById('telephone').focus();
        return;
    }

    // ✅ CORRECTION VALIDATION TÉLÉPHONE SECONDAIRE : Seulement si renseigné
    const telephoneSecondaireValue = document.getElementById('telephone_secondaire').value.trim();
    
    // Vérifier si le champ secondaire contient vraiment un numéro
    let hasSecondaryPhone = false;
    if (telephoneSecondaireValue && telephoneSecondaireValue.length > 0) {
        // Enlever l'indicatif pour vérifier s'il y a vraiment des chiffres
        const cleanSecondary = telephoneSecondaireValue.replace(/^\+237\s*/, '').replace(/[^\d]/g, '');
        if (cleanSecondary.length >= 8) {
            hasSecondaryPhone = true;
            
            // ✅ VALIDATION SEULEMENT SI UTILS CHARGÉ ET NUMÉRO RENSEIGNÉ
            if (typeof window.intlTelInputUtils !== 'undefined' && itiPhoneSecondary) {
                if (!itiPhoneSecondary.isValidNumber()) {
                    alert('Le numéro de téléphone secondaire est invalide. Laissez vide si vous n\'en avez pas.');
                    document.getElementById('telephone_secondaire').focus();
                    return;
                }
            }
        }
    }

    // RÉCUPÉRATION INTELLIGENTE DES NUMÉROS
let telephonePrincipal, telephoneSecondaire = '';

// Téléphone principal - Utiliser intl-tel-input en priorité
telephonePrincipal = normalizePhoneForDB(phoneValue, itiPhone);

// Téléphone secondaire (seulement si vraiment renseigné)
if (hasSecondaryPhone) {
    telephoneSecondaire = normalizePhoneForDB(telephoneSecondaireValue, itiPhoneSecondary);
}

console.log('📱 Téléphones formatés:');
console.log('   Principal:', telephonePrincipal);
console.log('   Secondaire:', telephoneSecondaire);

const clientData = {
    nom: nom,
    telephone: telephonePrincipal,
    telephone_secondaire: telephoneSecondaire || '',
    adresse: adresse,
    ville: ville,
    pays: pays
};

    // ✅ DÉTERMINATION CORRECTE DE LA MÉTHODE
    const isEditing = currentClientId && currentClientId !== null && currentClientId !== 'null';
    const method = isEditing ? 'PUT' : 'POST';
    const url = isEditing ? `/api/clients/${currentClientId}` : '/api/clients';

    console.log('🚀 AVANT ENVOI - Method:', method, '| URL:', url, '| currentClientId:', currentClientId);
    console.log('📤 Données client:', clientData);
    console.log('✅ Mode:', isEditing ? 'MODIFICATION' : 'CRÉATION');

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(clientData)
    })
    .then(response => {
        console.log('📥 Status reçu:', response.status, 'pour méthode:', method);
        
        // ✅ TRAITEMENT 409 SEULEMENT POUR CRÉATION (POST)
        if (response.status === 409 && method === 'POST') {
            console.log('🚨 Doublon détecté lors de la création !');
            return response.json().then(data => {
                console.log('📥 Données 409:', data);
                
                // Afficher le modal de doublon
                document.getElementById('duplicateMessage').textContent = data.message || 'Un client avec ce numéro existe déjà';
                
                if (data.client_id) {
                    document.getElementById('duplicateModal').setAttribute('data-client-id', data.client_id);
                }
                
                document.getElementById('duplicateModal').style.display = 'flex';
                console.log('✅ Modal doublon affiché');
            });
        }
        
        // ✅ TRAITEMENT 409 POUR MODIFICATION (PUT) - Erreur différente
        if (response.status === 409 && method === 'PUT') {
            return response.json().then(data => {
                alert('Erreur de modification : ' + (data.message || 'Conflit lors de la modification'));
            });
        }
        
        // ✅ AUTRES ERREURS
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Erreur HTTP ${response.status}`);
            });
        }
        
        return response.json();
    })
    .then(data => {
        if (!data) return; // Si 409 traité
        
        console.log('📥 Réponse succès:', data);
        if (data.success) {
            // Récupérer le nom du client pour personnaliser le message
            const clientName = document.getElementById('nom').value.trim();
            
            // ✅ MESSAGE ET ACTION DIFFÉRENTS SELON LE MODE
            if (method === 'PUT') {
                // Mode modification : notification de succès personnalisée
                showSuccessMessage(`Client "${clientName}" modifié avec succès`);
                // Fermer le formulaire et recharger la page
                showClientList();
                location.reload();
            } else {
                // Mode création : notification de succès personnalisée
                showSuccessMessage(`Client "${clientName}" ajouté avec succès`);
                // Fermer le formulaire et recharger la page
                showClientList();
                location.reload();
            }
        } else {
            alert(data.message || 'Erreur lors de l\'enregistrement');
        }
    })
    .catch(error => {
        console.error('❌ Erreur fetch:', error);
        alert('Erreur lors de l\'enregistrement: ' + error.message);
    });
}

// FONCTION EDIT CLIENT - INCHANGÉE
function editClient(clientId) {
    console.log('✏️ editClient appelé avec ID:', clientId);
    
    // ✅ VÉRIFICATION CRITIQUE : S'assurer que l'ID est valide
    if (!clientId || clientId === 'undefined' || clientId === 'null') {
        console.error('❌ ID client invalide dans editClient:', clientId);
        alert('Erreur : ID client invalide');
        return;
    }
    
    fetch(`/api/clients/${clientId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.client) {
                const client = data.client;
                
                // ✅ ÉTAPE CRITIQUE : Définir currentClientId AVANT showNewClientForm
                currentClientId = clientId;
                console.log('🔧 currentClientId défini à:', currentClientId);
                
                // ✅ Afficher le formulaire de modification
                showNewClientForm();
                
                // ✅ Changer le titre et sous-titre pour indiquer la modification
                document.querySelector('.form-title').textContent = 'Clients / Modifier client';
                document.querySelector('.form-subtitle').textContent = 'Modifiez les informations du client existant.';
                
                // ✅ Remplir les champs
                document.getElementById('nom').value = client.nom || '';
                document.getElementById('adresse').value = client.adresse || '';
                document.getElementById('ville').value = client.ville || '';
                document.getElementById('pays').value = client.pays || '';
                
                // ✅ Remplir les téléphones avec intl-tel-input
                // ✅ Remplir les téléphones avec intl-tel-input - GESTION INTELLIGENTE
                if (client.telephone) {
                    setTimeout(() => {
                        if (itiPhone) {
                            console.log('📱 Chargement téléphone principal:', client.telephone);
                            // intl-tel-input va automatiquement formater selon le pays détecté
                            itiPhone.setNumber(client.telephone);
                        } else {
                            document.getElementById('telephone').value = client.telephone;
                        }
                    }, 150); // ✅ Délai légèrement augmenté pour laisser charger intl-tel-input
                }

                if (client.telephone_secondaire) {
                    setTimeout(() => {
                        if (itiPhoneSecondary) {
                            console.log('📱 Chargement téléphone secondaire:', client.telephone_secondaire);
                            // intl-tel-input va automatiquement formater selon le pays détecté
                            itiPhoneSecondary.setNumber(client.telephone_secondaire);
                        } else {
                            document.getElementById('telephone_secondaire').value = client.telephone_secondaire;
                        }
                    }, 150); // ✅ Délai légèrement augmenté
                }
                
                console.log('✅ Formulaire de modification prêt pour client ID:', currentClientId);
                
            } else {
                alert('Client introuvable ou erreur lors du chargement');
            }
        })
        .catch(error => {
            console.error('❌ Erreur lors du chargement du client:', error);
            alert('Erreur lors du chargement du client: ' + error.message);
        });
}

function openDeleteModal(clientId) {
    console.log("openDeleteModal() - ID:", clientId);
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
    console.log(" confirmDelete() avec ID:", currentClientId);
    if (!currentClientId) {
        alert("Erreur: ID invalide");
        return;
    }
    fetch(`/api/clients/${currentClientId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            console.log("Réponse suppression:", data);
            if (data.success) {
                closeDeleteModal();
                showSuccessMessage(`Client "${currentClientName || 'inconnu'}" supprimé avec succès`);
                location.reload();
            } else {
                closeDeleteModal();
                // Afficher une notification stylisée au lieu d'un alert
                showSuccessMessage(`Impossible de supprimer "${currentClientName || 'ce client'}": Le client est lié à une proforma ou facture`);
            }
        })
        .catch(error => {
            console.error("Erreur réseau DELETE:", error);
            closeDeleteModal();
            showSuccessMessage(`Erreur réseau lors de la suppression de "${currentClientName || 'ce client'}"`);
        });
}

function viewHistory(clientId) {
    console.log("📜 Chargement historique pour client:", clientId);
    const modal = document.getElementById('historyModal');
    const content = document.getElementById('historyContent');
    modal.style.display = 'flex';
    content.innerHTML = `
        <div style="text-align:center; padding: 40px 20px;">
            <div style="color:#666; font-size: 16px;">Chargement de l'historique...</div>
        </div>
    `;

    fetch(`/api/clients/${clientId}/history`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                content.innerHTML = `<p style="color:red; text-align:center;">${data.message}</p>`;
                return;
            }

            if (data.history.length === 0) {
                content.innerHTML = `
                    <div style="text-align:center; padding: 40px 20px;">
                        <div style="color:#666; font-size: 16px; margin-bottom: 10px;">Aucune commande trouvée</div>
                        <div style="color:#999; font-size: 14px;">Ce client n'a pas encore de commandes enregistrées</div>
                    </div>
                `;
                return;
            }

            let html = `
                <table style="width:100%; border-collapse: collapse; font-size: 14px; table-layout: fixed;">
                    <thead>
                        <tr style="background:#f9f9f9; font-weight: 600;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:15%;">Date</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:18%;">Code</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:18%;">Montant</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; width:14%;">Statut</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Articles</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.history.forEach(item => {
                let articlesHtml = "<ul style='margin:0; padding-left:12px; list-style: disc;'>";
                if (item.articles && item.articles.length > 0) {
                    item.articles.forEach(a => {
                        articlesHtml += `<li style="margin:0 0 3px 0; font-size:13px;">${a.nom}</li>`;
                    });
                } else {
                    articlesHtml += `<li style="color:#666; font-style:italic;">Commande sans détail</li>`;
                }
                articlesHtml += "</ul>";

                // Normalisation du statut pour l'affichage
                let statusDisplay = item.status;
                if (item.status && item.status.toLowerCase().includes('termine')) {
                    statusDisplay = 'terminé';
                }

                html += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding: 12px; vertical-align: middle;">${item.date}</td>
                        <td style="padding: 12px; vertical-align: middle; font-family: monospace; font-weight: 500; white-space: nowrap;">${item.code}</td>
                        <td style="padding: 12px; text-align: left; vertical-align: middle; color: #2E7D32; font-weight: 600;"><span style="white-space: nowrap;">${item.montant}</span></td>
                        <td style="padding: 12px; text-align: left; vertical-align: middle;"><span style="background: #E8F5E8; color: #2E7D32; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; white-space: nowrap;">${statusDisplay}</span></td>
                        <td style="padding: 12px; vertical-align: middle;">${articlesHtml}</td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            content.innerHTML = html;
        })
        .catch(err => {
            content.innerHTML = `
                <div style="text-align:center; padding: 40px 20px;">
                    <div style="color:#d32f2f; font-size: 16px; margin-bottom: 10px;">Erreur lors du chargement</div>
                    <div style="color:#666; font-size: 14px;">Impossible de récupérer l'historique des commandes</div>
                </div>
            `;
            console.error('Erreur historique:', err);
        });
}

function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
}


// Fonction appelée depuis la modale principale
function viewHistoryFromModal() {
    console.log("📜 viewHistoryFromModal() - ID:", currentClientId);
    if (!currentClientId) {
        alert("Erreur: Aucun client sélectionné");
        return;
    }
    closeActionModal();
    viewHistory(currentClientId);
}


function closeModal() { 
    document.getElementById('confirmationModal').style.display = 'none'; 
    location.reload(); // Recharger pour voir le nouveau client
}

function closeModificationModal() {
    document.getElementById('modificationModal').style.display = 'none';
    showClientList(); // Retourner à la liste
    location.reload(); // Recharger pour voir les changements
}

function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }
function closeDuplicateModal() { document.getElementById('duplicateModal').style.display = 'none'; }

function editDuplicateClient() { 
    console.log('🔄 editDuplicateClient() - currentClientId avant:', currentClientId);
    closeDuplicateModal(); 
    
    // ✅ CORRECTION: Utiliser l'ID de la modal de doublon si disponible
    const clientIdToEdit = currentClientId || document.getElementById('duplicateModal').getAttribute('data-client-id');
    console.log('🔄 editDuplicateClient() - ID à éditer:', clientIdToEdit);
    
    if (clientIdToEdit) {
        editClient(clientIdToEdit);
    } else {
        alert('Erreur: Impossible de récupérer l\'ID du client');
    }
}

function exportClients() {
    console.log("📊 Exporting clients...");
    
    // Récupérer les filtres actuels
    const search = document.getElementById('searchInput').value;
    const ville = document.getElementById('filterCity').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (ville) params.append('ville', ville);
    
    const exportUrl = `/api/export/clients?${params}`;
    console.log("📊 Export URL:", exportUrl);
    
    // Ouvrir l'export dans un nouvel onglet
    window.open(exportUrl, '_blank');
}

// Fonction pour afficher les notifications de succès avec le même design que le dashboard
function showSuccessMessage(message) {
    // Supprimer les anciens toasts pour éviter l'accumulation
    document.querySelectorAll('.client-success-toast').forEach(oldToast => {
        if (oldToast.parentNode) {
            oldToast.remove();
        }
    });

    // Créer un nouveau toast de succès avec le dégradé vert
    const toast = document.createElement('div');
    toast.className = 'client-success-toast';
    toast.textContent = message;
    
    // Ajouter au DOM
    document.body.appendChild(toast);
    
    // Supprimer automatiquement après 3 secondes
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }
    }, 3000);
}
</script>
{% endblock %}